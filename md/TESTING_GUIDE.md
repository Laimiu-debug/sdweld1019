# 🧪 企业权限功能测试指南

## 📋 测试前准备

### 1. 确认数据库状态

运行测试脚本确认当前状态：

```bash
python backend/test_employee_permissions.py
```

**预期结果**：
- ✅ 员工账号有完整的设备管理权限（view, create, edit, delete）
- ✅ 所有企业设备的`access_level`都是`company`
- ✅ 员工的`data_access_scope`是`company`

### 2. 重启后端服务

```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

## 🧪 测试场景

### 测试账号

| 角色 | 邮箱 | 权限 |
|------|------|------|
| **企业所有者/管理员** | testuser176070001@example.com | 所有权限 |
| **员工（设备管理员）** | testuser176070004@example.com | 设备增删改查权限 |

---

## 场景1：测试员工的完整权限

### 1.1 登录员工账号

- 邮箱：testuser176070004@example.com
- 切换到企业工作区

### 1.2 测试查看权限

**操作**：打开设备列表

**预期结果**：
- ✅ 可以看到所有企业设备（包括管理员创建的）
- ✅ 应该看到至少6个设备

**实际结果**：
- [ ] 通过
- [ ] 失败（描述问题）：

### 1.3 测试创建权限

**操作**：创建一个新设备

**预期结果**：
- ✅ 创建成功
- ✅ 新设备出现在列表中

**实际结果**：
- [ ] 通过
- [ ] 失败（描述问题）：

### 1.4 测试编辑权限（编辑自己创建的设备）

**操作**：编辑刚才创建的设备

**预期结果**：
- ✅ 编辑成功
- ✅ 修改内容已保存

**实际结果**：
- [ ] 通过
- [ ] 失败（描述问题）：

### 1.5 测试编辑权限（编辑其他人创建的设备）

**操作**：编辑管理员创建的设备（如"112233"或"665588"）

**预期结果**：
- ✅ 编辑成功
- ✅ 修改内容已保存

**实际结果**：
- [ ] 通过
- [ ] 失败（描述问题）：

### 1.6 测试删除权限（删除自己创建的设备）

**操作**：删除刚才创建的设备

**预期结果**：
- ✅ 删除成功
- ✅ 设备从列表中消失

**实际结果**：
- [ ] 通过
- [ ] 失败（描述问题）：

### 1.7 测试删除权限（删除其他人创建的设备）

**操作**：删除管理员创建的设备（如"112233"）

**预期结果**：
- ✅ 删除成功
- ✅ 设备从列表中消失

**实际结果**：
- [ ] 通过
- [ ] 失败（描述问题）：

---

## 场景2：测试管理员权限

### 2.1 登录管理员账号

- 邮箱：testuser176070001@example.com
- 切换到企业工作区

### 2.2 测试查看权限

**操作**：打开设备列表

**预期结果**：
- ✅ 可以看到所有企业设备（包括员工创建的）

**实际结果**：
- [ ] 通过
- [ ] 失败（描述问题）：

### 2.3 测试编辑员工创建的设备

**操作**：编辑员工创建的设备（如"445566"或"3333333333"）

**预期结果**：
- ✅ 编辑成功
- ✅ 修改内容已保存

**实际结果**：
- [ ] 通过
- [ ] 失败（描述问题）：

### 2.4 测试删除员工创建的设备

**操作**：删除员工创建的设备

**预期结果**：
- ✅ 删除成功
- ✅ 设备从列表中消失

**实际结果**：
- [ ] 通过
- [ ] 失败（描述问题）：

---

## 场景3：测试权限限制

### 3.1 修改员工角色权限

**操作**：
1. 用管理员账号登录
2. 进入员工管理 → 角色管理
3. 编辑"设备管理员"角色
4. 只保留"查看"权限，取消"创建"、"编辑"、"删除"权限
5. 保存

### 3.2 测试员工只有查看权限

**操作**：
1. 登出管理员账号
2. 登录员工账号（testuser176070004@example.com）
3. 切换到企业工作区

**测试查看**：
- 预期：✅ 可以看到所有设备
- 实际：[ ] 通过 / [ ] 失败

**测试创建**：
- 预期：❌ 显示"没有创建设备的权限"（403错误）
- 实际：[ ] 通过 / [ ] 失败

**测试编辑**：
- 预期：❌ 显示"没有编辑权限"（403错误）
- 实际：[ ] 通过 / [ ] 失败

**测试删除**：
- 预期：❌ 显示"没有删除权限"（403错误）
- 实际：[ ] 通过 / [ ] 失败

---

## 场景4：测试data_access_scope

### 4.1 修改员工的数据访问范围

**操作**：
1. 用管理员账号登录
2. 进入员工管理
3. 编辑员工（testuser176070004@example.com）
4. 将"数据访问范围"从"company"改为"factory"
5. 保存

### 4.2 测试工厂级别访问

**操作**：
1. 登出管理员账号
2. 登录员工账号
3. 查看设备列表

**预期结果**：
- ✅ 只能看到所在工厂（工厂ID: 5）的设备
- ❌ 看不到其他工厂或没有工厂的设备

**实际结果**：
- [ ] 通过
- [ ] 失败（描述问题）：

---

## 🐛 问题排查

### 如果测试失败

1. **检查后端日志**：查看终端中的错误信息
2. **检查浏览器控制台**：查看前端错误信息
3. **运行测试脚本**：
   ```bash
   python backend/test_employee_permissions.py
   ```
4. **检查数据库状态**：
   ```bash
   python backend/test_permission_fix.py
   ```

### 常见问题

#### 问题1：员工看不到其他人创建的设备

**可能原因**：
- 设备的`access_level`还是`private`
- 员工的`data_access_scope`是`factory`但设备在不同工厂

**解决方案**：
```bash
# 重新运行迁移脚本
python backend/run_equipment_access_level_migration.py
```

#### 问题2：员工不能编辑/删除其他人创建的设备

**可能原因**：
- 角色权限配置不正确
- 设备的`access_level`是`private`

**解决方案**：
1. 检查角色权限配置
2. 运行迁移脚本更新访问级别

#### 问题3：403错误

**可能原因**：
- 权限检查逻辑有问题
- 角色权限配置不正确

**解决方案**：
1. 查看后端日志中的详细错误信息
2. 运行测试脚本检查权限配置

---

## ✅ 测试完成检查清单

- [ ] 员工可以查看所有企业设备
- [ ] 员工可以创建新设备
- [ ] 员工可以编辑自己创建的设备
- [ ] 员工可以编辑其他人创建的设备
- [ ] 员工可以删除自己创建的设备
- [ ] 员工可以删除其他人创建的设备
- [ ] 管理员可以查看所有设备
- [ ] 管理员可以编辑员工创建的设备
- [ ] 管理员可以删除员工创建的设备
- [ ] 权限限制正确生效（只有查看权限时不能创建/编辑/删除）
- [ ] data_access_scope正确生效（factory级别只能看到所在工厂的设备）

---

**如果所有测试都通过，恭喜！权限系统已经完全正常工作了！** 🎉

