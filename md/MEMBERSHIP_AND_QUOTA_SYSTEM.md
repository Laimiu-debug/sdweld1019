# ğŸ’ ä¼šå‘˜ä½“ç³»ä¸é…é¢ç®¡ç†ç³»ç»Ÿ

## ğŸ“‹ ç›®å½•

1. [ä¼šå‘˜ä½“ç³»æ¦‚è¿°](#ä¼šå‘˜ä½“ç³»æ¦‚è¿°)
2. [ä¼šå‘˜ç­‰çº§é…ç½®](#ä¼šå‘˜ç­‰çº§é…ç½®)
3. [é…é¢ç®¡ç†æœºåˆ¶](#é…é¢ç®¡ç†æœºåˆ¶)
4. [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
5. [æ–°æ¨¡å—é›†æˆæŒ‡å—](#æ–°æ¨¡å—é›†æˆæŒ‡å—)

---

## ğŸ¯ ä¼šå‘˜ä½“ç³»æ¦‚è¿°

### åŒè½¨ä¼šå‘˜åˆ¶

ç³»ç»Ÿé‡‡ç”¨**ä¸ªäººä¼šå‘˜**å’Œ**ä¼ä¸šä¼šå‘˜**åŒè½¨åˆ¶ï¼š

```
ç”¨æˆ·
â”œâ”€> ä¸ªäººå·¥ä½œåŒº
â”‚   â””â”€> ä½¿ç”¨ä¸ªäººä¼šå‘˜é…é¢ï¼ˆUser.membership_tierï¼‰
â”‚
â””â”€> ä¼ä¸šå·¥ä½œåŒº
    â””â”€> ä½¿ç”¨ä¼ä¸šä¼šå‘˜é…é¢ï¼ˆCompany.membership_tierï¼‰
```

**å…³é”®ç‰¹ç‚¹**ï¼š
- âœ… ä¸ªäººå’Œä¼ä¸šé…é¢**å®Œå…¨ç‹¬ç«‹**
- âœ… åŒä¸€ç”¨æˆ·åœ¨ä¸åŒå·¥ä½œåŒºä½¿ç”¨ä¸åŒé…é¢
- âœ… ç‰©ç†èµ„äº§æ¨¡å—**ä¸å—é…é¢é™åˆ¶**
- âœ… æ–‡æ¡£ç±»æ¨¡å—**å—é…é¢é™åˆ¶**

---

## ğŸ’ ä¼šå‘˜ç­‰çº§é…ç½®

### ä¸ªäººä¼šå‘˜ç­‰çº§

| ç­‰çº§ | ä»£ç  | ä»·æ ¼ | WPSé…é¢ | PQRé…é¢ | pPQRé…é¢ | ç‰©ç†èµ„äº§ | å¤šå·¥å‚æ•°é‡ |
|------|------|------|---------|---------|----------|----------|-----------|
| ä¸ªäººå…è´¹ç‰ˆ | `free` | å…è´¹ | 10ä¸ª | 10ä¸ª | 0ï¼ˆä¸æ”¯æŒï¼‰ | âˆ | - |
| ä¸ªäººä¸“ä¸šç‰ˆ | `personal_pro` | Â¥19/æœˆ | 30ä¸ª | 30ä¸ª | 30ä¸ª | âˆ | - |
| ä¸ªäººé«˜çº§ç‰ˆ | `personal_advanced` | Â¥49/æœˆ | 50ä¸ª | 50ä¸ª | 50ä¸ª | âˆ | - |
| ä¸ªäººæ——èˆ°ç‰ˆ | `personal_flagship` | Â¥99/æœˆ | 100ä¸ª | 100ä¸ª | 100ä¸ª | âˆ | - |

### ä¼ä¸šä¼šå‘˜ç­‰çº§

| ç­‰çº§ | ä»£ç  | ä»·æ ¼ | WPSé…é¢ | PQRé…é¢ | pPQRé…é¢ | ç‰©ç†èµ„äº§ | å¤šå·¥å‚æ•°é‡ |
|------|------|------|---------|---------|----------|----------|-----------|
| ä¼ä¸šç‰ˆ | `enterprise` | Â¥199/æœˆ | 200ä¸ª | 200ä¸ª | 200ä¸ª | âˆ | 10äºº |
| ä¼ä¸šç‰ˆPRO | `enterprise_pro` | Â¥399/æœˆ | 400ä¸ª | 400ä¸ª | 400ä¸ª | âˆ | 20äºº |
| ä¼ä¸šç‰ˆPRO MAX | `enterprise_pro_max` | Â¥899/æœˆ | 500ä¸ª | 500ä¸ª | 500ä¸ª | âˆ | 50äºº |

**æ³¨æ„**ï¼š
- âœ… ä¸ªäººå…è´¹ç‰ˆä¸æ”¯æŒpPQRåŠŸèƒ½
- âœ… ç‰©ç†èµ„äº§æ¨¡å—ï¼ˆè®¾å¤‡ã€ç„Šæã€ç„Šå·¥ã€ç”Ÿäº§ã€è´¨é‡ï¼‰æ‰€æœ‰ç­‰çº§éƒ½ä¸å—é™åˆ¶
- âœ… å¤šå·¥å‚æ•°é‡ä»…é€‚ç”¨äºä¼ä¸šç‰ˆ

**é…ç½®æ–‡ä»¶ä½ç½®**ï¼š
- `backend/app/core/config.py`
- `frontend/src/config/membership.ts`

---

## ğŸ“Š é…é¢ç®¡ç†æœºåˆ¶

### æ¨¡å—åˆ†ç±»

#### æ–‡æ¡£ç±»æ¨¡å—ï¼ˆå—é…é¢é™åˆ¶ï¼‰

```python
DOCUMENT_MODULES = {
    "wps",      # WPSç„Šæ¥å·¥è‰ºè§„ç¨‹
    "pqr",      # PQRå·¥è‰ºè¯„å®šè®°å½•
    "ppqr"      # pPQRé¢„å·¥è‰ºè¯„å®šè®°å½•
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… åˆ›å»ºæ—¶æ£€æŸ¥é…é¢
- âœ… åˆ›å»ºæˆåŠŸåå¢åŠ ä½¿ç”¨é‡
- âœ… åˆ é™¤åå‡å°‘ä½¿ç”¨é‡
- âœ… å—ä¼šå‘˜ç­‰çº§é™åˆ¶

#### ç‰©ç†èµ„äº§ç±»æ¨¡å—ï¼ˆä¸å—é…é¢é™åˆ¶ï¼‰

```python
PHYSICAL_ASSET_MODULES = {
    "equipment",   # è®¾å¤‡ç®¡ç†
    "materials",   # ç„Šæç®¡ç†
    "welders",     # ç„Šå·¥ç®¡ç†
    "production",  # ç”Ÿäº§ç®¡ç†
    "quality"      # è´¨é‡ç®¡ç†
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… åˆ›å»ºæ—¶**ä¸æ£€æŸ¥é…é¢**
- âœ… åˆ é™¤æ—¶**ä¸æ›´æ–°é…é¢**
- âœ… **ä¸å—ä¼šå‘˜ç­‰çº§é™åˆ¶**
- âœ… æ‰€æœ‰ä¼šå‘˜ç­‰çº§éƒ½å¯ä»¥æ— é™åˆ›å»º

### é…é¢æ£€æŸ¥æµç¨‹

```
åˆ›å»ºèµ„æº
    â†“
åˆ¤æ–­æ¨¡å—ç±»å‹
    â”œâ”€> ç‰©ç†èµ„äº§æ¨¡å— â†’ è·³è¿‡é…é¢æ£€æŸ¥ â†’ ç›´æ¥åˆ›å»º âœ…
    â”‚
    â””â”€> æ–‡æ¡£ç±»æ¨¡å—
        â†“
    åˆ¤æ–­å·¥ä½œåŒºç±»å‹
        â”œâ”€> ä¸ªäººå·¥ä½œåŒº
        â”‚   â”œâ”€> è·å–ç”¨æˆ·ä¼šå‘˜ç­‰çº§
        â”‚   â”œâ”€> è·å–é…é¢é™åˆ¶
        â”‚   â”œâ”€> è·å–å½“å‰ä½¿ç”¨é‡
        â”‚   â””â”€> åˆ¤æ–­æ˜¯å¦è¶…å‡ºé™åˆ¶
        â”‚       â”œâ”€> æœªè¶…å‡º â†’ åˆ›å»º âœ…
        â”‚       â””â”€> è¶…å‡º â†’ æç¤ºå‡çº§ä¼šå‘˜ âŒ
        â”‚
        â””â”€> ä¼ä¸šå·¥ä½œåŒº
            â”œâ”€> è·å–ä¼ä¸šä¼šå‘˜ç­‰çº§
            â”œâ”€> è·å–é…é¢é™åˆ¶
            â”œâ”€> è·å–å½“å‰ä½¿ç”¨é‡
            â””â”€> åˆ¤æ–­æ˜¯å¦è¶…å‡ºé™åˆ¶
                â”œâ”€> æœªè¶…å‡º â†’ åˆ›å»º âœ…
                â””â”€> è¶…å‡º â†’ æç¤ºå‡çº§ä¼šå‘˜ âŒ
```

---

## ğŸ”§ å®ç°ç»†èŠ‚

### æ•°æ®æ¨¡å‹

#### ç”¨æˆ·è¡¨ï¼ˆUserï¼‰

```python
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    email = Column(String(255), unique=True)
    
    # ============ ä¸ªäººä¼šå‘˜ä¿¡æ¯ ============
    membership_tier = Column(String(50), default="free", comment="ä¼šå‘˜ç­‰çº§")
    membership_expires_at = Column(DateTime, nullable=True, comment="ä¼šå‘˜åˆ°æœŸæ—¶é—´")
    
    # ============ ä¸ªäººå·¥ä½œåŒºé…é¢ä½¿ç”¨ç»Ÿè®¡ ============
    wps_usage = Column(Integer, default=0, comment="WPSä½¿ç”¨é‡")
    pqr_usage = Column(Integer, default=0, comment="PQRä½¿ç”¨é‡")
    ppqr_usage = Column(Integer, default=0, comment="pPQRä½¿ç”¨é‡")
    
    # æ³¨æ„ï¼šç‰©ç†èµ„äº§æ¨¡å—ä¸éœ€è¦usageå­—æ®µ
```

#### ä¼ä¸šè¡¨ï¼ˆCompanyï¼‰

```python
class Company(Base):
    __tablename__ = "companies"
    
    id = Column(Integer, primary_key=True)
    company_name = Column(String(200))
    owner_id = Column(Integer, ForeignKey("users.id"))
    
    # ============ ä¼ä¸šä¼šå‘˜ä¿¡æ¯ ============
    membership_tier = Column(String(50), default="enterprise", comment="ä¼šå‘˜ç­‰çº§")
    membership_expires_at = Column(DateTime, nullable=True, comment="ä¼šå‘˜åˆ°æœŸæ—¶é—´")
    
    # ============ ä¼ä¸šå·¥ä½œåŒºé…é¢ä½¿ç”¨ç»Ÿè®¡ ============
    wps_usage = Column(Integer, default=0, comment="WPSä½¿ç”¨é‡")
    pqr_usage = Column(Integer, default=0, comment="PQRä½¿ç”¨é‡")
    ppqr_usage = Column(Integer, default=0, comment="pPQRä½¿ç”¨é‡")
    
    # æ³¨æ„ï¼šç‰©ç†èµ„äº§æ¨¡å—ä¸éœ€è¦usageå­—æ®µ
```

### é…é¢æœåŠ¡ï¼ˆQuotaServiceï¼‰

#### é…é¢æ£€æŸ¥

```python
class QuotaService:
    def check_quota(
        self,
        user: User,
        workspace_context: WorkspaceContext,
        quota_type: str,
        increment: int = 1
    ):
        """
        æ£€æŸ¥é…é¢
        
        Args:
            user: å½“å‰ç”¨æˆ·
            workspace_context: å·¥ä½œåŒºä¸Šä¸‹æ–‡
            quota_type: é…é¢ç±»å‹ï¼ˆwps/pqr/ppqr/equipment/materialsç­‰ï¼‰
            increment: å¢é‡ï¼ˆé€šå¸¸ä¸º1ï¼‰
        
        Returns:
            True: é…é¢å……è¶³
        
        Raises:
            HTTPException: é…é¢ä¸è¶³
        """
        
        # 1. ç‰©ç†èµ„äº§æ¨¡å—ï¼šç›´æ¥è¿”å›True
        if quota_type in ["equipment", "materials", "welders", "production", "quality"]:
            return True
        
        # 2. æ–‡æ¡£ç±»æ¨¡å—ï¼šæ£€æŸ¥é…é¢
        if workspace_context.workspace_type == "personal":
            return self._check_personal_quota(user, quota_type, increment)
        elif workspace_context.workspace_type == "enterprise":
            return self._check_enterprise_quota(
                workspace_context.company_id, quota_type, increment
            )
    
    def _check_personal_quota(self, user: User, quota_type: str, increment: int):
        """æ£€æŸ¥ä¸ªäººå·¥ä½œåŒºé…é¢"""
        # è·å–ä¼šå‘˜ç­‰çº§é…ç½®
        tier = user.membership_tier or "free"
        tier_config = PERSONAL_TIERS.get(tier, PERSONAL_TIERS["free"])
        
        # è·å–é…é¢é™åˆ¶
        quota_limit = tier_config.get(f"{quota_type}_quota", 0)
        
        # -1è¡¨ç¤ºæ— é™é…é¢
        if quota_limit == -1:
            return True
        
        # è·å–å½“å‰ä½¿ç”¨é‡
        current_usage = getattr(user, f"{quota_type}_usage", 0)
        
        # æ£€æŸ¥æ˜¯å¦è¶…å‡ºé™åˆ¶
        if current_usage + increment > quota_limit:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"é…é¢ä¸è¶³ï¼šæ‚¨çš„{tier_config['name']}é…é¢å·²ç”¨å®Œï¼ˆ{current_usage}/{quota_limit}ï¼‰ï¼Œè¯·å‡çº§ä¼šå‘˜"
            )
        
        return True
    
    def _check_enterprise_quota(self, company_id: int, quota_type: str, increment: int):
        """æ£€æŸ¥ä¼ä¸šå·¥ä½œåŒºé…é¢"""
        company = self.db.query(Company).filter(Company.id == company_id).first()

        if not company:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="ä¼ä¸šä¸å­˜åœ¨"
            )

        # è·å–ä¼šå‘˜ç­‰çº§é…ç½®
        tier = company.membership_tier or "enterprise"
        tier_config = ENTERPRISE_TIERS.get(tier, ENTERPRISE_TIERS["enterprise"])
        
        # è·å–é…é¢é™åˆ¶
        quota_limit = tier_config.get(f"{quota_type}_quota", 0)
        
        # -1è¡¨ç¤ºæ— é™é…é¢
        if quota_limit == -1:
            return True
        
        # è·å–å½“å‰ä½¿ç”¨é‡
        current_usage = getattr(company, f"{quota_type}_usage", 0)
        
        # æ£€æŸ¥æ˜¯å¦è¶…å‡ºé™åˆ¶
        if current_usage + increment > quota_limit:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"é…é¢ä¸è¶³ï¼šä¼ä¸šçš„{tier_config['name']}é…é¢å·²ç”¨å®Œï¼ˆ{current_usage}/{quota_limit}ï¼‰ï¼Œè¯·å‡çº§ä¼šå‘˜"
            )
        
        return True
```

#### é…é¢æ›´æ–°

```python
def update_quota_usage(
    self,
    user: User,
    workspace_context: WorkspaceContext,
    quota_type: str,
    increment: int = 1
):
    """
    æ›´æ–°é…é¢ä½¿ç”¨é‡
    
    Args:
        user: å½“å‰ç”¨æˆ·
        workspace_context: å·¥ä½œåŒºä¸Šä¸‹æ–‡
        quota_type: é…é¢ç±»å‹
        increment: å¢é‡ï¼ˆæ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=å‡å°‘ï¼‰
    """
    
    # 1. ç‰©ç†èµ„äº§æ¨¡å—ï¼šç›´æ¥è¿”å›
    if quota_type in ["equipment", "materials", "welders", "production", "quality"]:
        return
    
    # 2. æ–‡æ¡£ç±»æ¨¡å—ï¼šæ›´æ–°é…é¢
    if workspace_context.workspace_type == "personal":
        self._update_personal_quota(user, quota_type, increment)
    elif workspace_context.workspace_type == "enterprise":
        self._update_enterprise_quota(
            workspace_context.company_id, quota_type, increment
        )

def _update_personal_quota(self, user: User, quota_type: str, increment: int):
    """æ›´æ–°ä¸ªäººå·¥ä½œåŒºé…é¢"""
    current_usage = getattr(user, f"{quota_type}_usage", 0)
    new_usage = max(0, current_usage + increment)  # ä¸èƒ½å°äº0
    setattr(user, f"{quota_type}_usage", new_usage)
    self.db.commit()

def _update_enterprise_quota(self, company_id: int, quota_type: str, increment: int):
    """æ›´æ–°ä¼ä¸šå·¥ä½œåŒºé…é¢"""
    company = self.db.query(Company).filter(Company.id == company_id).first()
    
    if company:
        current_usage = getattr(company, f"{quota_type}_usage", 0)
        new_usage = max(0, current_usage + increment)
        setattr(company, f"{quota_type}_usage", new_usage)
        self.db.commit()
```

---

## ğŸš€ æ–°æ¨¡å—é›†æˆæŒ‡å—

### æ–‡æ¡£ç±»æ¨¡å—ï¼ˆéœ€è¦é…é¢ç®¡ç†ï¼‰

#### ç¤ºä¾‹ï¼šWPSæ¨¡å—

```python
class WPSService:
    def __init__(self, db: Session):
        self.db = db
        self.quota_service = QuotaService(db)
    
    def create_wps(self, current_user: User, wps_data: Dict, 
                   workspace_context: WorkspaceContext):
        # 1. æ£€æŸ¥é…é¢
        self.quota_service.check_quota(
            current_user, workspace_context, "wps", 1
        )
        
        # 2. åˆ›å»ºWPS
        wps = WPS(**wps_data)
        self.db.add(wps)
        self.db.commit()
        
        # 3. æ›´æ–°é…é¢ä½¿ç”¨ï¼ˆåˆ›å»ºæˆåŠŸåï¼‰
        self.quota_service.update_quota_usage(
            current_user, workspace_context, "wps", 1
        )
        
        return wps
    
    def delete_wps(self, wps_id: int, current_user: User,
                   workspace_context: WorkspaceContext):
        # 1. åˆ é™¤WPS
        wps = self.get_wps_by_id(wps_id, current_user, workspace_context)
        wps.is_active = False
        self.db.commit()
        
        # 2. æ›´æ–°é…é¢ä½¿ç”¨ï¼ˆå‡å°‘ï¼‰
        self.quota_service.update_quota_usage(
            current_user, workspace_context, "wps", -1
        )
        
        return True
```

### ç‰©ç†èµ„äº§ç±»æ¨¡å—ï¼ˆä¸éœ€è¦é…é¢ç®¡ç†ï¼‰

#### ç¤ºä¾‹ï¼šç„Šææ¨¡å—

```python
class MaterialService:
    def __init__(self, db: Session):
        self.db = db
        self.quota_service = QuotaService(db)  # ä»ç„¶éœ€è¦åˆå§‹åŒ–
    
    def create_material(self, current_user: User, material_data: Dict,
                        workspace_context: WorkspaceContext):
        # 1. æ£€æŸ¥é…é¢ï¼ˆç‰©ç†èµ„äº§æ¨¡å—ä¼šè‡ªåŠ¨è·³è¿‡ï¼‰
        self.quota_service.check_quota(
            current_user, workspace_context, "materials", 1
        )
        
        # 2. åˆ›å»ºç„Šæ
        material = Material(**material_data)
        self.db.add(material)
        self.db.commit()
        
        # 3. æ›´æ–°é…é¢ä½¿ç”¨ï¼ˆç‰©ç†èµ„äº§æ¨¡å—ä¼šè‡ªåŠ¨è·³è¿‡ï¼‰
        self.quota_service.update_quota_usage(
            current_user, workspace_context, "materials", 1
        )
        
        return material
    
    def delete_material(self, material_id: int, current_user: User,
                        workspace_context: WorkspaceContext):
        # 1. åˆ é™¤ç„Šæ
        material = self.get_material_by_id(material_id, current_user, workspace_context)
        material.is_active = False
        self.db.commit()
        
        # 2. æ›´æ–°é…é¢ä½¿ç”¨ï¼ˆç‰©ç†èµ„äº§æ¨¡å—ä¼šè‡ªåŠ¨è·³è¿‡ï¼‰
        self.quota_service.update_quota_usage(
            current_user, workspace_context, "materials", -1
        )
        
        return True
```

**å…³é”®ç‚¹**ï¼š
- âœ… ç‰©ç†èµ„äº§æ¨¡å—**ä»ç„¶è°ƒç”¨**é…é¢æ£€æŸ¥å’Œæ›´æ–°æ–¹æ³•
- âœ… QuotaServiceå†…éƒ¨ä¼š**è‡ªåŠ¨åˆ¤æ–­**æ¨¡å—ç±»å‹å¹¶è·³è¿‡
- âœ… è¿™æ ·ä¿æŒäº†ä»£ç çš„**ä¸€è‡´æ€§**å’Œ**å¯ç»´æŠ¤æ€§**

---

## âœ… å®æ–½æ£€æŸ¥æ¸…å•

### æ–°å¢æ–‡æ¡£ç±»æ¨¡å—

- [ ] åœ¨`DOCUMENT_MODULES`ä¸­æ·»åŠ æ¨¡å—åç§°
- [ ] åœ¨`User`è¡¨ä¸­æ·»åŠ `{module}_usage`å­—æ®µ
- [ ] åœ¨`Company`è¡¨ä¸­æ·»åŠ `{module}_usage`å­—æ®µ
- [ ] åœ¨`PERSONAL_TIERS`ä¸­é…ç½®å„ç­‰çº§é…é¢
- [ ] åœ¨`ENTERPRISE_TIERS`ä¸­é…ç½®å„ç­‰çº§é…é¢
- [ ] åœ¨åˆ›å»ºæ–¹æ³•ä¸­è°ƒç”¨`check_quota()`
- [ ] åœ¨åˆ›å»ºæˆåŠŸåè°ƒç”¨`update_quota_usage(+1)`
- [ ] åœ¨åˆ é™¤æ–¹æ³•ä¸­è°ƒç”¨`update_quota_usage(-1)`
- [ ] æµ‹è¯•é…é¢é™åˆ¶åŠŸèƒ½
- [ ] æµ‹è¯•é…é¢ä½¿ç”¨ç»Ÿè®¡

### æ–°å¢ç‰©ç†èµ„äº§ç±»æ¨¡å—

- [ ] åœ¨`PHYSICAL_ASSET_MODULES`ä¸­æ·»åŠ æ¨¡å—åç§°
- [ ] **ä¸éœ€è¦**åœ¨`User`è¡¨ä¸­æ·»åŠ usageå­—æ®µ
- [ ] **ä¸éœ€è¦**åœ¨`Company`è¡¨ä¸­æ·»åŠ usageå­—æ®µ
- [ ] **ä¸éœ€è¦**é…ç½®é…é¢é™åˆ¶
- [ ] åœ¨åˆ›å»ºæ–¹æ³•ä¸­è°ƒç”¨`check_quota()`ï¼ˆä¼šè‡ªåŠ¨è·³è¿‡ï¼‰
- [ ] åœ¨åˆ é™¤æ–¹æ³•ä¸­è°ƒç”¨`update_quota_usage()`ï¼ˆä¼šè‡ªåŠ¨è·³è¿‡ï¼‰
- [ ] æµ‹è¯•å¯ä»¥æ— é™åˆ›å»º

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒåŸåˆ™

1. **åŒè½¨ä¼šå‘˜åˆ¶**ï¼šä¸ªäººå’Œä¼ä¸šé…é¢å®Œå…¨ç‹¬ç«‹
2. **æ¨¡å—åˆ†ç±»**ï¼šæ–‡æ¡£ç±»å—é™ï¼Œç‰©ç†èµ„äº§ä¸å—é™
3. **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰æ¨¡å—éƒ½è°ƒç”¨ç›¸åŒçš„é…é¢æ–¹æ³•
4. **è‡ªåŠ¨åˆ¤æ–­**ï¼šQuotaServiceå†…éƒ¨è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥

### ä¼˜åŠ¿

1. âœ… **ä»£ç ä¸€è‡´æ€§**ï¼šæ‰€æœ‰æ¨¡å—ä½¿ç”¨ç›¸åŒçš„é…é¢ç®¡ç†ä»£ç 
2. âœ… **æ˜“äºç»´æŠ¤**ï¼šæ–°å¢æ¨¡å—åªéœ€æ·»åŠ åˆ°å¯¹åº”åˆ†ç±»
3. âœ… **çµæ´»é…ç½®**ï¼šå¯ä»¥è½»æ¾è°ƒæ•´å„ç­‰çº§çš„é…é¢é™åˆ¶
4. âœ… **ç”¨æˆ·å‹å¥½**ï¼šç‰©ç†èµ„äº§æ¨¡å—ä¸å—é™åˆ¶ï¼Œé™ä½ä½¿ç”¨é—¨æ§›

### æ³¨æ„äº‹é¡¹

1. âš ï¸ ç‰©ç†èµ„äº§æ¨¡å—**ä»ç„¶éœ€è¦è°ƒç”¨**é…é¢æ–¹æ³•ï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
2. âš ï¸ é…é¢ç±»å‹åç§°å¿…é¡»ä¸æ¨¡å—åç§°**å®Œå…¨ä¸€è‡´**
3. âš ï¸ åˆ é™¤æ“ä½œå¿…é¡»è°ƒç”¨`update_quota_usage(-1)`æ¥é‡Šæ”¾é…é¢
4. âš ï¸ é…é¢æ£€æŸ¥åº”è¯¥åœ¨**æƒé™æ£€æŸ¥ä¹‹å**ï¼Œé¿å…æµªè´¹æ£€æŸ¥

---

**é€šè¿‡è¿™å¥—ä¼šå‘˜ä½“ç³»å’Œé…é¢ç®¡ç†ç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥çµæ´»åœ°æ§åˆ¶ä¸åŒæ¨¡å—çš„ä½¿ç”¨é™åˆ¶ï¼ŒåŒæ—¶ä¿æŒä»£ç çš„ç®€æ´å’Œä¸€è‡´æ€§ï¼** ğŸš€

