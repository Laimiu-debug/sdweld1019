# 焊层字段顺序优化总结

## 问题描述

用户反馈焊层表单中的字段显示顺序不符合焊接工艺逻辑，例如"倾斜角度"出现在第一位，导致填写表单时体验不佳。

## 解决方案

重新组织焊层字段的显示顺序，按照焊接工艺的实际流程排列：

### 新的字段顺序逻辑

```
1. 基本信息
   - 焊接工艺
   - 焊接方法类型
   - 焊接道次
   - 焊道id
   - 熔覆金属坡口焊缝厚度

2. 填充金属信息
   - 填充金属型号
   - 填充金属直径
   - 填充金属制造商
   - 填充金属商标名

3. 电极处理（仅适用于需要的工艺）
   - 电极二次烘干温度
   - 电极二次烘干时间

4. 保护气体信息（仅适用于需要的工艺）
   - 背部保护气名称
   - 背部保护气流量
   - 背部保护气预送气时间
   - 背部保护气延迟送气时间
   - 背部保护气商标名
   - 背部保护气制造商

5. 电流电压参数
   - 电流种类与极性
   - 电流脉冲（TIG焊等）
   - 电流
   - 焊接电压

6. 焊接速度和运动参数
   - 材料过渡（TIG焊等）
   - 送丝速度（TIG焊等）
   - 焊接速度
   - 倾斜角度
   - 焊嘴间距（TIG焊等）

7. 抖动参数
   - 抖动宽度
   - 抖动频率
   - 抖动停留时间

8. 设备信息
   - 焊接设备制造商
   - 焊接设备名称

9. 热输入
   - 热输入（系统计算）
   - 热输入（用户输入）
```

## 修改的文件

### 1. 模板定义文件
- `backend/migrations/insert_system_templates.sql`
  - 更新了111模板（手工电弧焊）的字段顺序
  - 更新了114模板（TIG焊）的字段顺序

### 2. 数据库更新脚本
- `backend/migrations/update_weld_layers_field_order.sql` - SQL脚本（未使用）
- `backend/update_field_order.py` - Python脚本（已执行）

## 执行结果

### 更新的模板

1. **手工电弧焊（SMAW）标准模板 (111)**
   - ✅ 字段顺序已更新
   - ✅ 共30个字段按新顺序排列

2. **无保护气的药芯焊（FCAW）标准模板 (114)**
   - ✅ 字段顺序已更新
   - ✅ 共29个字段按新顺序排列

### 字段顺序对比

#### 之前的顺序（不合理）
```
1. 倾斜角度 ❌ (应该在后面)
2. 焊接速度
3. 焊接电压
4. 电流
5. ...
```

#### 现在的顺序（合理）
```
1. 焊接工艺 ✅
2. 焊接方法类型 ✅
3. 焊接道次 ✅
4. 焊道id ✅
5. 熔覆金属坡口焊缝厚度 ✅
6. 填充金属型号 ✅
7. 填充金属直径 ✅
...
21. 焊接速度 ✅
22. 倾斜角度 ✅ (现在在合理的位置)
...
```

## 技术细节

### 数据库操作

使用PostgreSQL的`jsonb_set`函数更新JSONB字段中的嵌套数据：

```python
UPDATE wps_templates
SET field_schema = jsonb_set(
    field_schema,
    '{tabs,3,fields}',
    CAST(:new_fields AS jsonb)
)
WHERE welding_process = '111' AND standard = 'EN ISO 15609-1'
```

### 字段路径
- `field_schema` - 根JSONB字段
- `tabs` - 标签页数组
- `3` - 第4个标签页（焊层，索引从0开始）
- `fields` - 字段定义对象

## 用户体验改进

### 改进前
- ❌ 字段顺序混乱，不符合填写逻辑
- ❌ 重要的基本信息被次要参数分隔
- ❌ 倾斜角度等次要参数出现在最前面

### 改进后
- ✅ 字段按照焊接工艺流程排列
- ✅ 相关字段分组显示
- ✅ 基本信息在前，次要参数在后
- ✅ 填写流程更加自然流畅

## 影响范围

### 已更新的模板
- ✅ 111 - 手工电弧焊（SMAW）
- ✅ 114 - 无保护气的药芯焊（FCAW）

### 待更新的模板（如果需要）
- 121 - MIG/MAG焊
- 135 - 有保护气的药芯焊
- 141 - TIG焊
- 15 - 等离子焊
- 311 - 气焊

**注意**：其他模板的字段顺序需要根据各自的工艺特点单独调整。

## 验证方法

1. 访问WPS创建页面
2. 选择焊接工艺111或114
3. 选择对应的模板
4. 进入"焊层"标签页
5. 检查字段显示顺序是否符合逻辑

## 后续建议

1. **用户反馈收集**
   - 收集用户对新字段顺序的反馈
   - 根据实际使用情况进一步优化

2. **其他模板优化**
   - 根据需要更新其他焊接工艺模板的字段顺序
   - 保持各模板之间的一致性

3. **文档更新**
   - 更新用户手册中的字段说明
   - 添加字段填写指南

4. **模板设计器**
   - 在模板设计器中添加字段排序功能
   - 允许用户自定义字段顺序

## 总结

通过重新组织焊层字段的显示顺序，使表单填写流程更符合焊接工艺的实际操作逻辑，提升了用户体验。字段现在按照"基本信息 → 材料信息 → 工艺参数 → 设备信息 → 计算结果"的顺序排列，更加直观和易用。

---

**更新时间**: 2025-10-22  
**更新人**: AI Assistant  
**影响版本**: v1.0.0+

