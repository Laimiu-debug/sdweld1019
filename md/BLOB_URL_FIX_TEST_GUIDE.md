# Blob URL 失效问题修复 - 测试指南

## 问题概述

在 WPS 编辑页面加载时，出现以下错误：
```
[WPSEdit] 图片 0 包含失效的 blob URL，已跳过
[WPSEdit] 字段 xxx_generated_diagram 的所有图片数据已损坏，请重新生成或上传图片
```

**根本原因**：Blob URL 只在创建它的浏览器会话中有效，页面刷新后会失效。

## 修复内容

### 修复的组件
1. **WeldJointDiagramV4Field.tsx** - 焊接接头示意图 V4 生成器
2. **DiagramField.tsx** - 通用图表字段（坡口图、焊层焊道图）
3. **WeldJointDiagramField.tsx** - 焊接接头示意图生成器
4. **WPSEdit.tsx** - 增强了 blob URL 检测和过滤

### 修复方式
- 移除不必要的 blob 转换步骤
- 直接使用 `canvas.toDataURL('image/png')` 生成的 base64 URL
- 不保存 `originFileObj`，避免序列化问题

## 测试步骤

### 测试 1：焊接接头示意图 V4 生成和保存

**步骤**：
1. 打开 WPS 编辑页面
2. 找到"焊接接头示意图"字段
3. 点击"自动生成"按钮
4. 在生成器中调整参数（如坡口类型、角度等）
5. 点击"生成"按钮
6. 验证图片显示正确
7. 点击"保存"按钮保存 WPS

**预期结果**：
- ✅ 图片成功生成并显示
- ✅ 保存成功，无错误信息
- ✅ 浏览器控制台显示：`[WeldJointDiagramV4Field] 生成图表成功: {name: ..., urlType: 'base64', urlLength: ...}`

### 测试 2：页面刷新后图片仍然有效

**步骤**：
1. 完成测试 1 的保存
2. 刷新页面（F5 或 Ctrl+R）
3. 重新打开同一个 WPS 编辑页面
4. 检查焊接接头示意图字段

**预期结果**：
- ✅ 图片正常加载，无 blob URL 失效警告
- ✅ 浏览器控制台不显示以下错误：
  - `[WPSEdit] 图片 0 包含失效的 blob URL，已跳过`
  - `[WPSEdit] 字段 xxx 的所有图片数据已损坏`
- ✅ 图片能正确显示在预览区域

### 测试 3：坡口图生成和保存

**步骤**：
1. 打开 WPS 编辑页面
2. 找到"坡口图"字段
3. 点击"自动生成"按钮
4. 在生成器中调整参数
5. 点击"生成"按钮
6. 验证图片显示正确
7. 点击"保存"按钮

**预期结果**：
- ✅ 图片成功生成并显示
- ✅ 保存成功
- ✅ 浏览器控制台显示：`[DiagramField] 生成图表成功: {name: ..., urlType: 'base64', urlLength: ...}`

### 测试 4：焊层焊道图生成和保存

**步骤**：
1. 打开 WPS 编辑页面
2. 找到"焊层焊道图"字段
3. 点击"自动生成"按钮
4. 在生成器中调整参数
5. 点击"生成"按钮
6. 验证图片显示正确
7. 点击"保存"按钮

**预期结果**：
- ✅ 图片成功生成并显示
- ✅ 保存成功
- ✅ 浏览器控制台显示：`[DiagramField] 生成图表成功: {name: ..., urlType: 'base64', urlLength: ...}`

### 测试 5：图片上传功能

**步骤**：
1. 打开 WPS 编辑页面
2. 找到任何图片字段
3. 点击"上传图片"按钮
4. 选择本地图片文件
5. 验证图片显示正确
6. 点击"保存"按钮

**预期结果**：
- ✅ 图片成功上传并显示
- ✅ 保存成功
- ✅ 刷新页面后图片仍然显示

### 测试 6：文档导出功能

**步骤**：
1. 完成测试 1-5 中的任何一个
2. 切换到"文档编辑"模式
3. 点击"导出为 Word"按钮
4. 验证 Word 文档下载成功
5. 打开 Word 文档检查图片

**预期结果**：
- ✅ Word 文档成功生成并下载
- ✅ Word 文档中的图片正常显示
- ✅ 没有图片加载失败的占位符

## 浏览器控制台日志检查

### 正常日志（应该看到）
```
[WeldJointDiagramV4Field] 生成图表成功: {name: 'weld_joint_v4_1761810209324.png', urlType: 'base64', urlLength: 12345}
[WPSEdit] 字段 xxx_generated_diagram 有效图片数量: 1 / 1
[WPSEdit] 图片 0 已是正确格式: weld_joint_v4_1761810209324.png
```

### 错误日志（不应该看到）
```
[WPSEdit] 图片 0 包含失效的 blob URL，已跳过: weld_joint_v4_1761810209324.png blob:http://localhost:3000/...
[WPSEdit] 字段 xxx_generated_diagram 的所有图片数据已损坏，请重新生成或上传图片
```

## 回归测试

### 检查其他功能是否受影响
- [ ] PQR 编辑页面的图片功能正常
- [ ] pPQR 编辑页面的图片功能正常
- [ ] 文档编辑器中的图片显示正常
- [ ] 图片预览功能正常
- [ ] 图片删除功能正常

## 性能检查

- [ ] 页面加载速度没有明显变化
- [ ] 图片生成速度没有明显变化
- [ ] 内存使用没有明显增加

## 完成标准

所有测试都通过，且：
- ✅ 没有 blob URL 失效的错误信息
- ✅ 图片能正确保存和恢复
- ✅ 页面刷新后图片仍然有效
- ✅ 文档导出功能正常
- ✅ 没有性能下降

