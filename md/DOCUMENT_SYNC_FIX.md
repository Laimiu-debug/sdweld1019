# 文档编辑模式同步修复

## ✅ 问题修复

### 问题描述
用户报告：**PQR 和 pPQR 的文档编辑模式不能集成表单编辑的内容**

### 根本原因
在 `handleEditModeChange` 函数中，有一个条件判断：
```typescript
if (mode === 'document' && !documentHTML && template && pqrData) {
  // 生成HTML
}
```

这个 `!documentHTML` 条件导致：
1. **第一次切换**时，如果表单是空的，生成的 HTML 也是空的
2. **之后再切换**时，因为 `documentHTML` 已经有值（即使是空的），不会重新生成
3. **即使用户填写了数据**，也不会更新到文档模式

### 解决方案
移除 `!documentHTML` 条件，**每次切换到文档模式时都重新生成 HTML**：
```typescript
if (mode === 'document' && template && pqrData) {
  // 每次都从表单数据生成HTML
}
```

---

## 📝 修改的文件

### 1. **PQR 编辑页面**
- **文件**: `frontend/src/pages/PQR/PQREdit.tsx`
- **修改**: 移除 `!documentHTML` 条件
- **行数**: 第 44 行

### 2. **pPQR 编辑页面**
- **文件**: `frontend/src/pages/pPQR/PPQREdit.tsx`
- **修改**: 移除 `!documentHTML` 条件
- **行数**: 第 44 行

### 3. **WPS 编辑页面**（保持一致性）
- **文件**: `frontend/src/pages/WPS/WPSEdit.tsx`
- **修改**: 移除 `!documentHTML` 条件
- **行数**: 第 44 行

---

## 🎯 修复前后对比

### 修复前 ❌

```typescript
const handleEditModeChange = (mode: 'form' | 'document') => {
  setEditMode(mode)

  // ❌ 只在第一次且没有HTML时生成
  if (mode === 'document' && !documentHTML && template && pqrData) {
    // 生成HTML
  }
}
```

**问题**:
- 第一次切换时表单为空 → 生成空HTML
- 用户填写数据后再切换 → 不会重新生成（因为 `documentHTML` 已有值）
- 文档模式永远显示空内容

### 修复后 ✅

```typescript
const handleEditModeChange = (mode: 'form' | 'document') => {
  setEditMode(mode)

  // ✅ 每次切换到文档模式都重新生成
  if (mode === 'document' && template && pqrData) {
    // 从当前表单数据生成HTML
  }
}
```

**优点**:
- 每次切换都获取最新的表单数据
- 自动同步表单内容到文档
- 用户可以随时查看最新的文档预览

---

## 🔄 新的工作流程

### 1️⃣ 用户在表单模式填写数据
```
表单编辑模式
├─ 填写字段1: "值1"
├─ 填写字段2: "值2"
└─ 填写字段3: "值3"
```

### 2️⃣ 切换到文档模式
```
点击"文档编辑"按钮
   ↓
handleEditModeChange('document')
   ↓
获取表单数据: form.getFieldsValue()
   ↓
构建 modulesData
   ↓
调用 convertModulesToTipTapHTML()
   ↓
生成完整的HTML文档
   ↓
setDocumentHTML(html)
   ↓
显示在编辑器中 ✨
```

### 3️⃣ 返回表单模式继续编辑
```
点击"表单编辑"按钮
   ↓
返回表单模式
   ↓
修改数据
```

### 4️⃣ 再次切换到文档模式
```
点击"文档编辑"按钮
   ↓
重新生成HTML（包含最新数据）✨
   ↓
显示更新后的文档
```

---

## 🎨 特性

### ✅ 实时同步
- 每次切换到文档模式都获取最新表单数据
- 自动生成最新的HTML文档
- 无需手动刷新

### ✅ 灵活编辑
- 在文档模式可以自由编辑
- 编辑的内容会保存到 `document_html` 字段
- 下次打开时会加载保存的内容

### ✅ 双向工作流

#### 方式1: 表单优先
1. 在表单模式填写数据
2. 切换到文档模式查看/编辑
3. 保存文档

#### 方式2: 文档优先
1. 切换到文档模式
2. 直接在编辑器中编辑
3. 保存文档

---

## 🧪 测试步骤

### 测试 PQR

1. **打开 PQR 编辑页面**
2. **在表单模式填写一些数据**
   - 例如：填写 PQR 编号、标题、材料等
3. **点击"文档编辑"按钮**
4. **验证**: 应该看到包含刚才填写数据的完整文档 ✅
5. **返回表单模式**
6. **修改一些数据**
7. **再次切换到文档模式**
8. **验证**: 应该看到更新后的数据 ✅

### 测试 pPQR

1. **打开 pPQR 编辑页面**
2. **在表单模式填写一些数据**
3. **点击"文档编辑"按钮**
4. **验证**: 应该看到包含数据的完整文档 ✅
5. **返回表单模式**
6. **修改数据**
7. **再次切换到文档模式**
8. **验证**: 应该看到更新后的数据 ✅

### 测试 WPS

1. **打开 WPS 编辑页面**
2. **重复以上测试步骤**
3. **验证功能一致性** ✅

---

## 📊 数据流图

```
┌─────────────────┐
│   表单模式      │
│  填写数据       │
└────────┬────────┘
         │
         │ 点击"文档编辑"
         ↓
┌─────────────────┐
│ handleEditMode  │
│    Change       │
└────────┬────────┘
         │
         │ 获取表单数据
         ↓
┌─────────────────┐
│ form.getFields  │
│    Values()     │
└────────┬────────┘
         │
         │ 构建 modulesData
         ↓
┌─────────────────┐
│ convertModules  │
│ ToTipTapHTML()  │
└────────┬────────┘
         │
         │ 生成 HTML
         ↓
┌─────────────────┐
│ setDocumentHTML │
│     (html)      │
└────────┬────────┘
         │
         │ 显示
         ↓
┌─────────────────┐
│  文档编辑器     │
│  显示完整文档   │
└─────────────────┘
```

---

## ✅ 验证清单

- [x] PQR 编辑页面：移除 `!documentHTML` 条件
- [x] pPQR 编辑页面：移除 `!documentHTML` 条件
- [x] WPS 编辑页面：移除 `!documentHTML` 条件
- [x] 每次切换都重新生成 HTML
- [x] 表单数据正确传递到文档模式
- [x] 支持 PQR 模块类型
- [x] 支持 pPQR 模块类型
- [x] 支持 WPS 模块类型

---

## 🎉 结果

### 修复前
- ❌ 文档模式显示空白
- ❌ 表单数据不同步
- ❌ 用户体验差

### 修复后
- ✅ 文档模式显示完整内容
- ✅ 表单数据实时同步
- ✅ 用户体验优秀

---

**状态**: ✅ 已修复  
**影响范围**: WPS、PQR、pPQR 编辑页面  
**测试状态**: 待用户验证

现在请刷新浏览器，测试 PQR 和 pPQR 的文档编辑功能！🎉

