# 审批按钮功能测试指南

## 快速测试步骤

### 准备工作
1. ✅ 确保后端服务器正在运行
2. ✅ 确保前端开发服务器正在运行
3. ✅ 已登录系统
4. ✅ 在企业工作区中
5. ✅ 已创建pPQR审批工作流

### 测试1: 重新提交按钮显示

#### 步骤：
1. 打开PQR列表页面
2. 找到一个已被拒绝的PQR（状态显示"已拒绝"）
3. 查看操作按钮区域

#### 预期结果：
✅ 应该显示"重新提交"按钮（而不是"提交审批"）
✅ 按钮图标是发送图标（SendOutlined）
✅ 按钮颜色是主色调（蓝色）

#### 对比：
- ❌ 修复前：显示"提交审批"
- ✅ 修复后：显示"重新提交"

---

### 测试2: 被拒绝后可以取消审批

#### 步骤：
1. 打开PQR列表页面
2. 找到一个已被拒绝的PQR
3. 查看操作按钮区域

#### 预期结果：
✅ 应该同时显示"重新提交"和"取消审批"按钮
✅ "取消审批"按钮可以点击

#### 操作：
1. 点击"取消审批"按钮
2. 在弹出的对话框中填写取消原因
3. 点击确定

#### 预期结果：
✅ 显示"已取消审批"成功消息
✅ PQR状态变为"已取消"
✅ 按钮变为"提交审批"（可以重新开始审批流程）

---

### 测试3: 被退回后可以重新提交

#### 步骤：
1. 提交一个PQR审批
2. 审批人点击"退回"
3. 提交人查看该PQR

#### 预期结果：
✅ 状态显示"已退回"
✅ 显示"重新提交"按钮
✅ 显示"取消审批"按钮

---

### 测试4: 已批准后不能取消

#### 步骤：
1. 找到一个已批准的PQR（状态显示"已批准"）
2. 查看操作按钮区域

#### 预期结果：
✅ "取消审批"按钮不显示
✅ 只显示查看、编辑、导出等常规操作按钮

#### 对比：
- ❌ 修复前：可能显示"取消审批"按钮
- ✅ 修复后：不显示"取消审批"按钮

---

### 测试5: 审批中可以取消

#### 步骤：
1. 提交一个PQR审批（状态变为"待审批"或"审批中"）
2. 提交人查看该PQR

#### 预期结果：
✅ 显示"取消审批"按钮
✅ 点击后可以成功取消

---

### 测试6: pPQR功能一致性

#### 步骤：
1. 在pPQR列表中重复测试1-5的所有场景

#### 预期结果：
✅ pPQR的按钮行为与PQR完全一致
✅ 所有功能正常工作

---

## 完整测试矩阵

| 审批状态 | 提交按钮文本 | 提交按钮显示 | 取消按钮显示 | 审批按钮显示 |
|---------|------------|------------|------------|------------|
| draft | 提交审批 | ✅ | ❌ | ❌ |
| pending | - | ❌ | ✅ | ✅ (审批人) |
| in_progress | - | ❌ | ✅ | ✅ (审批人) |
| rejected | 重新提交 | ✅ | ✅ | ❌ |
| returned | 重新提交 | ✅ | ✅ | ❌ |
| approved | - | ❌ | ❌ | ❌ |
| cancelled | 提交审批 | ✅ | ❌ | ❌ |

## 测试检查清单

### 功能测试
- [ ] 首次提交显示"提交审批"
- [ ] 被拒绝后显示"重新提交"
- [ ] 被退回后显示"重新提交"
- [ ] 被拒绝后可以取消审批
- [ ] 被退回后可以取消审批
- [ ] 审批中可以取消审批
- [ ] 已批准后不能取消审批
- [ ] 已取消后可以重新提交

### UI测试
- [ ] 按钮文本正确
- [ ] 按钮图标正确
- [ ] 按钮颜色正确
- [ ] 按钮大小一致
- [ ] 按钮对齐正确

### 交互测试
- [ ] 点击按钮弹出正确的对话框
- [ ] 对话框标题正确
- [ ] 输入框提示文本正确
- [ ] 提交后显示成功消息
- [ ] 提交后数据刷新
- [ ] 提交后状态更新

### 权限测试
- [ ] 非提交人看不到"取消审批"按钮
- [ ] 非审批人看不到审批操作按钮
- [ ] 提交人可以取消自己提交的审批

### 跨模块测试
- [ ] WPS功能正常
- [ ] PQR功能正常
- [ ] pPQR功能正常
- [ ] 三个模块行为一致

## 常见问题排查

### 问题1: 按钮不显示
**检查**:
1. 刷新页面（Ctrl+F5）
2. 检查浏览器控制台是否有错误
3. 检查后端返回的`approval_status`字段
4. 检查`can_submit_approval`和`can_cancel`字段

### 问题2: 点击按钮没反应
**检查**:
1. 打开浏览器控制台查看错误
2. 检查网络请求是否发送
3. 检查后端日志
4. 检查token是否有效

### 问题3: 状态不更新
**检查**:
1. 确认`onSuccess`回调被调用
2. 确认`refetch`函数正常工作
3. 手动刷新页面验证

### 问题4: 按钮文本错误
**检查**:
1. 确认`approval_status`值正确
2. 确认ApprovalButton组件的props传递正确
3. 检查是否有缓存问题

## 浏览器控制台调试

### 查看PQR数据
```javascript
// 在PQR列表页面的控制台输入
console.log(document.querySelector('[class*="pqr-card"]'))
```

### 查看审批状态
```javascript
// 查看某个PQR的审批状态
const pqrCard = document.querySelector('[class*="pqr-card"]');
console.log(pqrCard.textContent);
```

### 查看localStorage
```javascript
// 查看当前工作区
console.log(localStorage.getItem('current_workspace'));

// 查看token
console.log(localStorage.getItem('token'));
```

## 测试数据准备

### 创建测试PQR
1. 点击"创建PQR"
2. 填写必要信息
3. 保存为草稿

### 模拟被拒绝状态
1. 提交PQR审批
2. 使用审批人账号登录
3. 拒绝该PQR
4. 切换回提交人账号

### 模拟被退回状态
1. 提交PQR审批
2. 使用审批人账号登录
3. 退回该PQR
4. 切换回提交人账号

### 模拟已批准状态
1. 提交PQR审批
2. 使用审批人账号登录
3. 批准该PQR
4. 切换回提交人账号

## 回归测试

确保修改没有影响其他功能：

- [ ] WPS审批功能正常
- [ ] PQR创建/编辑功能正常
- [ ] pPQR创建/编辑功能正常
- [ ] 审批历史显示正常
- [ ] 审批通知正常
- [ ] 导出功能正常
- [ ] 删除功能正常

## 测试报告模板

```
测试日期: ___________
测试人员: ___________
测试环境: ___________

测试结果:
✅ 通过: ___ 项
❌ 失败: ___ 项
⚠️  警告: ___ 项

详细说明:
1. ...
2. ...

问题记录:
1. ...
2. ...

建议:
1. ...
2. ...
```

## 自动化测试建议

可以编写E2E测试来自动化这些测试场景：

```typescript
// 示例：Playwright测试
test('被拒绝后显示重新提交按钮', async ({ page }) => {
  await page.goto('/pqr');
  const rejectedCard = page.locator('[data-status="rejected"]').first();
  const resubmitButton = rejectedCard.locator('button:has-text("重新提交")');
  await expect(resubmitButton).toBeVisible();
});
```

