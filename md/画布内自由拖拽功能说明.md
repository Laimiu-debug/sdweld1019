# 画布内自由拖拽功能说明

## 功能概述

现在画布上已经添加的模块可以自由拖拽,实现:
1. **跨行移动** - 可以把模块从一行拖到另一行
2. **同行内左右移动** - 可以在同一行内调整列的顺序
3. **拖到放置区** - 拖到左/右/新行放置区来精确定位
4. **直接交换** - 拖到另一个模块上直接交换位置

## 使用方法

### 1. 拖拽模块图标
每个模块卡片左侧有一个 `⋮⋮` (DragOutlined) 图标,点击并拖拽这个图标即可移动模块。

```
┌─────────────────────────────────┐
│ ⋮⋮ 基本信息  [编辑] [复制] [删除]│
│    (2 列)                       │
└─────────────────────────────────┘
  ↑
  拖拽这个图标
```

### 2. 拖到放置区 - 精确定位

当拖拽画布内的模块时,会显示所有可用的放置区(和从模块库拖拽时一样):

#### 场景1: 移动到另一行的左侧
```
初始状态:
行1: ┌─────────────┬─────────────┐
     │  基本信息   │  填充材料   │
     └─────────────┴─────────────┘

行2: ┌─────────────────────────────┐
     │      焊接参数 (全宽)        │
     └─────────────────────────────┘

拖拽"焊接参数"到行1左侧:
行1: ┌──────────┬─────────────┬─────────────┬──────────┐
     │    ←     │  基本信息   │  填充材料   │    →     │
     │  左侧    │             │             │  右侧    │
     │ (蓝色)   │             │             │          │
     └──────────┴─────────────┴─────────────┴──────────┘

释放后:
行1: ┌──────────┬──────────┬──────────┐
     │ 焊接参数 │ 基本信息 │ 填充材料 │
     └──────────┴──────────┴──────────┘

行2: (空,被自动删除)
```

#### 场景2: 移动到新行
```
初始状态:
行1: ┌─────────────┬─────────────┐
     │  基本信息   │  填充材料   │
     └─────────────┴─────────────┘

拖拽"填充材料"到底部新行放置区:
行1: ┌─────────────┬─────────────┐
     │  基本信息   │  填充材料   │
     └─────────────┴─────────────┘

     ┌───────────────────────────┐
     │    ↓ 新行 (蓝色高亮)      │
     └───────────────────────────┘

释放后:
行1: ┌─────────────────────────────┐
     │      基本信息 (全宽)        │
     └─────────────────────────────┘

行2: ┌─────────────────────────────┐
     │      填充材料 (全宽)        │
     └─────────────────────────────┘
```

#### 场景3: 同行内左右移动
```
初始状态:
┌──────────┬──────────┬──────────┐
│ 基本信息 │ 填充材料 │ 焊接参数 │
└──────────┴──────────┴──────────┘

拖拽"焊接参数"到"基本信息"左侧:
┌──────────┬──────────┬──────────┬──────────┐
│    ←     │ 基本信息 │ 填充材料 │ 焊接参数 │
│  左侧    │          │          │          │
│ (蓝色)   │          │          │          │
└──────────┴──────────┴──────────┴──────────┘

释放后:
┌──────────┬──────────┬──────────┐
│ 焊接参数 │ 基本信息 │ 填充材料 │
└──────────┴──────────┴──────────┘
```

### 3. 拖到另一个模块上 - 直接交换

如果不拖到放置区,而是直接拖到另一个模块上,会交换两个模块的位置:

```
初始状态:
行1: ┌─────────────┬─────────────┐
     │  基本信息   │  填充材料   │
     └─────────────┴─────────────┘

行2: ┌─────────────────────────────┐
     │      焊接参数 (全宽)        │
     └─────────────────────────────┘

拖拽"焊接参数"到"基本信息"上:
(直接拖到模块卡片上,不是放置区)

释放后:
行1: ┌─────────────┬─────────────┐
     │  焊接参数   │  填充材料   │
     └─────────────┴─────────────┘

行2: ┌─────────────────────────────┐
     │      基本信息 (全宽)        │
     └─────────────────────────────┘
```

## 技术实现

### 1. 拖拽检测

```typescript
// 检测是从模块库拖拽还是从画布拖拽
const isFromLibrary = active.data.current && (active.data.current as any).id
const isDraggingFromCanvas = activeModuleId && modules.find(m => m.instanceId === activeModuleId)
```

### 2. 显示放置区

```typescript
// 画布内拖拽时也显示放置区
const shouldShowDropZones = isDraggingFromLibrary || isDraggingFromCanvas

// 不显示正在拖拽的模块的放置区
const isDraggingThis = activeModuleId === instance.instanceId
const showLeftDropZone = shouldShowDropZones && !isDraggingThis && canAddColumn && columnIndex === 0
```

### 3. 处理拖拽结束

#### 拖到放置区
```typescript
if (isToDropZone) {
  // 1. 从原位置移除模块
  let updatedModules = modules.filter(m => m.instanceId !== draggedModule.instanceId)
  
  // 2. 重新计算原行的列索引
  const oldRowModules = updatedModules.filter(m => m.rowIndex === draggedModule.rowIndex)
  oldRowModules.forEach((m, idx) => {
    m.columnIndex = idx
  })
  
  // 3. 添加到新位置
  if (position === 'center') {
    draggedModule.rowIndex = rowIndex
    draggedModule.columnIndex = 0
  } else {
    const newColIndex = position === 'left' ? columnIndex : columnIndex + 1
    draggedModule.rowIndex = rowIndex
    draggedModule.columnIndex = newColIndex
    
    // 更新目标行其他模块的列索引
    updatedModules = updatedModules.map((m) => {
      if (m.rowIndex === rowIndex && m.columnIndex >= newColIndex) {
        return { ...m, columnIndex: m.columnIndex + 1 }
      }
      return m
    })
  }
  
  updatedModules.push(draggedModule)
  setModules(updatedModules)
}
```

#### 拖到另一个模块上
```typescript
else {
  // 使用 arrayMove 交换位置
  const oldIndex = modules.findIndex((m) => m.instanceId === active.id)
  const newIndex = modules.findIndex((m) => m.instanceId === over.id)
  const newModules = arrayMove(modules, oldIndex, newIndex)
  
  // 重新计算所有模块的 rowIndex 和 columnIndex
  // ...
}
```

### 4. 自动清理空行

当一行的所有模块都被移走后,该行会被自动删除,后续行的 `rowIndex` 会自动重新计算。

## 视觉反馈

### 拖拽中的模块
```typescript
opacity: isDragging ? 0.5 : 1
```
正在拖拽的模块会变成半透明,清楚指示哪个模块正在移动。

### 拖拽预览
```typescript
<DragOverlay dropAnimation={null}>
  <div style={{ 
    width: '200px',
    opacity: 0.9,
    pointerEvents: 'none'  // 不阻挡鼠标
  }}>
    <Card>
      <Text>{activeModule.name}</Text>
    </Card>
  </div>
</DragOverlay>
```

### 放置区高亮
- **未悬停**: 灰色虚线边框 `2px dashed #d9d9d9`
- **悬停时**: 蓝色实线边框 `3px solid #1890ff`

## 限制

1. **最大列数**: 每行最多4列
2. **不能拖到已满的行**: 如果目标行已有4列,会提示"每行最多支持4列"
3. **必须拖拽图标**: 只能拖拽 `⋮⋮` 图标,不能拖拽整个卡片

## 优势

✅ **完全自由** - 可以把任何模块移动到任何位置  
✅ **精确定位** - 使用放置区精确指定位置  
✅ **快速交换** - 直接拖到另一个模块上快速交换  
✅ **自动调整** - 列宽自动计算,行索引自动更新  
✅ **视觉清晰** - 半透明+蓝色高亮,清楚指示操作  
✅ **智能清理** - 空行自动删除,保持布局整洁  

## 使用提示

1. **拖拽图标**: 点击并拖拽 `⋮⋮` 图标,不是整个卡片
2. **看清放置区**: 拖拽时注意蓝色高亮的放置区,指示模块将被放置的位置
3. **精确vs快速**: 
   - 需要精确定位 → 拖到放置区
   - 快速交换位置 → 直接拖到另一个模块上
4. **跨行移动**: 可以自由地把模块从一行移到另一行
5. **创建新行**: 拖到底部的"新行"放置区

## 示例工作流

### 调整复杂布局
```
目标: 把4列布局调整为2行2列

初始:
┌────────┬────────┬────────┬────────┐
│ 模块1  │ 模块2  │ 模块3  │ 模块4  │
└────────┴────────┴────────┴────────┘

步骤1: 拖拽"模块3"到底部新行
┌────────┬────────┬────────┐
│ 模块1  │ 模块2  │ 模块4  │
└────────┴────────┴────────┘
┌─────────────────────────────┐
│      模块3 (全宽)           │
└─────────────────────────────┘

步骤2: 拖拽"模块4"到"模块3"右侧
┌────────┬────────┐
│ 模块1  │ 模块2  │
└────────┴────────┘
┌────────┬────────┐
│ 模块3  │ 模块4  │
└────────┴────────┘

完成! 2行2列布局
```

## 总结

画布内自由拖拽功能让用户可以:
- 🎯 **精确控制** 每个模块的位置
- 🔄 **快速调整** 布局结构
- 📐 **灵活组合** 1-4列的任意布局
- ✨ **直观操作** 拖拽即可,无需复杂设置

配合从模块库拖拽添加新模块,用户可以完全自由地构建任意复杂的表单布局!

