# 管理员支付订单管理指南

## 📋 概述

管理员可以通过支付订单管理页面查看、确认或拒绝用户提交的手动支付订单。

---

## 🚀 访问方式

### 管理员后台访问

1. 登录管理员后台: `http://localhost:5174` (或你的管理端端口)
2. 在左侧菜单中点击 **"支付订单"**
3. 或直接访问: `http://localhost:5174/payments`

---

## 📊 页面功能

### 1. 统计概览

页面顶部显示4个关键指标:

- **待确认订单**: 需要管理员处理的订单数量
- **待确认金额**: 待确认订单的总金额
- **已确认订单**: 已成功确认的订单数量
- **已拒绝订单**: 已拒绝的订单数量

### 2. 筛选功能

- **搜索框**: 支持搜索交易号、用户名、邮箱或套餐名称
- **状态筛选**: 
  - 待确认 (pending_confirm)
  - 已确认 (success)
  - 已拒绝 (rejected)
  - 全部 (all)

### 3. 订单列表

显示所有支付订单,包含以下信息:

| 列名 | 说明 |
|------|------|
| 交易号 | 系统生成的唯一交易标识 (TXN格式) |
| 用户信息 | 用户名和邮箱 |
| 套餐 | 购买的会员套餐名称 |
| 金额 | 支付金额 |
| 支付方式 | 支付宝/微信支付/银行转账 |
| 状态 | 订单当前状态 |
| 提交时间 | 用户提交支付凭证的时间 |
| 操作 | 查看详情/确认/拒绝 |

---

## 🔧 操作流程

### 确认支付订单

1. 在订单列表中找到状态为 **"待确认"** 的订单
2. 点击 **"详情"** 按钮查看完整信息
3. 核对以下信息:
   - 用户提交的交易凭证 (在"用户提交的交易凭证"字段)
   - 支付金额是否正确
   - 支付方式是否匹配
4. 确认无误后,点击 **"确认支付"** 按钮
5. 在弹出的确认对话框中点击 **"确认"**
6. 系统将:
   - 更新订单状态为 "已确认"
   - 激活用户的会员订阅
   - 更新用户的会员等级和配额

### 拒绝支付订单

1. 在订单列表中找到需要拒绝的订单
2. 点击 **"详情"** 按钮查看原因
3. 点击 **"拒绝支付"** 按钮
4. 在弹出的确认对话框中点击 **"拒绝"**
5. 系统将:
   - 更新订单状态为 "已拒绝"
   - 订阅保持未激活状态
   - (建议) 通知用户拒绝原因

### 查看订单详情

点击任意订单的 **"详情"** 按钮,可以查看:

- 交易号
- 用户名和邮箱
- 购买的套餐
- 支付金额和货币
- 支付方式
- 订单状态
- **用户提交的交易凭证** (重要!)
- 提交时间
- 更新时间
- 交易时间 (如果已确认)

---

## 🔄 自动刷新

- 页面每 **30秒** 自动刷新一次数据
- 也可以手动点击右上角的 **"刷新"** 按钮

---

## 📝 订单状态说明

| 状态 | 说明 | 颜色 |
|------|------|------|
| pending_confirm | 待确认 - 用户已提交支付凭证,等待管理员确认 | 橙色 |
| success | 已确认 - 管理员已确认,会员已开通 | 绿色 |
| rejected | 已拒绝 - 管理员已拒绝此订单 | 红色 |
| pending | 待支付 - 订单已创建,用户未提交凭证 | 蓝色 |
| failed | 失败 - 支付失败 | 红色 |

---

## 🎯 最佳实践

### 确认订单前的检查清单

- [ ] 核对用户提交的交易号/凭证
- [ ] 检查支付金额是否与套餐价格一致
- [ ] 确认支付方式 (支付宝/微信)
- [ ] 查看用户信息是否正常
- [ ] 检查是否有重复订单

### 拒绝订单的常见原因

- 交易凭证无效或不清晰
- 支付金额不符
- 重复提交
- 可疑交易
- 用户信息异常

### 处理建议

1. **及时处理**: 建议在24小时内处理待确认订单
2. **仔细核对**: 确认前务必核对交易凭证
3. **记录原因**: 拒绝订单时建议记录原因 (未来功能)
4. **用户沟通**: 拒绝订单后建议联系用户说明原因

---

## 🔐 权限要求

- 只有 **管理员** (is_admin = true) 才能访问此页面
- 普通用户访问会返回 403 Forbidden 错误

---

## 🛠️ 技术细节

### API 端点

- **获取订单列表**: `GET /api/v1/payments/pending?status={status}`
- **确认支付**: `POST /api/v1/payments/admin/confirm-payment`
- **拒绝支付**: `POST /api/v1/payments/admin/reject-payment`

### 数据流程

```
用户提交支付凭证
    ↓
订单状态: pending → pending_confirm
    ↓
管理员查看订单列表
    ↓
管理员确认/拒绝
    ↓
订单状态: pending_confirm → success/rejected
    ↓
(如果确认) 激活用户订阅
```

---

## 📱 响应式设计

- 页面支持桌面端和移动端访问
- 表格支持横向滚动
- 统计卡片在小屏幕上自动换行

---

## 🐛 常见问题

### Q: 为什么看不到任何订单?

A: 可能的原因:
1. 确实没有待确认的订单
2. 筛选条件设置不正确 (尝试选择"全部")
3. 没有管理员权限
4. 后端服务未启动

### Q: 确认订单后用户会员没有生效?

A: 检查:
1. 后端日志是否有错误
2. 数据库中订阅状态是否更新为 'active'
3. 用户的 membership_tier 是否更新

### Q: 如何查看历史订单?

A: 在状态筛选中选择 "已确认" 或 "已拒绝" 或 "全部"

---

## 📞 技术支持

如有问题,请检查:
1. 浏览器控制台错误信息
2. 后端日志 (uvicorn 输出)
3. 网络请求响应 (F12 → Network)

---

## 🎉 总结

管理员支付订单管理页面提供了:
- ✅ 实时订单监控
- ✅ 快速确认/拒绝操作
- ✅ 详细的订单信息
- ✅ 统计数据概览
- ✅ 自动刷新功能
- ✅ 响应式设计

通过这个页面,管理员可以高效地处理用户的手动支付订单,确保会员服务的顺利开通!

