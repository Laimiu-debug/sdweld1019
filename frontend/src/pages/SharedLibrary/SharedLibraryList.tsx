import React, { useState, useEffect } from 'react';
import {
  Card,
  Row,
  Col,
  Button,
  Input,
  Select,
  Tag,
  Rate,
  Pagination,
  Spin,
  Empty,
  Tabs,
  Badge,
  message,
  Tooltip,
  Modal,
  Form,
  Space
} from 'antd';
import {
  SearchOutlined,
  DownloadOutlined,
  LikeOutlined,
  DislikeOutlined,
  EyeOutlined,
  StarOutlined,
  FilterOutlined,
  ShareAltOutlined,
  HeartOutlined,
  CommentOutlined,
  DeleteOutlined,
  ExclamationCircleOutlined
} from '@ant-design/icons';
import { SharedLibraryService, SharedModule, SharedTemplate, LibrarySearchQuery } from '../../services/sharedLibrary';
import { useAuthStore } from '@/store/authStore';
import './SharedLibraryList.css';

const { Search } = Input;
const { Option } = Select;

const SharedLibraryList: React.FC = () => {
  const { user } = useAuthStore();
  const [loading, setLoading] = useState(false);
  const [activeTab, setActiveTab] = useState<'modules' | 'templates'>('modules');
  const [modules, setModules] = useState<SharedModule[]>([]);
  const [templates, setTemplates] = useState<SharedTemplate[]>([]);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 20,
    total: 0
  });

  // ÊêúÁ¥¢Áä∂ÊÄÅ
  const [searchQuery, setSearchQuery] = useState<LibrarySearchQuery>({
    status: 'approved',
    sort_by: 'created_at',
    sort_order: 'desc',
    page: 1,
    page_size: 20,
    featured_only: false
  });

  // Á≠õÈÄâÂô®ÊòæÁ§∫Áä∂ÊÄÅ
  const [showFilters, setShowFilters] = useState(false);

  // Âä†ËΩΩÂÖ±‰∫´Ê®°Âùó
  const loadModules = async (query: LibrarySearchQuery) => {
    setLoading(true);
    try {
      const response = await SharedLibraryService.getSharedModules(query);
      setModules(response.items);
      setPagination(prev => ({
        ...prev,
        current: query.page || 1,
        total: response.total
      }));
    } catch (error) {
      console.error('Âä†ËΩΩÂÖ±‰∫´Ê®°ÂùóÂ§±Ë¥•:', error);
      message.error('Âä†ËΩΩÂÖ±‰∫´Ê®°ÂùóÂ§±Ë¥•');
    } finally {
      setLoading(false);
    }
  };

  // Âä†ËΩΩÂÖ±‰∫´Ê®°Êùø
  const loadTemplates = async (query: LibrarySearchQuery) => {
    setLoading(true);
    try {
      const response = await SharedLibraryService.getSharedTemplates(query);
      setTemplates(response.items);
      setPagination(prev => ({
        ...prev,
        current: query.page || 1,
        total: response.total
      }));
    } catch (error) {
      console.error('Âä†ËΩΩÂÖ±‰∫´Ê®°ÊùøÂ§±Ë¥•:', error);
      message.error('Âä†ËΩΩÂÖ±‰∫´Ê®°ÊùøÂ§±Ë¥•');
    } finally {
      setLoading(false);
    }
  };

  // ÂàùÂßãÂä†ËΩΩ
  useEffect(() => {
    if (activeTab === 'modules') {
      loadModules(searchQuery);
    } else {
      loadTemplates(searchQuery);
    }
  }, [activeTab, searchQuery]);

  // ÊêúÁ¥¢Â§ÑÁêÜ
  const handleSearch = (value: string) => {
    setSearchQuery(prev => ({
      ...prev,
      keyword: value,
      page: 1
    }));
  };

  // ‰∏ãËΩΩÊ®°Âùó
  const handleDownloadModule = async (module: SharedModule) => {
    if (!user) {
      message.error('ËØ∑ÂÖàÁôªÂΩï');
      return;
    }

    try {
      await SharedLibraryService.downloadSharedModule(module.id);
      message.success('‰∏ãËΩΩÊàêÂäü');
      loadModules(searchQuery);
    } catch (error: any) {
      message.error(error.response?.data?.detail || '‰∏ãËΩΩÂ§±Ë¥•');
    }
  };

  // ‰∏ãËΩΩÊ®°Êùø
  const handleDownloadTemplate = async (template: SharedTemplate) => {
    if (!user) {
      message.error('ËØ∑ÂÖàÁôªÂΩï');
      return;
    }

    try {
      await SharedLibraryService.downloadSharedTemplate(template.id);
      message.success('‰∏ãËΩΩÊàêÂäü');
      loadTemplates(searchQuery);
    } catch (error: any) {
      message.error(error.response?.data?.detail || '‰∏ãËΩΩÂ§±Ë¥•');
    }
  };

  // Âà†Èô§Ê®°Âùó
  const handleDeleteModule = async (module: SharedModule) => {
    Modal.confirm({
      title: 'Á°ÆËÆ§Âà†Èô§',
      icon: <ExclamationCircleOutlined />,
      content: `Á°ÆÂÆöË¶ÅÂà†Èô§Ê®°Âùó"${module.name}"ÂêóÔºü`,
      onOk: async () => {
        try {
          await SharedLibraryService.deleteSharedModule(module.id);
          message.success('Âà†Èô§ÊàêÂäü');
          loadModules(searchQuery);
        } catch (error: any) {
          message.error(error.response?.data?.detail || 'Âà†Èô§Â§±Ë¥•');
        }
      }
    });
  };

  // Âà†Èô§Ê®°Êùø
  const handleDeleteTemplate = async (template: SharedTemplate) => {
    Modal.confirm({
      title: 'Á°ÆËÆ§Âà†Èô§',
      icon: <ExclamationCircleOutlined />,
      content: `Á°ÆÂÆöË¶ÅÂà†Èô§Ê®°Êùø"${template.name}"ÂêóÔºü`,
      onOk: async () => {
        try {
          await SharedLibraryService.deleteSharedTemplate(template.id);
          message.success('Âà†Èô§ÊàêÂäü');
          loadTemplates(searchQuery);
        } catch (error: any) {
          message.error(error.response?.data?.detail || 'Âà†Èô§Â§±Ë¥•');
        }
      }
    });
  };

  // ËØÑÂàÜÂ§ÑÁêÜ
  const handleRating = async (targetType: 'module' | 'template', targetId: string, ratingType: 'like' | 'dislike') => {
    if (!user) {
      message.error('ËØ∑ÂÖàÁôªÂΩï');
      return;
    }

    try {
      await SharedLibraryService.rateSharedResource({
        target_type: targetType,
        target_id: targetId,
        rating_type: ratingType
      });

      message.success('ËØÑÂàÜÊàêÂäü');
      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      if (activeTab === 'modules') {
        loadModules(searchQuery);
      } else {
        loadTemplates(searchQuery);
      }
    } catch (error: any) {
      message.error(error.response?.data?.detail || 'ËØÑÂàÜÂ§±Ë¥•');
    }
  };

  // Ê∏≤ÊüìÊ®°ÂùóÂç°Áâá
  const renderModuleCard = (module: SharedModule) => (
    <Card
      key={module.id}
      hoverable
      className="shared-item-card"
      cover={
        <div className="card-cover">
          <div className="icon-container">
            <span className="module-icon">{module.icon}</span>
          </div>
          {module.is_featured && (
            <div className="featured-badge">
              <StarOutlined /> Êé®Ëçê
            </div>
          )}
        </div>
      }
      actions={[
        <Tooltip title="ÊµèËßàÊ¨°Êï∞">
          <EyeOutlined /> {module.view_count}
        </Tooltip>,
        <Tooltip title="‰∏ãËΩΩ">
          <Button
            type="text"
            icon={<DownloadOutlined />}
            onClick={() => handleDownloadModule(module)}
          >
            {module.download_count}
          </Button>
        </Tooltip>,
        <Tooltip title="ÁÇπËµû">
          <Button
            type="text"
            icon={<LikeOutlined />}
            className={module.user_rating === 'like' ? 'liked' : ''}
            onClick={() => handleRating('module', module.id, 'like')}
          >
            {module.like_count}
          </Button>
        </Tooltip>,
        <Tooltip title="ÁÇπË∏©">
          <Button
            type="text"
            icon={<DislikeOutlined />}
            className={module.user_rating === 'dislike' ? 'disliked' : ''}
            onClick={() => handleRating('module', module.id, 'dislike')}
          >
            {module.dislike_count}
          </Button>
        </Tooltip>,
        ...(user && module.uploader_id === user.id ? [
          <Tooltip key="delete" title="Âà†Èô§">
            <Button
              type="text"
              danger
              icon={<DeleteOutlined />}
              onClick={() => handleDeleteModule(module)}
            >
              Âà†Èô§
            </Button>
          </Tooltip>
        ] : [])
      ]}
    >
      <Card.Meta
        title={
          <div className="item-title">
            <span className="name">{module.name}</span>
            <Tag color="blue">{module.category}</Tag>
          </div>
        }
        description={
          <div className="item-description">
            <p className="description">{module.description}</p>
            <div className="meta-info">
              <span className="uploader">‰∏ä‰º†ËÄÖ: {module.uploader_name}</span>
              <span className="difficulty">ÈöæÂ∫¶: {module.difficulty_level}</span>
              <span className="date">{new Date(module.created_at).toLocaleDateString()}</span>
            </div>
            {module.tags.length > 0 && (
              <div className="tags">
                {module.tags.map(tag => (
                  <Tag key={tag} size="small">{tag}</Tag>
                ))}
              </div>
            )}
          </div>
        }
      />
    </Card>
  );

  // Ê∏≤ÊüìÊ®°ÊùøÂç°Áâá
  const renderTemplateCard = (template: SharedTemplate) => (
    <Card
      key={template.id}
      hoverable
      className="shared-item-card"
      cover={
        <div className="card-cover">
          <div className="icon-container">
            <span className="template-icon">üìã</span>
          </div>
          {template.is_featured && (
            <div className="featured-badge">
              <StarOutlined /> Êé®Ëçê
            </div>
          )}
        </div>
      }
      actions={[
        <Tooltip title="ÊµèËßàÊ¨°Êï∞">
          <EyeOutlined /> {template.view_count}
        </Tooltip>,
        <Tooltip title="‰∏ãËΩΩ">
          <Button
            type="text"
            icon={<DownloadOutlined />}
            onClick={() => handleDownloadTemplate(template)}
          >
            {template.download_count}
          </Button>
        </Tooltip>,
        <Tooltip title="ÁÇπËµû">
          <Button
            type="text"
            icon={<LikeOutlined />}
            className={template.user_rating === 'like' ? 'liked' : ''}
            onClick={() => handleRating('template', template.id, 'like')}
          >
            {template.like_count}
          </Button>
        </Tooltip>,
        <Tooltip title="ÁÇπË∏©">
          <Button
            type="text"
            icon={<DislikeOutlined />}
            className={template.user_rating === 'dislike' ? 'disliked' : ''}
            onClick={() => handleRating('template', template.id, 'dislike')}
          >
            {template.dislike_count}
          </Button>
        </Tooltip>,
        ...(user && template.uploader_id === user.id ? [
          <Tooltip key="delete" title="Âà†Èô§">
            <Button
              type="text"
              danger
              icon={<DeleteOutlined />}
              onClick={() => handleDeleteTemplate(template)}
            >
              Âà†Èô§
            </Button>
          </Tooltip>
        ] : [])
      ]}
    >
      <Card.Meta
        title={
          <div className="item-title">
            <span className="name">{template.name}</span>
            {template.welding_process && <Tag color="green">{template.welding_process_name}</Tag>}
            {template.standard && <Tag color="orange">{template.standard}</Tag>}
          </div>
        }
        description={
          <div className="item-description">
            <p className="description">{template.description}</p>
            <div className="meta-info">
              <span className="uploader">‰∏ä‰º†ËÄÖ: {template.uploader_name}</span>
              <span className="difficulty">ÈöæÂ∫¶: {template.difficulty_level}</span>
              <span className="date">{new Date(template.created_at).toLocaleDateString()}</span>
            </div>
            {template.industry_type && (
              <div className="industry-type">
                <Tag color="purple">Ë°å‰∏ö: {template.industry_type}</Tag>
              </div>
            )}
            {template.tags.length > 0 && (
              <div className="tags">
                {template.tags.map(tag => (
                  <Tag key={tag} size="small">{tag}</Tag>
                ))}
              </div>
            )}
          </div>
        }
      />
    </Card>
  );

  // ÂÆö‰πâTab items
  const tabItems = [
    {
      key: 'modules',
      label: (
        <span>
          <i className="module-tab-icon">üß©</i>
          ÂÖ±‰∫´Ê®°Âùó
          <Badge count={modules.length} showZero={false} />
        </span>
      ),
      children: (
        <Spin spinning={loading}>
          {modules.length === 0 ? (
            <Empty description="ÊöÇÊó†ÂÖ±‰∫´Ê®°Âùó" />
          ) : (
            <Row gutter={[16, 16]}>
              {modules.map(module => (
                <Col xs={24} sm={12} md={8} lg={6} key={module.id}>
                  {renderModuleCard(module)}
                </Col>
              ))}
            </Row>
          )}
        </Spin>
      )
    },
    {
      key: 'templates',
      label: (
        <span>
          <i className="template-tab-icon">üìã</i>
          ÂÖ±‰∫´Ê®°Êùø
          <Badge count={templates.length} showZero={false} />
        </span>
      ),
      children: (
        <Spin spinning={loading}>
          {templates.length === 0 ? (
            <Empty description="ÊöÇÊó†ÂÖ±‰∫´Ê®°Êùø" />
          ) : (
            <Row gutter={[16, 16]}>
              {templates.map(template => (
                <Col xs={24} sm={12} md={8} lg={6} key={template.id}>
                  {renderTemplateCard(template)}
                </Col>
              ))}
            </Row>
          )}
        </Spin>
      )
    }
  ];

  // Á≠õÈÄâÂ§ÑÁêÜ
  const handleFilterChange = (key: string, value: any) => {
    setSearchQuery(prev => ({
      ...prev,
      [key]: value,
      page: 1
    }));
  };

  // ÂàÜÈ°µÂ§ÑÁêÜ
  const handlePageChange = (page: number, pageSize?: number) => {
    setSearchQuery(prev => ({
      ...prev,
      page,
      page_size: pageSize || prev.page_size
    }));
  };

  // ÊéíÂ∫èÂ§ÑÁêÜ
  const handleSortChange = (value: string) => {
    const [sort_by, sort_order] = value.split('_');
    setSearchQuery(prev => ({
      ...prev,
      sort_by,
      sort_order,
      page: 1
    }));
  };

  return (
    <div className="shared-library-list">
      <div className="search-section">
        <Row gutter={[16, 16]} align="middle">
          <Col xs={24} md={12}>
            <Search
              placeholder="ÊêúÁ¥¢Ê®°ÂùóÊàñÊ®°Êùø..."
              allowClear
              enterButton={<SearchOutlined />}
              size="large"
              onSearch={handleSearch}
            />
          </Col>
          <Col xs={24} md={12}>
            <Space>
              <Button
                icon={<FilterOutlined />}
                onClick={() => setShowFilters(!showFilters)}
              >
                Á≠õÈÄâ
              </Button>
              <Select
                placeholder="ÊéíÂ∫èÊñπÂºè"
                style={{ width: 150 }}
                value={`${searchQuery.sort_by}_${searchQuery.sort_order}`}
                onChange={handleSortChange}
              >
                <Option value="created_at_desc">ÊúÄÊñ∞ÂèëÂ∏É</Option>
                <Option value="created_at_asc">ÊúÄÊó©ÂèëÂ∏É</Option>
                <Option value="download_count_desc">‰∏ãËΩΩÊúÄÂ§ö</Option>
                <Option value="like_count_desc">ÁÇπËµûÊúÄÂ§ö</Option>
                <Option value="name_asc">ÂêçÁß∞ A-Z</Option>
                <Option value="name_desc">ÂêçÁß∞ Z-A</Option>
              </Select>
            </Space>
          </Col>
        </Row>

        {showFilters && (
          <div className="filters-panel">
            <Row gutter={[16, 16]}>
              <Col xs={24} sm={8} md={6}>
                <Select
                  placeholder="ÂàÜÁ±ª"
                  style={{ width: '100%' }}
                  allowClear
                  onChange={(value) => handleFilterChange('category', value)}
                >
                  <Option value="basic">Âü∫Á°Ä</Option>
                  <Option value="material">ÊùêÊñô</Option>
                  <Option value="gas">Ê∞î‰Ωì</Option>
                  <Option value="electrical">ÁîµÊ∞î</Option>
                  <Option value="motion">ËøêÂä®</Option>
                  <Option value="equipment">ËÆæÂ§á</Option>
                  <Option value="calculation">ËÆ°ÁÆó</Option>
                </Select>
              </Col>
              <Col xs={24} sm={8} md={6}>
                <Select
                  placeholder="ÈöæÂ∫¶Á≠âÁ∫ß"
                  style={{ width: '100%' }}
                  allowClear
                  onChange={(value) => handleFilterChange('difficulty_level', value)}
                >
                  <Option value="beginner">ÂàùÁ∫ß</Option>
                  <Option value="intermediate">‰∏≠Á∫ß</Option>
                  <Option value="advanced">È´òÁ∫ß</Option>
                </Select>
              </Col>
              <Col xs={24} sm={8} md={6}>
                <Select
                  placeholder="ÁÑäÊé•Â∑•Ëâ∫"
                  style={{ width: '100%' }}
                  allowClear
                  onChange={(value) => handleFilterChange('welding_process', value)}
                >
                  <Option value="111">ÊâãÂ∑•ÁîµÂºßÁÑä</Option>
                  <Option value="114">ÂüãÂºßÁÑä</Option>
                  <Option value="121">Èí®ÊûÅÊ∞©ÂºßÁÑä</Option>
                  <Option value="135">ÁÜîÂåñÊûÅÊ∞©ÂºßÁÑä</Option>
                  <Option value="141">Èí®ÊûÅÊ∞©ÂºßÁÑä</Option>
                  <Option value="15">Ê∞îÁÑä</Option>
                  <Option value="311">Ê∞îÂâ≤</Option>
                </Select>
              </Col>
              <Col xs={24} sm={8} md={6}>
                <Button
                  type={searchQuery.featured_only ? 'primary' : 'default'}
                  icon={<StarOutlined />}
                  onClick={() => handleFilterChange('featured_only', !searchQuery.featured_only)}
                >
                  ‰ªÖÊòæÁ§∫Êé®Ëçê
                </Button>
              </Col>
            </Row>
          </div>
        )}
      </div>

      <div className="content-section">
        <Tabs
          activeKey={activeTab}
          onChange={(key) => setActiveTab(key as 'modules' | 'templates')}
          items={tabItems}
        />

        {pagination.total > pagination.pageSize && (
          <div className="pagination-wrapper">
            <Pagination
              current={pagination.current}
              pageSize={pagination.pageSize}
              total={pagination.total}
              showSizeChanger
              showQuickJumper
              showTotal={(total, range) => `${range[0]}-${range[1]} ÂÖ± ${total} Êù°`}
              onChange={handlePageChange}
            />
          </div>
        )}
      </div>
    </div>
  );
};

export default SharedLibraryList;