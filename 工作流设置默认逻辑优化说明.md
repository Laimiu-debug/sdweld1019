# 工作流设置默认逻辑优化说明

## 问题描述

### 1. 工作区隔离问题 ⚠️ **核心问题**
不同企业可以看到其他企业创建的工作流，导致：
- 用户看到不属于自己企业的工作流
- 尝试删除其他企业的工作流时失败（权限检查阻止）
- 工作流列表混乱，无法区分哪些是自己企业的

**根本原因**：查询工作流列表时，过滤条件使用了 `is_default=True` 来判断系统工作流，但实际上其他企业的默认工作流也会被包含进来。

### 2. 删除工作流失败
用户尝试删除工作流时失败，可能的原因：
- 该工作流被设置为默认工作流（`is_default=True`）
- 该工作流属于其他企业（`company_id` 不匹配）
- 该工作流是系统工作流（`company_id IS NULL`）

### 3. 设置默认工作流的逻辑不完善
当设置某个工作流为默认时，应该：
- 自动**启用**被设置为默认的工作流（`is_active=True`）
- 自动**禁用**同一文档类型的其他工作流（`is_active=False`）
- 取消其他工作流的默认状态（`is_default=False`）

## 修改内容

### 后端修改 (`backend/app/api/v1/endpoints/approvals.py`)

#### 1. 🔥 修复工作区隔离问题 - `get_workflows` 函数（第411-422行）

**问题根源**：
原代码使用 `is_default=True` 来过滤系统工作流，但这会包含其他企业的默认工作流。

**修改前：**
```python
# 只显示系统默认工作流和当前企业的工作流
if workspace_context.workspace_type == "enterprise":
    query = query.filter(
        (ApprovalWorkflowDefinition.is_default == True) |  # ❌ 错误：会包含其他企业的默认工作流
        (ApprovalWorkflowDefinition.company_id == workspace_context.company_id)
    )
else:
    # 个人工作区只显示系统默认工作流
    query = query.filter(ApprovalWorkflowDefinition.is_default == True)  # ❌ 错误
```

**修改后：**
```python
# 只显示系统工作流和当前企业的工作流
if workspace_context.workspace_type == "enterprise":
    # 企业工作区：显示系统工作流(company_id IS NULL) 和 当前企业的工作流
    query = query.filter(
        (ApprovalWorkflowDefinition.company_id.is_(None)) |  # ✅ 正确：只显示系统工作流
        (ApprovalWorkflowDefinition.company_id == workspace_context.company_id)
    )
else:
    # 个人工作区只显示系统工作流
    query = query.filter(ApprovalWorkflowDefinition.company_id.is_(None))  # ✅ 正确
```

**关键区别**：
- ❌ `is_default=True`：企业A的默认工作流在企业B也会显示
- ✅ `company_id IS NULL`：只显示真正的系统工作流（不属于任何企业）

#### 2. 修复更新工作流权限检查 - `update_workflow` 函数（第577-617行）

**修改前：**
```python
# 不能修改系统默认工作流
if workflow.is_default:  # ❌ 错误：企业的默认工作流也不能修改了
    raise HTTPException(
        status_code=status.HTTP_403_FORBIDDEN,
        detail="不能修改系统默认工作流"
    )
```

**修改后：**
```python
# 不能修改系统工作流
if workflow.company_id is None:  # ✅ 正确：只有系统工作流不能修改
    print(f"[更新工作流] 不能修改系统工作流")
    raise HTTPException(
        status_code=status.HTTP_403_FORBIDDEN,
        detail="不能修改系统工作流"
    )
```

**新增**：添加详细的日志输出，便于调试权限问题。

#### 3. 优化 `set_default_workflow` 函数（第710-760行）

**修改前：**
- 只取消其他工作流的默认状态
- 不会自动启用/禁用工作流

**修改后：**
```python
# 取消同一文档类型、同一企业的其他工作流的默认状态，并禁用它们
db.query(ApprovalWorkflowDefinition).filter(
    ApprovalWorkflowDefinition.company_id == workspace_context.company_id,
    ApprovalWorkflowDefinition.document_type == workflow.document_type,
    ApprovalWorkflowDefinition.id != workflow_id
).update({
    "is_default": False,
    "is_active": False  # 禁用其他工作流
})

# 设置当前工作流为默认并启用
workflow.is_default = True
workflow.is_active = True  # 自动启用
workflow.updated_by = current_user.id
```

**新增功能：**
- 添加了详细的日志输出，便于调试
- 同一文档类型的其他工作流会被自动禁用
- 被设置为默认的工作流会被自动启用

### 前端修改 (`frontend/src/pages/Workflow/ApprovalWorkflows.tsx`)

#### 1. 优化 `handleSetDefault` 函数（第264-285行）

**修改前：**
- 直接调用API设置默认工作流
- 没有确认提示

**修改后：**
```typescript
const handleSetDefault = async (id: number, record: any) => {
  Modal.confirm({
    title: '设置为默认工作流',
    content: `确定要将"${record.name}"设置为默认工作流吗？设置后，同一文档类型的其他工作流将被自动禁用。`,
    okText: '确定',
    cancelText: '取消',
    onOk: async () => {
      // ... API调用
      message.success('已设置为默认工作流，其他工作流已自动禁用')
    }
  })
}
```

**新增功能：**
- 添加了确认对话框
- 明确提示用户其他工作流会被禁用
- 成功后的提示信息更加详细

#### 2. 更新按钮点击事件（第384行）

**修改前：**
```typescript
onClick={() => handleSetDefault(record.id)}
```

**修改后：**
```typescript
onClick={() => handleSetDefault(record.id, record)}
```

传入完整的 record 对象，以便在确认对话框中显示工作流名称。

## 业务逻辑说明

### 工作流类型定义

1. **系统工作流**（`company_id IS NULL`）
   - 由系统管理员创建
   - 所有企业都可以看到和使用
   - 不能被企业用户修改、删除或禁用
   - 作为默认的审批流程模板

2. **企业自定义工作流**（`company_id = 企业ID`）
   - 由企业用户创建
   - 只有本企业用户可以看到和使用
   - 可以被本企业用户修改、删除、启用/禁用
   - 可以设置为企业内的默认工作流

### 工作区隔离规则

1. **企业工作区**
   - 显示：系统工作流 + 本企业的工作流
   - 不显示：其他企业的工作流
   - 可操作：本企业的工作流
   - 不可操作：系统工作流、其他企业的工作流

2. **个人工作区**
   - 只显示：系统工作流
   - 不能创建自定义工作流
   - 不能修改任何工作流

### 工作流状态管理规则

1. **默认工作流规则**
   - 每个文档类型在同一企业内只能有一个默认工作流
   - 默认工作流必须是启用状态
   - 不能删除默认工作流（需要先设置其他工作流为默认）
   - 系统工作流可以是默认的，但企业可以创建自己的默认工作流覆盖

2. **设置默认工作流时的自动操作**
   - ✅ 将目标工作流设置为默认（`is_default=True`）
   - ✅ 自动启用目标工作流（`is_active=True`）
   - ✅ 取消同一文档类型、同一企业的其他工作流的默认状态（`is_default=False`）
   - ✅ 自动禁用同一文档类型、同一企业的其他工作流（`is_active=False`）

3. **删除工作流规则**
   - ❌ 不能删除系统工作流（`company_id IS NULL`）
   - ❌ 不能删除其他企业的工作流（`company_id != 当前企业ID`）
   - ❌ 不能删除当前的默认工作流（`is_default=True`）
   - ✅ 只能删除非默认的本企业自定义工作流
   - 💡 如需删除默认工作流，需先将其他工作流设置为默认

## 用户操作流程

### 场景1：看到其他企业的工作流（已修复）

**问题现象：**
- 在工作流列表中看到不属于自己企业的工作流
- 尝试删除时提示"无权删除此工作流"

**修复后：**
- 只显示系统工作流和本企业的工作流
- 不会再看到其他企业的工作流

### 场景2：删除默认工作流

**步骤：**
1. 创建或选择另一个工作流
2. 点击"设置为默认"按钮
3. 确认设置（系统会自动禁用原默认工作流）
4. 现在可以删除原来的工作流了

### 场景3：切换默认工作流

**步骤：**
1. 找到要设置为默认的工作流
2. 点击"设置为默认"按钮（星形图标）
3. 在确认对话框中点击"确定"
4. 系统自动完成：
   - 启用新的默认工作流
   - 禁用其他同类型工作流
   - 显示成功提示

## 测试建议

### 测试用例

1. **测试工作区隔离（重要）**
   - 使用企业A的账号创建工作流
   - 切换到企业B的账号
   - 验证看不到企业A的工作流
   - 验证只能看到系统工作流和企业B的工作流

2. **测试设置默认工作流**
   - 创建多个相同文档类型的工作流
   - 设置其中一个为默认
   - 验证其他工作流是否被禁用
   - 验证默认工作流是否被启用

3. **测试删除工作流**
   - 尝试删除默认工作流（应该失败）
   - 设置另一个工作流为默认
   - 再次尝试删除原工作流（应该成功）

4. **测试不同文档类型**
   - 创建不同文档类型的工作流（WPS、PQR、pPQR）
   - 验证设置默认只影响同一文档类型的工作流
   - 不同文档类型的工作流应该互不影响

5. **测试权限控制**
   - 尝试修改系统工作流（应该失败）
   - 尝试删除系统工作流（应该失败）
   - 验证只能操作本企业的工作流

## 注意事项

1. **数据一致性**
   - 同一文档类型在同一企业内只能有一个默认工作流
   - 默认工作流必须是启用状态

2. **用户体验**
   - 提供明确的确认提示
   - 显示详细的操作结果
   - 错误信息要清晰明了

3. **权限控制**
   - 只能操作自己企业的工作流
   - 不能修改系统默认工作流

## 相关文件

- `backend/app/api/v1/endpoints/approvals.py` - 后端API实现
- `frontend/src/pages/Workflow/ApprovalWorkflows.tsx` - 前端页面
- `backend/app/models/approval.py` - 数据模型定义

