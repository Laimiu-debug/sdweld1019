# 🚀 一键部署到云服务器

## 📋 服务器信息

- **服务器IP**: 43.142.188.252
- **操作系统**: Ubuntu 22.04
- **配置**: CPU 2核 / 内存 4GB / 硬盘 90GB
- **镜像**: Ubuntu Server 24.04 LTS 64bit
- **登录用户**: root

## 🎯 部署方式

### 方式一：使用自动化脚本（推荐）⭐

这是最简单的方式，一键完成所有操作！

#### 步骤：

1. **打开PowerShell**（在项目根目录右键 → "在终端中打开"）

2. **运行部署脚本**：
   ```powershell
   .\deploy-to-server.ps1
   ```

3. **等待完成**（大约5-10分钟）

脚本会自动完成：
- ✅ 配置SSH密钥
- ✅ 测试服务器连接
- ✅ 上传代码到服务器
- ✅ 安装Docker和docker-compose
- ✅ 构建并启动所有服务
- ✅ 验证部署结果

---

### 方式二：手动部署

如果自动化脚本遇到问题，可以手动执行以下步骤：

#### 1. 保存SSH密钥

创建文件 `server-key.pem`，内容为：
```
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDcOr08lnUObi+djGnoalQpZ+6MgRuhH9BXB2k4g/sAOYeqs/y4xzcmDsdqF3Www8f0OwEmaII39kLTh0iucu4GS0G8aSKqD9gw4cQ9msH2cWk9EKH9jQyiASUOh/uZy7mhg145WAP+fUQ9HMU4D1oavdUnGCr5xyVyc9cgFjKcQizXTVPqR0KqdF7r8D2q9vV+25CCwWtwOtY8gAGLafsPT/BTs8Av9PbCIU7iCuad6kq/N0/n/g5q5+eohumpIaD/6OaT4NhWo4+ClC4iKEVqvykTiV6XuJUL+8KahJD/0+tTfw2UhQzIwEE7JVU+x776Fb8YKvapjZOFzZWxIaTf skey-o3j71l2x
```

#### 2. 测试SSH连接

```powershell
ssh -i server-key.pem root@43.142.188.252
```

#### 3. 上传代码

**方法A：使用Git（推荐）**
```bash
# 在服务器上执行
cd /root
git clone <你的Git仓库地址> sdweld
cd sdweld
```

**方法B：使用SCP上传**
```powershell
# 在本地PowerShell执行
scp -i server-key.pem -r . root@43.142.188.252:/root/sdweld
```

#### 4. 在服务器上部署

```bash
# SSH登录服务器
ssh -i server-key.pem root@43.142.188.252

# 进入项目目录
cd /root/sdweld

# 安装Docker（如果未安装）
chmod +x install_docker.sh
./install_docker.sh

# 执行部署
chmod +x deploy.sh
./deploy.sh
```

---

## 🔧 部署前配置（重要）

### 1. 配置QQ邮箱授权码

编辑 `backend/.env.production` 文件，找到以下配置：

```env
# 邮件服务配置
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USER=2564786659@qq.com
SMTP_PASSWORD=你的QQ邮箱授权码  # ⚠️ 需要修改
SMTP_FROM=2564786659@qq.com
SMTP_FROM_NAME=焊接工艺管理系统
```

**获取QQ邮箱授权码的步骤：**

1. 登录 QQ邮箱 (https://mail.qq.com)
2. 点击 **设置** → **账户**
3. 找到 **POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务**
4. 开启 **IMAP/SMTP服务**
5. 点击 **生成授权码**
6. 按提示发送短信验证
7. 复制生成的16位授权码
8. 填入 `SMTP_PASSWORD` 字段

### 2. 域名解析配置

在你的域名服务商（腾讯云）添加以下DNS解析记录：

| 主机记录 | 记录类型 | 记录值 | TTL |
|---------|---------|--------|-----|
| @ | A | 43.142.188.252 | 600 |
| laimiu | A | 43.142.188.252 | 600 |
| api | A | 43.142.188.252 | 600 |

**验证域名解析：**
```powershell
ping sdhaohan.cn
ping laimiu.sdhaohan.cn
ping api.sdhaohan.cn
```

### 3. 安全组配置

确保在腾讯云控制台开放以下端口：

| 端口 | 协议 | 说明 |
|-----|------|------|
| 22 | TCP | SSH登录 |
| 80 | TCP | HTTP（用于SSL证书验证） |
| 443 | TCP | HTTPS |

---

## 📦 部署后访问

部署成功后，可以通过以下地址访问：

- **用户门户**: https://sdhaohan.cn
- **管理门户**: https://laimiu.sdhaohan.cn
- **后端API**: https://api.sdhaohan.cn
- **API文档**: https://api.sdhaohan.cn/api/v1/docs

---

## 🛠️ 常用运维命令

### 查看服务状态
```bash
ssh -i server-key.pem root@43.142.188.252 "cd /root/sdweld && docker-compose ps"
```

### 查看日志
```bash
# 查看所有服务日志
ssh -i server-key.pem root@43.142.188.252 "cd /root/sdweld && docker-compose logs -f"

# 查看后端日志
ssh -i server-key.pem root@43.142.188.252 "cd /root/sdweld && docker-compose logs -f backend"

# 查看前端日志
ssh -i server-key.pem root@43.142.188.252 "cd /root/sdweld && docker-compose logs -f frontend"
```

### 重启服务
```bash
# 重启所有服务
ssh -i server-key.pem root@43.142.188.252 "cd /root/sdweld && docker-compose restart"

# 重启单个服务
ssh -i server-key.pem root@43.142.188.252 "cd /root/sdweld && docker-compose restart backend"
```

### 停止服务
```bash
ssh -i server-key.pem root@43.142.188.252 "cd /root/sdweld && docker-compose down"
```

### 更新代码并重新部署
```bash
ssh -i server-key.pem root@43.142.188.252 "cd /root/sdweld && git pull && ./deploy.sh --rebuild"
```

---

## ❓ 常见问题

### 1. SSH连接失败

**问题**: `Permission denied (publickey)`

**解决方案**:
- 确保 `server-key.pem` 文件内容正确
- 检查文件权限（Windows下不需要特殊权限）
- 尝试使用密码登录（如果有密码）

### 2. Docker构建慢

**问题**: Docker镜像下载很慢

**解决方案**:
部署脚本会自动配置Docker镜像加速，如果还是很慢，可以手动配置：

```bash
# 在服务器上执行
mkdir -p /etc/docker
cat > /etc/docker/daemon.json <<EOF
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://mirror.ccs.tencentyun.com"
  ]
}
EOF
systemctl daemon-reload
systemctl restart docker
```

### 3. 端口被占用

**问题**: `port is already allocated`

**解决方案**:
```bash
# 查看端口占用
netstat -tulpn | grep :80
netstat -tulpn | grep :443

# 停止占用端口的进程
kill -9 <进程ID>
```

### 4. SSL证书申请失败

**问题**: Let's Encrypt证书申请失败

**解决方案**:
- 确保域名已正确解析到服务器IP
- 确保80端口可以访问
- 等待DNS解析生效（可能需要几分钟）

---

## 📞 技术支持

如果遇到问题，可以：

1. 查看部署日志
2. 检查服务器日志：`docker-compose logs -f`
3. 查看本文档的"常见问题"部分
4. 联系技术支持

---

## 🎉 部署成功标志

当你看到以下输出时，说明部署成功：

```
========================================
部署完成！
========================================

[SUCCESS] 用户门户: https://sdhaohan.cn
[SUCCESS] 管理门户: https://laimiu.sdhaohan.cn
[SUCCESS] 后端API: https://api.sdhaohan.cn
[SUCCESS] API文档: https://api.sdhaohan.cn/api/v1/docs
```

访问上述地址，如果能正常打开页面，说明部署成功！🎊

