# 外键级联删除问题修复指南

## 📋 问题说明

### 问题1：共享模块删除级联问题
当用户删除自己工作区的模块时，共享库中的副本也被删除。这违反了设计规范。

**期望行为**: 共享库中的模块应该是独立的副本，不应该因为用户删除原始模块而被删除。

### 问题2：模板删除导致文档无法编辑
当模板被删除后，基于该模板创建的 WPS/PQR/pPQR 文档无法编辑。

**期望行为**: 已创建的文档应该独立于模板，即使模板被删除也应该可以编辑。

---

## ✅ 修复内容

### 已修改的文件

1. **模型文件**:
   - `backend/app/models/shared_library.py` - 修复共享模块和模板的外键
   - `backend/app/models/wps.py` - 修复 WPS 的 template_id 外键
   - `backend/app/models/pqr.py` - 修复 PQR 的 template_id 外键
   - `backend/app/models/ppqr.py` - 修复 PPQR 的 template_id 外键

2. **数据库迁移**:
   - `backend/migrations/fix_foreign_key_cascade_issues.sql` - SQL 迁移脚本
   - `backend/run_foreign_key_fix_migration.py` - Python 迁移执行脚本

3. **测试脚本**:
   - `backend/test_foreign_key_fix.py` - 验证修复的测试脚本

---

## 🚀 部署步骤

### 步骤1: 执行数据库迁移

```bash
cd backend
python run_foreign_key_fix_migration.py
```

**说明**: 
- 脚本会提示确认是否执行迁移
- 输入 `yes` 或 `y` 确认执行
- 迁移完成后会显示验证结果

### 步骤2: 验证修复

```bash
python test_foreign_key_fix.py
```

**说明**:
- 测试脚本会创建测试数据并验证修复是否生效
- 所有测试通过后会显示成功消息
- 测试数据会自动清理

### 步骤3: 重启应用

```bash
# 重启后端服务以加载新的模型定义
# 具体命令取决于你的部署方式
```

---

## 🎯 修复后的行为

### 场景1: 删除工作区模块

**操作**: 用户删除自己工作区中的一个模块

**修复前**:
- ❌ 共享库中的副本也被删除
- ❌ 其他用户无法继续使用

**修复后**:
- ✅ 共享库中的副本保留
- ✅ `original_module_id` 设置为 `NULL`
- ✅ 其他用户可以继续下载和使用

### 场景2: 删除模板

**操作**: 用户删除一个 WPS 模板

**修复前**:
- ❌ 基于该模板创建的文档可能无法编辑

**修复后**:
- ✅ 已创建的 WPS/PQR/pPQR 文档不受影响
- ✅ `template_id` 设置为 `NULL`
- ✅ 文档数据完整保存在 `modules_data` 中
- ✅ 文档仍然可以正常编辑

---

## 🔧 前端需要的调整（可选）

### 处理 template_id 为 NULL 的情况

在编辑文档时，如果 `template_id` 为 `NULL`，直接使用 `modules_data` 渲染表单：

```typescript
// 编辑 WPS/PQR/pPQR 文档时
if (document.template_id) {
  // 模板存在，可以从模板加载
  const template = await fetchTemplate(document.template_id);
  renderFormFromTemplate(template);
} else {
  // 模板已被删除，直接从文档数据渲染
  renderFormFromModulesData(document.modules_data);
  
  // 可选：显示提示信息
  showWarning("此文档使用的模板已被删除，但文档数据完整，仍可正常编辑");
}
```

---

## 📊 技术细节

### 外键修改说明

1. **共享库外键** (`ondelete='CASCADE'` → `ondelete='SET NULL'`):
   - `shared_modules.original_module_id`
   - `shared_templates.original_template_id`

2. **文档模板外键** (新增外键 + `ondelete='SET NULL'`):
   - `wps.template_id`
   - `pqr.template_id`
   - `ppqr.template_id`

### 数据完整性保证

- 所有文档数据都保存在 `modules_data`/`module_data` 字段中
- 文档不依赖模板来保存数据
- 模板只是用于创建文档时的结构定义
- 删除模板不会影响已创建文档的数据完整性

---

## ⚠️ 注意事项

1. **备份数据库**: 在执行迁移前，建议备份数据库
2. **测试环境**: 建议先在测试环境执行迁移和验证
3. **前端兼容**: 前端需要处理 `template_id` 为 `NULL` 的情况
4. **用户通知**: 可以考虑通知用户此次更新的改进

---

## 📞 问题排查

### 迁移失败

如果迁移失败，检查：
1. 数据库连接是否正常
2. 是否有足够的权限修改表结构
3. 查看错误日志获取详细信息

### 测试失败

如果测试失败，检查：
1. 迁移是否成功执行
2. 外键约束是否正确设置为 `SET NULL`
3. 查看测试输出的详细错误信息

---

## 📚 相关文档

- 详细修复报告: `backend/FOREIGN_KEY_CASCADE_FIX_REPORT.md`
- SQL 迁移脚本: `backend/migrations/fix_foreign_key_cascade_issues.sql`
- 测试脚本: `backend/test_foreign_key_fix.py`

---

## ✅ 验证清单

部署前检查：
- [ ] 已备份数据库
- [ ] 已在测试环境验证
- [ ] 已阅读修复报告

部署步骤：
- [ ] 执行数据库迁移
- [ ] 运行测试验证
- [ ] 重启应用服务
- [ ] 前端调整（如需要）
- [ ] 用户验收测试

---

## 🎉 总结

本次修复解决了两个关键问题：

1. ✅ **共享库独立性**: 共享库中的资源现在是真正独立的副本
2. ✅ **文档编辑独立性**: 已创建的文档不再依赖模板，可以永久编辑

这些修复提升了系统的数据完整性和用户体验，符合设计规范。

