# 公告筛选功能文档

## 功能概述

系统现在支持区分**手动创建的公告**和**系统自动生成的公告**，并提供筛选功能。

## 数据库变更

### 新增字段

在`system_announcements`表中添加了新字段：

```sql
is_auto_generated BOOLEAN DEFAULT FALSE
```

- `TRUE`: 系统自动生成的公告（如会员到期提醒、配额警告等）
- `FALSE`: 管理员手动创建的公告

## API变更

### GET /api/v1/admin/system/announcements

**新增查询参数：**

- `is_auto_generated` (可选): 布尔值
  - `true`: 只返回系统自动生成的公告
  - `false`: 只返回手动创建的公告
  - 不传: 返回所有公告

**示例请求：**

```bash
# 获取所有手动创建的公告
GET /api/v1/admin/system/announcements?is_auto_generated=false

# 获取所有自动生成的公告
GET /api/v1/admin/system/announcements?is_auto_generated=true

# 获取所有公告
GET /api/v1/admin/system/announcements
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "title": "系统维护通知",
        "content": "...",
        "is_auto_generated": false,
        "is_published": true,
        ...
      },
      {
        "id": 2,
        "title": "🔔 会员即将到期提醒",
        "content": "...",
        "is_auto_generated": true,
        "is_published": true,
        ...
      }
    ],
    "total": 2,
    "page": 1,
    "page_size": 20
  }
}
```

## 前端UI变更

### 公告管理页面

**新增筛选选项：**

在公告列表页面添加了"公告来源"筛选下拉框：

- **手动创建**: 只显示管理员手动创建的公告
- **自动生成**: 只显示系统自动生成的公告
- **全部**: 显示所有公告（默认）

**新增表格列：**

在公告列表表格中添加了"来源"列：

- 🟢 **手动创建**: 绿色标签
- 🔵 **系统自动**: 蓝色标签

## 自动生成公告的类型

系统会自动生成以下类型的公告：

### 1. 会员到期提醒

- **触发时机**: 订阅到期前7天、3天、1天
- **目标受众**: 即将到期的用户
- **标记**: `is_auto_generated=true`

### 2. 会员过期通知

- **触发时机**: 订阅过期后
- **目标受众**: 过期用户
- **标记**: `is_auto_generated=true`

### 3. 配额使用警告

- **触发时机**: 配额使用达到80%、90%、100%
- **目标受众**: 配额即将用完的用户
- **标记**: `is_auto_generated=true`

### 4. 异常登录通知

- **触发时机**: 检测到异常登录行为
- **目标受众**: 相关用户
- **标记**: `is_auto_generated=true`

### 5. 密码修改通知

- **触发时机**: 用户修改密码后
- **目标受众**: 相关用户
- **标记**: `is_auto_generated=true`

## 使用场景

### 场景1: 查看所有手动创建的公告

管理员想要查看和管理自己创建的公告，不包括系统自动生成的通知。

**操作步骤：**
1. 进入"公告管理"页面
2. 在"公告来源"下拉框中选择"手动创建"
3. 列表将只显示手动创建的公告

### 场景2: 查看系统自动生成的通知

管理员想要查看系统自动发送的通知，了解用户收到了哪些自动提醒。

**操作步骤：**
1. 进入"公告管理"页面
2. 在"公告来源"下拉框中选择"自动生成"
3. 列表将只显示系统自动生成的公告

### 场景3: 查看所有公告

管理员想要查看所有公告，包括手动创建和自动生成的。

**操作步骤：**
1. 进入"公告管理"页面
2. 确保"公告来源"下拉框为空或选择"全部"
3. 列表将显示所有公告

## 技术实现

### 后端

**文件**: `backend/app/api/v1/endpoints/system_admin.py`

```python
@router.get("/announcements")
async def get_announcements_admin(
    is_auto_generated: Optional[bool] = Query(None, description="是否为自动生成"),
    ...
):
    query = db.query(SystemAnnouncement)
    
    if is_auto_generated is not None:
        query = query.filter(SystemAnnouncement.is_auto_generated == is_auto_generated)
    
    ...
```

### 前端

**文件**: `admin-portal/src/pages/AnnouncementManagement.tsx`

```typescript
// 筛选状态
const [filterAutoGenerated, setFilterAutoGenerated] = useState<boolean | undefined>(undefined);

// 加载公告时传递筛选参数
const data = await getAnnouncements({
  page,
  page_size: pageSize,
  is_auto_generated: filterAutoGenerated,
});

// UI筛选下拉框
<Select
  placeholder="公告来源"
  style={{ width: 140 }}
  allowClear
  value={filterAutoGenerated}
  onChange={setFilterAutoGenerated}
>
  <Select.Option value={false}>手动创建</Select.Option>
  <Select.Option value={true}>自动生成</Select.Option>
</Select>
```

## 注意事项

1. **历史数据**: 在添加`is_auto_generated`字段之前创建的公告，该字段默认为`FALSE`（手动创建）
2. **权限控制**: 目前所有管理员都可以查看和筛选公告，未来可以根据需要添加更细粒度的权限控制
3. **删除限制**: 系统自动生成的公告可以被删除，但建议谨慎操作
4. **编辑限制**: 系统自动生成的公告可以被编辑，但编辑后仍保持`is_auto_generated=true`标记

## 未来改进

1. **分页优化**: 为手动创建和自动生成的公告提供独立的分页
2. **批量操作**: 支持批量删除自动生成的过期公告
3. **统计信息**: 在页面顶部显示手动创建和自动生成公告的数量统计
4. **通知去重**: 避免向同一用户重复发送相同类型的通知

