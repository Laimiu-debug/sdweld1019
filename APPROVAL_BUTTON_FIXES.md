# 审批按钮功能修复说明

## 修复的问题

### 问题1: PQR/pPQR被拒绝后没有"重新提交"按钮
**现象**: WPS被拒绝后显示"重新提交"按钮，但PQR/pPQR只显示"提交审批"

**原因**: ApprovalButton组件没有区分首次提交和重新提交的场景

**修复**: 
- 在ApprovalButton组件中添加`canResubmit`逻辑
- 当`status === 'rejected'`或`status === 'returned'`时，显示"重新提交"按钮
- 其他情况显示"提交审批"按钮

### 问题2: 被拒绝/退回后无法取消审批
**现象**: 审批被拒绝或退回后，"取消审批"按钮消失或不可用

**原因**: `canCancel`逻辑只检查是否是提交人，没有考虑审批状态

**修复**:
- 添加`showCancelButton`逻辑
- 只有`status === 'approved'`（已批准）时才隐藏取消按钮
- 其他状态（待审批、审批中、已拒绝、已退回）都可以取消

## 修改的文件

### 1. frontend/src/components/Approval/ApprovalButton.tsx

#### 修改内容：

```tsx
// 新增逻辑判断
const canResubmit = status === 'rejected' || status === 'returned';
const showCancelButton = canCancel && status !== 'approved';

// 修改按钮显示逻辑
{canSubmit && !canResubmit && (
  <Button>提交审批</Button>
)}

{canResubmit && (
  <Button>重新提交</Button>
)}

{showCancelButton && (
  <Button>取消审批</Button>
)}
```

#### 逻辑说明：

| 审批状态 | 提交按钮 | 取消按钮 | 说明 |
|---------|---------|---------|------|
| draft | 提交审批 | - | 首次提交 |
| pending | - | 取消审批 | 待审批，可取消 |
| in_progress | - | 取消审批 | 审批中，可取消 |
| rejected | 重新提交 | 取消审批 | 已拒绝，可重新提交或取消 |
| returned | 重新提交 | 取消审批 | 已退回，可重新提交或取消 |
| approved | - | - | 已批准，不可取消 |
| cancelled | - | - | 已取消 |

### 2. frontend/src/pages/PQR/PQRList.tsx

#### 修改内容：
- 添加`SendOutlined`图标导入

### 3. frontend/src/pages/pPQR/PPQRList.tsx

#### 修改内容：
- 添加`SendOutlined`图标导入

## 审批状态流转

```
草稿(draft)
    ↓ 提交审批
待审批(pending)
    ↓ 开始审批
审批中(in_progress)
    ↓
    ├─→ 批准(approved) ✓ 结束
    ├─→ 拒绝(rejected) → 重新提交 → 待审批
    ├─→ 退回(returned) → 重新提交 → 待审批
    └─→ 取消(cancelled) ✓ 结束
```

## 按钮显示规则

### 提交/重新提交按钮
- **显示条件**: `canSubmit === true` 或处于被拒绝/退回状态
- **按钮文本**:
  - 首次提交: "提交审批"
  - 被拒绝后: "重新提交"
  - 被退回后: "重新提交"

### 审批操作按钮（批准/拒绝/退回）
- **显示条件**: `canApprove === true`
- **适用状态**: pending, in_progress
- **权限要求**: 当前用户是审批人

### 取消审批按钮
- **显示条件**: `canCancel === true` 且 `status !== 'approved'`
- **适用状态**: pending, in_progress, rejected, returned
- **权限要求**: 当前用户是提交人
- **不显示情况**: 已批准状态

## 用户体验改进

### 改进前：
❌ 被拒绝后只显示"提交审批"，用户不清楚这是重新提交
❌ 被拒绝/退回后无法取消审批，只能重新提交
❌ 已批准后仍可取消审批（不合理）

### 改进后：
✅ 被拒绝/退回后显示"重新提交"，语义更清晰
✅ 被拒绝/退回后可以选择重新提交或取消审批
✅ 已批准后不能取消审批（符合业务逻辑）

## 业务逻辑说明

### 为什么已批准不能取消？
1. **合规性**: 已批准的文档具有法律效力，不应随意取消
2. **可追溯性**: 保持审批记录的完整性
3. **业务流程**: 如需修改已批准的文档，应通过版本管理或作废流程

### 为什么被拒绝/退回可以取消？
1. **灵活性**: 文档可能需要大幅修改，暂时不重新提交
2. **状态管理**: 避免文档一直处于被拒绝状态
3. **用户体验**: 给用户更多选择权

### 重新提交 vs 取消审批
- **重新提交**: 修改后再次进入审批流程
- **取消审批**: 放弃当前审批，文档回到草稿状态

## 测试场景

### 场景1: 首次提交审批
1. 创建新PQR文档（草稿状态）
2. 点击"提交审批"按钮
3. 填写备注，提交
4. 验证状态变为"待审批"

### 场景2: 审批被拒绝后重新提交
1. 审批人拒绝PQR
2. 提交人看到"重新提交"按钮和"取消审批"按钮
3. 点击"重新提交"
4. 填写备注，提交
5. 验证状态变为"待审批"

### 场景3: 审批被退回后重新提交
1. 审批人退回PQR
2. 提交人看到"重新提交"按钮和"取消审批"按钮
3. 点击"重新提交"
4. 验证状态变为"待审批"

### 场景4: 被拒绝后取消审批
1. 审批人拒绝PQR
2. 提交人点击"取消审批"
3. 填写取消原因
4. 验证状态变为"已取消"

### 场景5: 已批准后不能取消
1. 审批人批准PQR
2. 提交人查看文档
3. 验证"取消审批"按钮不显示

### 场景6: 审批中可以取消
1. PQR处于审批中状态
2. 提交人点击"取消审批"
3. 验证可以成功取消

## 与WPS的一致性

现在PQR和pPQR的审批按钮行为与WPS完全一致：

✅ 被拒绝后显示"重新提交"按钮
✅ 被拒绝/退回后可以取消审批
✅ 已批准后不能取消审批
✅ 按钮文本和图标一致
✅ 交互逻辑一致

## 注意事项

1. **状态同步**: 确保后端返回正确的`approval_status`字段
2. **权限检查**: `canCancel`由后端根据`submitter_id`判断
3. **状态值**: 确保使用正确的状态值（rejected, returned, approved等）
4. **刷新数据**: 操作成功后调用`onSuccess()`刷新列表

## 后续优化建议

1. **状态提示**: 在Alert组件中也添加action按钮（像WPS那样）
2. **操作确认**: 重要操作添加二次确认
3. **操作日志**: 记录所有审批操作的详细日志
4. **通知提醒**: 状态变更时发送通知给相关人员

