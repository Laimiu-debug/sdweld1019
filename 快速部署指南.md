# 🚀 快速部署指南

## ✅ 已完成的准备工作

恭喜！以下配置已经全部完成：

- ✅ **QQ 邮箱授权码**: 已配置
- ✅ **环境变量**: `backend/.env.production` 已配置完成
- ✅ **管理员账号**: 已设置
- ✅ **域名规划**: sdhaohan.cn, laimiu.sdhaohan.cn, api.sdhaohan.cn
- ✅ **Docker 配置**: 所有 Dockerfile 和 docker-compose.yml 已就绪
- ✅ **Nginx 配置**: 反向代理和 SSL 配置已完成
- ✅ **部署脚本**: deploy.sh 已准备好

---

## 🎯 现在只需要 3 步！

### 第 1 步：配置 DNS 解析 (5分钟)

登录腾讯云 DNS 控制台，添加以下 A 记录：

| 主机记录 | 记录类型 | 记录值 | TTL |
|---------|---------|--------|-----|
| @ | A | 43.142.188.252 | 600 |
| laimiu | A | 43.142.188.252 | 600 |
| api | A | 43.142.188.252 | 600 |

**验证 DNS 解析**：
```bash
ping sdhaohan.cn
ping laimiu.sdhaohan.cn
ping api.sdhaohan.cn
```

所有域名都应该返回 `43.142.188.252`

⏰ **等待时间**: DNS 解析通常需要 5-10 分钟生效

---

### 第 2 步：上传代码到服务器 (2分钟)

#### 方式 A: 使用 Git（推荐）

```bash
# 1. 在本地提交代码
git add .
git commit -m "Ready for deployment"
git push

# 2. SSH 登录服务器
ssh root@43.142.188.252

# 3. 克隆代码
git clone <你的仓库地址>
cd <项目目录>
```

#### 方式 B: 使用 SCP 上传

```bash
# 在本地电脑执行（PowerShell）
scp -r .\ root@43.142.188.252:/root/welding-system/
```

---

### 第 3 步：运行部署脚本 (10分钟)

```bash
# 1. SSH 登录服务器（如果还没登录）
ssh root@43.142.188.252

# 2. 进入项目目录
cd /root/welding-system  # 或你的项目目录

# 3. 给脚本添加执行权限
chmod +x deploy.sh
chmod +x create_default_admin.sh

# 4. 运行部署脚本
./deploy.sh
```

**部署脚本会自动完成**：
- ✅ 检查环境（Docker, Docker Compose）
- ✅ 构建所有 Docker 镜像
- ✅ 启动所有服务（PostgreSQL, Redis, Backend, Frontend, Admin Portal, Nginx）
- ✅ 运行数据库迁移
- ✅ 申请 SSL 证书（Let's Encrypt）
- ✅ 配置 Nginx 反向代理

**创建管理员账号**：

部署脚本会询问是否创建管理员账号，选择 `y`，然后输入：
- 邮箱: `Laimiu.new@gmail.com`
- 密码: `ghzzz123`

或者使用自动化脚本：
```bash
./create_default_admin.sh
```

---

## 🎉 部署完成！

部署成功后，你会看到：

```
========================================
部署完成！
========================================

用户门户: https://sdhaohan.cn
管理门户: https://laimiu.sdhaohan.cn
后端API: https://api.sdhaohan.cn
API文档: https://api.sdhaohan.cn/api/v1/docs
```

---

## ✅ 验证部署

### 1. 检查服务状态

```bash
docker-compose ps
```

所有服务应该都是 `Up` 状态：
```
NAME                STATUS
postgres            Up (healthy)
redis               Up (healthy)
backend             Up (healthy)
frontend            Up
admin-portal        Up
nginx               Up
certbot             Up
```

### 2. 访问网站

#### 用户门户
打开浏览器访问: https://sdhaohan.cn
- [ ] 页面正常加载
- [ ] HTTPS 证书有效（绿色锁图标）
- [ ] 可以注册账号
- [ ] 可以收到验证码邮件

#### 管理门户
打开浏览器访问: https://laimiu.sdhaohan.cn
- [ ] 页面正常加载
- [ ] HTTPS 证书有效
- [ ] 使用以下账号登录：
  - 邮箱: `Laimiu.new@gmail.com`
  - 密码: `ghzzz123`

#### API 文档
打开浏览器访问: https://api.sdhaohan.cn/api/v1/docs
- [ ] Swagger 文档正常显示
- [ ] 可以测试 API 接口

### 3. 测试邮件功能

在用户门户注册一个新账号，检查是否能收到验证码邮件。

---

## 📊 服务器信息

### 连接信息
- **IP 地址**: 43.142.188.252
- **SSH 登录**: `ssh root@43.142.188.252`
- **操作系统**: Ubuntu 22.04 + Docker

### 域名信息
- **用户门户**: https://sdhaohan.cn
- **管理门户**: https://laimiu.sdhaohan.cn
- **后端 API**: https://api.sdhaohan.cn

### 管理员账号
- **邮箱**: Laimiu.new@gmail.com
- **密码**: ghzzz123

### 数据库信息
- **数据库**: weld_db
- **用户**: weld_user
- **密码**: WeldDB@2024#Secure!Pass
- **端口**: 5432（仅容器内部访问）

### Redis 信息
- **密码**: Redis@2024#Strong!Key
- **端口**: 6379（仅容器内部访问）

---

## 🛠️ 常用命令

### 查看日志
```bash
# 查看所有服务日志
docker-compose logs -f

# 查看后端日志
docker-compose logs -f backend

# 查看 Nginx 日志
docker-compose logs -f nginx

# 查看最近 100 行日志
docker-compose logs --tail=100
```

### 重启服务
```bash
# 重启所有服务
docker-compose restart

# 重启单个服务
docker-compose restart backend
docker-compose restart nginx
```

### 停止和启动
```bash
# 停止所有服务
docker-compose down

# 启动所有服务
docker-compose up -d

# 重新构建并启动
docker-compose up -d --build
```

### 数据库管理
```bash
# 进入数据库
docker-compose exec postgres psql -U weld_user -d weld_db

# 备份数据库
docker-compose exec postgres pg_dump -U weld_user weld_db > backup_$(date +%Y%m%d_%H%M%S).sql

# 恢复数据库
docker-compose exec -T postgres psql -U weld_user -d weld_db < backup.sql
```

### SSL 证书管理
```bash
# 手动续期证书
docker-compose run --rm certbot renew

# 重新申请证书
docker-compose run --rm certbot certonly --webroot \
    --webroot-path=/var/www/certbot \
    --email 2564786659@qq.com \
    --agree-tos \
    -d sdhaohan.cn

# 重启 Nginx 加载新证书
docker-compose restart nginx
```

---

## ❓ 常见问题

### Q1: SSL 证书申请失败？
**原因**: DNS 解析未生效或端口未开放

**解决方法**:
1. 确认 DNS 已解析: `ping sdhaohan.cn`
2. 确认端口 80 已开放
3. 等待 5-10 分钟后重试

### Q2: 无法访问网站（502 Bad Gateway）？
**原因**: 后端服务未启动

**解决方法**:
```bash
# 查看后端日志
docker-compose logs backend

# 重启后端服务
docker-compose restart backend
```

### Q3: 邮件发送失败？
**原因**: QQ 邮箱授权码错误或 SMTP 配置问题

**解决方法**:
1. 检查 `backend/.env.production` 中的 `SMTP_PASSWORD`
2. 查看后端日志: `docker-compose logs backend | grep -i smtp`
3. 重启后端服务: `docker-compose restart backend`

### Q4: 前端页面空白？
**原因**: 前端构建失败或 API 地址配置错误

**解决方法**:
```bash
# 查看前端日志
docker-compose logs frontend
docker-compose logs admin-portal

# 重新构建前端
docker-compose up -d --build frontend admin-portal
```

### Q5: 数据库连接失败？
**原因**: PostgreSQL 服务未启动或密码错误

**解决方法**:
```bash
# 查看数据库状态
docker-compose ps postgres

# 查看数据库日志
docker-compose logs postgres

# 重启数据库
docker-compose restart postgres
```

---

## 📞 获取帮助

如果遇到问题，请：

1. **查看日志**: `docker-compose logs -f`
2. **查看文档**: 
   - `DEPLOYMENT_GUIDE.md` - 详细部署指南
   - `DEPLOYMENT_CHECKLIST.md` - 检查清单
   - `QUICK_DEPLOY.md` - 快速参考
3. **检查服务状态**: `docker-compose ps`

---

## 🎊 下一步

部署成功后，你可以：

1. ✅ 登录管理门户，熟悉系统功能
2. ✅ 创建企业工作空间
3. ✅ 添加用户和角色
4. ✅ 创建 WPS/PQR 文档
5. ✅ 配置系统设置

**祝你使用愉快！** 🚀

---

**部署时间**: 预计 15-20 分钟  
**难度**: ⭐⭐☆☆☆ (简单)  
**准备状态**: ✅ 已就绪，随时可以部署！

