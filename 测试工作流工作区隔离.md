# 测试工作流工作区隔离

## 测试目的
验证工作流的工作区隔离是否正常工作，确保不同企业之间的工作流互不可见。

## 测试前准备

### 1. 确认数据库中的工作流数据
```sql
-- 查看所有工作流
SELECT 
    id,
    name,
    code,
    document_type,
    company_id,
    is_default,
    is_active,
    created_by
FROM approval_workflow_definitions
ORDER BY company_id, document_type, id;
```

**预期结果：**
- `company_id IS NULL` 的是系统工作流
- `company_id = 1` 的是企业1的工作流
- `company_id = 2` 的是企业2的工作流

### 2. 准备测试账号
- 企业A的账号（例如：企业ID=1）
- 企业B的账号（例如：企业ID=2）
- 个人账号（没有加入企业）

## 测试步骤

### 测试1：企业A查看工作流列表

**操作：**
1. 使用企业A的账号登录
2. 进入"审批工作流管理"页面
3. 查看工作流列表

**预期结果：**
- ✅ 能看到系统工作流（`company_id IS NULL`）
- ✅ 能看到企业A的工作流（`company_id = 企业A的ID`）
- ❌ 看不到企业B的工作流（`company_id = 企业B的ID`）

**验证方法：**
打开浏览器开发者工具，查看网络请求：
```
GET /api/v1/approvals/workflows
```

查看响应数据，确认只包含系统工作流和企业A的工作流。

### 测试2：企业A创建工作流

**操作：**
1. 使用企业A的账号
2. 点击"创建工作流"
3. 填写工作流信息：
   - 名称：企业A测试工作流
   - 代码：company_a_test_workflow
   - 文档类型：WPS
   - 添加审批步骤
4. 保存

**预期结果：**
- ✅ 创建成功
- ✅ 新工作流的 `company_id` 应该是企业A的ID
- ✅ 在工作流列表中能看到新创建的工作流

**验证SQL：**
```sql
SELECT id, name, code, company_id, created_by
FROM approval_workflow_definitions
WHERE code = 'company_a_test_workflow';
```

### 测试3：企业B查看工作流列表

**操作：**
1. 切换到企业B的账号登录
2. 进入"审批工作流管理"页面
3. 查看工作流列表

**预期结果：**
- ✅ 能看到系统工作流
- ✅ 能看到企业B的工作流（如果有）
- ❌ **看不到企业A刚创建的工作流**（这是关键！）

**验证方法：**
在工作流列表中搜索"企业A测试工作流"，应该找不到。

### 测试4：企业B尝试操作企业A的工作流（通过API）

**操作：**
1. 使用企业B的账号
2. 获取企业A工作流的ID（从数据库或企业A的账号中获取）
3. 尝试通过API删除企业A的工作流

**测试API：**
```bash
# 假设企业A的工作流ID是123
DELETE /api/v1/approvals/workflows/123
```

**预期结果：**
- ❌ 删除失败
- 返回错误：`403 Forbidden - 无权删除此工作流`

### 测试5：企业A删除自己的工作流

**操作：**
1. 使用企业A的账号
2. 如果要删除的工作流是默认工作流：
   - 先创建另一个工作流
   - 将新工作流设置为默认
3. 删除原工作流

**预期结果：**
- ✅ 删除成功
- ✅ 工作流从列表中消失

### 测试6：个人账号查看工作流列表

**操作：**
1. 使用个人账号登录（没有加入任何企业）
2. 进入"审批工作流管理"页面

**预期结果：**
- ✅ 只能看到系统工作流
- ❌ 看不到任何企业的工作流
- ❌ 没有"创建工作流"按钮（个人账号不能创建）

## 测试检查点

### 后端日志检查

修复后的代码添加了详细的日志，查看后端日志应该能看到：

```
[获取工作流列表] 用户ID: 1
[获取工作流列表] 工作区类型: enterprise
[获取工作流列表] 企业ID: 1
[获取工作流列表] 查询到 3 个工作流
```

### 数据库查询验证

**查询企业A应该看到的工作流：**
```sql
SELECT id, name, code, company_id
FROM approval_workflow_definitions
WHERE company_id IS NULL  -- 系统工作流
   OR company_id = 1      -- 企业A的工作流（假设企业A的ID是1）
ORDER BY company_id, id;
```

**查询企业B应该看到的工作流：**
```sql
SELECT id, name, code, company_id
FROM approval_workflow_definitions
WHERE company_id IS NULL  -- 系统工作流
   OR company_id = 2      -- 企业B的工作流（假设企业B的ID是2）
ORDER BY company_id, id;
```

## 常见问题排查

### 问题1：仍然能看到其他企业的工作流

**可能原因：**
- 后端代码没有重启
- 修改没有生效

**解决方法：**
1. 重启后端服务
2. 清除浏览器缓存
3. 检查后端日志，确认使用的是新代码

### 问题2：删除工作流时提示"无权删除"

**可能原因：**
1. 该工作流是系统工作流（`company_id IS NULL`）
2. 该工作流属于其他企业
3. 该工作流是默认工作流（`is_default=True`）

**解决方法：**
- 检查工作流的 `company_id` 是否与当前企业ID匹配
- 如果是默认工作流，先设置其他工作流为默认
- 查看后端日志，确认具体的失败原因

### 问题3：设置默认工作流后，其他工作流没有被禁用

**可能原因：**
- 后端代码没有更新

**解决方法：**
1. 检查后端代码是否包含最新的修改
2. 查看后端日志，确认执行了禁用操作
3. 刷新页面，查看工作流状态

## 测试通过标准

所有以下条件都满足才算测试通过：

- ✅ 企业A只能看到系统工作流和企业A的工作流
- ✅ 企业B只能看到系统工作流和企业B的工作流
- ✅ 企业A不能删除/修改企业B的工作流
- ✅ 企业B不能删除/修改企业A的工作流
- ✅ 个人账号只能看到系统工作流
- ✅ 设置默认工作流时，其他同类型工作流被自动禁用
- ✅ 不能删除默认工作流（需要先设置其他工作流为默认）
- ✅ 不能删除/修改系统工作流

## 回归测试

修复后需要确保以下功能仍然正常：

1. ✅ 创建工作流
2. ✅ 编辑工作流
3. ✅ 删除工作流
4. ✅ 设置默认工作流
5. ✅ 启用/禁用工作流
6. ✅ 查看工作流详情
7. ✅ 工作流在审批流程中的使用

