# WPSç®¡ç†æ¨¡å— - å¼€å‘æŒ‡å—

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### åŠŸèƒ½å®šä½
WPS (Welding Procedure Specification) ç®¡ç†æ¨¡å—æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œç”¨äºç®¡ç†ç„Šæ¥å·¥è‰ºè§„ç¨‹ï¼ŒåŒ…æ‹¬å·¥è‰ºå‚æ•°ç»´æŠ¤ã€ç‰ˆæœ¬æ§åˆ¶ã€å®¡æ‰¹æµç¨‹ç­‰ã€‚

### é€‚ç”¨åœºæ™¯
- åˆ›å»ºå’Œç»´æŠ¤ç„Šæ¥å·¥è‰ºè§„ç¨‹
- ç®¡ç†å·¥è‰ºå‚æ•°å’ŒæŠ€æœ¯è¦æ±‚
- å·¥è‰ºæ–‡ä»¶çš„ç‰ˆæœ¬æ§åˆ¶
- å·¥è‰ºè¯„å®¡å’Œæ‰¹å‡†æµç¨‹
- å·¥è‰ºæ–‡ä»¶çš„å¯¼å‡ºå’Œæ‰“å°

### å¼€å‘ä¼˜å…ˆçº§
**ç¬¬ä¸€é˜¶æ®µ** - æ ¸å¿ƒåŠŸèƒ½ï¼Œç«‹å³å¼€å‘

---

## ğŸ¯ ä¼šå‘˜æƒé™

### è®¿é—®æƒé™
| ä¼šå‘˜ç­‰çº§ | è®¿é—®æƒé™ | æ•°é‡é™åˆ¶ | åŠŸèƒ½èŒƒå›´ |
|---------|---------|---------|---------|
| æ¸¸å®¢æ¨¡å¼ | âœ… å¯è®¿é—® | 0 (ä»…æŸ¥çœ‹ç¤ºä¾‹) | åªè¯»æŸ¥çœ‹ç¤ºä¾‹æ•°æ® |
| ä¸ªäººå…è´¹ç‰ˆ | âœ… å¯è®¿é—® | æœ€å¤š 10 ä¸ª | åŸºç¡€å¢åˆ æ”¹æŸ¥ |
| ä¸ªäººä¸“ä¸šç‰ˆ | âœ… å¯è®¿é—® | æœ€å¤š 30 ä¸ª | åŸºç¡€åŠŸèƒ½ + å¯¼å‡ºå¯¼å…¥ |
| ä¸ªäººé«˜çº§ç‰ˆ | âœ… å¯è®¿é—® | æœ€å¤š 50 ä¸ª | å®Œæ•´åŠŸèƒ½ + å®¡æ‰¹æµç¨‹ |
| ä¸ªäººæ——èˆ°ç‰ˆ | âœ… å¯è®¿é—® | æœ€å¤š 100 ä¸ª | å®Œæ•´åŠŸèƒ½ + é«˜çº§ç‰¹æ€§ |
| ä¼ä¸šç‰ˆ | âœ… å¯è®¿é—® | æœ€å¤š 200 ä¸ª | å®Œæ•´åŠŸèƒ½ + ä¼ä¸šåä½œ |
| ä¼ä¸šPRO | âœ… å¯è®¿é—® | æœ€å¤š 400 ä¸ª | å®Œæ•´åŠŸèƒ½ + ä¼ä¸šåä½œ |
| ä¼ä¸šPRO MAX | âœ… å¯è®¿é—® | æœ€å¤š 500 ä¸ª | å®Œæ•´åŠŸèƒ½ + ä¼ä¸šåä½œ |

**æ¸¸å®¢æ¨¡å¼è¯´æ˜**:
- æ¸¸å®¢ä»…å¯æŸ¥çœ‹ç³»ç»Ÿé¢„è®¾çš„ç¤ºä¾‹ WPS æ•°æ®
- æ— æ³•åˆ›å»ºã€ä¿®æ”¹æˆ–åˆ é™¤ä»»ä½•æ•°æ®
- æ— æ³•ä¿å­˜ä»»ä½•æ“ä½œ
- ç”¨äºä½“éªŒç³»ç»ŸåŠŸèƒ½å’Œç•Œé¢

### åŠŸèƒ½æƒé™çŸ©é˜µ
| åŠŸèƒ½ | å…è´¹ç‰ˆ | ä¸“ä¸šç‰ˆ | é«˜çº§ç‰ˆ | æ——èˆ°ç‰ˆ | ä¼ä¸šç‰ˆ |
|------|--------|--------|--------|--------|--------|
| åˆ›å»º WPS | âœ… | âœ… | âœ… | âœ… | âœ… |
| ç¼–è¾‘ WPS | âœ… | âœ… | âœ… | âœ… | âœ… |
| åˆ é™¤ WPS | âœ… | âœ… | âœ… | âœ… | âœ… |
| æŸ¥çœ‹ WPS | âœ… | âœ… | âœ… | âœ… | âœ… |
| å¯¼å‡º PDF | âŒ | âœ… | âœ… | âœ… | âœ… |
| å¯¼å‡º Excel | âŒ | âœ… | âœ… | âœ… | âœ… |
| æ‰¹é‡å¯¼å…¥ | âŒ | âœ… | âœ… | âœ… | âœ… |
| ç‰ˆæœ¬æ§åˆ¶ | âŒ | âœ… | âœ… | âœ… | âœ… |
| å®¡æ‰¹æµç¨‹ | âŒ | âŒ | âœ… | âœ… | âœ… |
| æ¨¡æ¿ç®¡ç† | âŒ | âŒ | âœ… | âœ… | âœ… |
| é«˜çº§æœç´¢ | âŒ | âŒ | âœ… | âœ… | âœ… |
| æ‰¹é‡æ“ä½œ | âŒ | âŒ | âŒ | âœ… | âœ… |

---

## ğŸ“Š åŠŸèƒ½æ¸…å•

### 1. WPS åŸºç¡€ç®¡ç†
- **åˆ›å»º WPS**: å¡«å†™å®Œæ•´çš„å·¥è‰ºå‚æ•°è¡¨å•
- **ç¼–è¾‘ WPS**: ä¿®æ”¹ç°æœ‰ WPS è®°å½•
- **åˆ é™¤ WPS**: è½¯åˆ é™¤ï¼Œæ”¯æŒæ¢å¤
- **æŸ¥çœ‹ WPS**: è¯¦ç»†ä¿¡æ¯å±•ç¤º
- **å¤åˆ¶ WPS**: åŸºäºç°æœ‰ WPS åˆ›å»ºæ–°è®°å½•
- **æœç´¢ WPS**: æŒ‰ç¼–å·ã€æ ‡é¢˜ã€çŠ¶æ€ç­‰æœç´¢
- **ç­›é€‰ WPS**: æŒ‰çŠ¶æ€ã€æ ‡å‡†ã€æ—¥æœŸç­‰ç­›é€‰
- **æ’åº WPS**: æŒ‰åˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´ç­‰æ’åº

### 2. ç‰ˆæœ¬æ§åˆ¶ï¼ˆä¸“ä¸šç‰ˆåŠä»¥ä¸Šï¼‰
- **ç‰ˆæœ¬å†å²**: æŸ¥çœ‹æ‰€æœ‰å†å²ç‰ˆæœ¬
- **ç‰ˆæœ¬å¯¹æ¯”**: å¯¹æ¯”ä¸åŒç‰ˆæœ¬çš„å·®å¼‚
- **ç‰ˆæœ¬å›æ»š**: æ¢å¤åˆ°å†å²ç‰ˆæœ¬
- **ç‰ˆæœ¬æ ‡ç­¾**: ä¸ºé‡è¦ç‰ˆæœ¬æ·»åŠ æ ‡ç­¾

### 3. å®¡æ‰¹æµç¨‹ï¼ˆé«˜çº§ç‰ˆåŠä»¥ä¸Šï¼‰
- **æäº¤å®¡æ‰¹**: å°† WPS æäº¤å®¡æ‰¹
- **å®¡æ‰¹é€šè¿‡**: å®¡æ‰¹äººæ‰¹å‡† WPS
- **å®¡æ‰¹æ‹’ç»**: å®¡æ‰¹äººæ‹’ç»å¹¶è¯´æ˜åŸå› 
- **å®¡æ‰¹å†å²**: æŸ¥çœ‹å®¡æ‰¹è®°å½•
- **å®¡æ‰¹é€šçŸ¥**: å®¡æ‰¹çŠ¶æ€å˜æ›´é€šçŸ¥

### 4. å¯¼å‡ºåŠŸèƒ½ï¼ˆä¸“ä¸šç‰ˆåŠä»¥ä¸Šï¼‰
- **å¯¼å‡º PDF**: ç”Ÿæˆæ ‡å‡†æ ¼å¼ PDF æ–‡ä»¶
- **å¯¼å‡º Excel**: å¯¼å‡ºä¸º Excel è¡¨æ ¼
- **æ‰¹é‡å¯¼å‡º**: æ‰¹é‡å¯¼å‡ºå¤šä¸ª WPS
- **è‡ªå®šä¹‰æ¨¡æ¿**: ä½¿ç”¨è‡ªå®šä¹‰å¯¼å‡ºæ¨¡æ¿

### 5. å¯¼å…¥åŠŸèƒ½ï¼ˆä¸“ä¸šç‰ˆåŠä»¥ä¸Šï¼‰
- **Excel å¯¼å…¥**: ä» Excel æ‰¹é‡å¯¼å…¥
- **æ¨¡æ¿ä¸‹è½½**: ä¸‹è½½å¯¼å…¥æ¨¡æ¿
- **æ•°æ®éªŒè¯**: å¯¼å…¥å‰éªŒè¯æ•°æ®
- **å¯¼å…¥é¢„è§ˆ**: é¢„è§ˆå¯¼å…¥ç»“æœ

### 6. æ¨¡æ¿ç®¡ç†ï¼ˆé«˜çº§ç‰ˆåŠä»¥ä¸Šï¼‰
- **åˆ›å»ºæ¨¡æ¿**: åŸºäºç°æœ‰ WPS åˆ›å»ºæ¨¡æ¿
- **ä½¿ç”¨æ¨¡æ¿**: ä»æ¨¡æ¿å¿«é€Ÿåˆ›å»º WPS
- **ç®¡ç†æ¨¡æ¿**: ç¼–è¾‘ã€åˆ é™¤æ¨¡æ¿
- **å…±äº«æ¨¡æ¿**: ä¼ä¸šå†…å…±äº«æ¨¡æ¿ï¼ˆä¼ä¸šç‰ˆï¼‰

### 7. å…³è”ç®¡ç†
- **å…³è” PQR**: å…³è”æ”¯æŒçš„ PQR è®°å½•
- **å…³è”ç„Šå·¥**: å…³è”åˆæ ¼ç„Šå·¥
- **å…³è”è®¾å¤‡**: å…³è”é€‚ç”¨è®¾å¤‡
- **å…³è”ç”Ÿäº§ä»»åŠ¡**: å…³è”ä½¿ç”¨è¯¥ WPS çš„ç”Ÿäº§ä»»åŠ¡

### 8. é™„ä»¶ç®¡ç†
- **ä¸Šä¼ é™„ä»¶**: ä¸Šä¼ ç›¸å…³æ–‡ä»¶ï¼ˆå›¾çº¸ã€ç…§ç‰‡ç­‰ï¼‰
- **ä¸‹è½½é™„ä»¶**: ä¸‹è½½å·²ä¸Šä¼ çš„é™„ä»¶
- **åˆ é™¤é™„ä»¶**: åˆ é™¤ä¸éœ€è¦çš„é™„ä»¶
- **é™„ä»¶é¢„è§ˆ**: åœ¨çº¿é¢„è§ˆå›¾ç‰‡å’Œ PDF

---

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹

### WPS è®°å½•è¡¨
```sql
CREATE TABLE wps_records (
    -- ä¸»é”®å’ŒåŸºç¡€å­—æ®µ
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    factory_id UUID REFERENCES factories(id) ON DELETE SET NULL,
    
    -- WPS åŸºæœ¬ä¿¡æ¯
    wps_number VARCHAR(100) NOT NULL,              -- WPS ç¼–å·
    title VARCHAR(255) NOT NULL,                   -- æ ‡é¢˜
    version VARCHAR(50) DEFAULT '1.0',             -- ç‰ˆæœ¬å·
    revision INTEGER DEFAULT 1,                    -- ä¿®è®¢ç‰ˆæœ¬å·
    status VARCHAR(50) DEFAULT 'draft',            -- çŠ¶æ€: draft, review, approved, archived, obsolete
    priority VARCHAR(20) DEFAULT 'normal',         -- ä¼˜å…ˆçº§: low, normal, high, urgent
    
    -- æ ‡å‡†å’Œè§„èŒƒ
    standard VARCHAR(100),                         -- ä½¿ç”¨çš„æ ‡å‡† (AWS, ISO, GBç­‰)
    specification_number VARCHAR(100),             -- è§„èŒƒç¼–å·
    pqr_support_uuids JSONB,                      -- æ”¯æŒçš„PQRè®°å½•UUIDåˆ—è¡¨
    
    -- ç„Šæ¥å·¥è‰ºå‚æ•°
    base_material VARCHAR(255),                    -- æ¯æ
    base_material_group VARCHAR(100),              -- æ¯æç»„å·
    base_material_thickness DECIMAL(8,2),          -- æ¯æåšåº¦èŒƒå›´
    filler_material VARCHAR(255),                  -- å¡«å……ææ–™
    filler_material_classification VARCHAR(100),   -- ç„Šæåˆ†ç±»
    welding_process VARCHAR(100),                  -- ç„Šæ¥æ–¹æ³•
    welding_process_variant VARCHAR(100),          -- ç„Šæ¥å·¥è‰ºå˜ä½“
    joint_type VARCHAR(100),                       -- æ¥å¤´ç±»å‹
    joint_design VARCHAR(255),                     -- æ¥å¤´è®¾è®¡è¯¦æƒ…
    welding_position VARCHAR(50),                  -- ç„Šæ¥ä½ç½®
    welding_position_progression VARCHAR(50),      -- ç„Šæ¥ä½ç½®è¿›å±•
    
    -- æ¸©åº¦å‚æ•°
    preheat_temp_min DECIMAL(10,2),               -- é¢„çƒ­æ¸©åº¦æœ€å°å€¼
    preheat_temp_max DECIMAL(10,2),               -- é¢„çƒ­æ¸©åº¦æœ€å¤§å€¼
    interpass_temp_min DECIMAL(10,2),             -- å±‚é—´æ¸©åº¦æœ€å°å€¼
    interpass_temp_max DECIMAL(10,2),             -- å±‚é—´æ¸©åº¦æœ€å¤§å€¼
    post_weld_heat_treatment JSONB,               -- ç„Šåçƒ­å¤„ç†å‚æ•°
    
    -- ç”µæ°”å‚æ•°
    current_range VARCHAR(50),                     -- ç”µæµèŒƒå›´
    voltage_range VARCHAR(50),                     -- ç”µå‹èŒƒå›´
    travel_speed VARCHAR(50),                      -- è¡Œèµ°é€Ÿåº¦
    heat_input_range VARCHAR(50),                  -- çƒ­è¾“å…¥èŒƒå›´
    
    -- ä¿æŠ¤æ°”ä½“
    gas_shield_type VARCHAR(100),                  -- ä¿æŠ¤æ°”ä½“ç±»å‹
    gas_flow_rate DECIMAL(8,2),                   -- æ°”ä½“æµé‡
    tungsten_electrode_type VARCHAR(100),          -- é’¨æç±»å‹
    electrode_diameter DECIMAL(6,2),               -- ç”µæç›´å¾„
    
    -- æŠ€æœ¯ä¿¡æ¯
    technique_description TEXT,                    -- å·¥è‰ºæè¿°
    welder_qualification_requirement VARCHAR(255), -- ç„Šå·¥èµ„è´¨è¦æ±‚
    inspection_requirements JSONB,                 -- æ£€éªŒè¦æ±‚
    
    -- é™„åŠ ä¿¡æ¯
    notes TEXT,                                    -- å¤‡æ³¨
    attachments JSONB,                            -- é™„ä»¶ä¿¡æ¯
    tags JSONB,                                   -- æ ‡ç­¾
    
    -- å®¡æ ¸å’Œæ‰¹å‡†ä¿¡æ¯
    reviewed_by UUID REFERENCES users(id),         -- å®¡æ ¸äºº
    reviewed_at TIMESTAMP,                         -- å®¡æ ¸æ—¶é—´
    approved_by UUID REFERENCES users(id),         -- æ‰¹å‡†äºº
    approved_at TIMESTAMP,                         -- æ‰¹å‡†æ—¶é—´
    effective_date DATE,                           -- ç”Ÿæ•ˆæ—¥æœŸ
    expiry_date DATE,                             -- è¿‡æœŸæ—¥æœŸ
    
    -- ç»Ÿè®¡ä¿¡æ¯
    view_count INTEGER DEFAULT 0,                  -- æŸ¥çœ‹æ¬¡æ•°
    download_count INTEGER DEFAULT 0,              -- ä¸‹è½½æ¬¡æ•°
    last_viewed_at TIMESTAMP,                      -- æœ€åæŸ¥çœ‹æ—¶é—´
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    deleted_at TIMESTAMP,                          -- è½¯åˆ é™¤
    
    -- ç´¢å¼•
    INDEX idx_user (user_id),
    INDEX idx_company (company_id),
    INDEX idx_factory (factory_id),
    INDEX idx_wps_number (wps_number),
    INDEX idx_status (status),
    INDEX idx_standard (standard),
    INDEX idx_approval (approved_by, approved_at),
    INDEX idx_effective_date (effective_date, expiry_date),
    INDEX idx_deleted (deleted_at)
);
```

### WPS æ¨¡æ¿è¡¨
```sql
CREATE TABLE wps_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    
    template_name VARCHAR(255) NOT NULL,
    template_description TEXT,
    template_data JSONB NOT NULL,                  -- æ¨¡æ¿æ•°æ®
    is_public BOOLEAN DEFAULT FALSE,               -- æ˜¯å¦å…¬å¼€ï¼ˆä¼ä¸šå†…ï¼‰
    usage_count INTEGER DEFAULT 0,                 -- ä½¿ç”¨æ¬¡æ•°
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user (user_id),
    INDEX idx_company (company_id)
);
```

---

## ğŸ”Œ APIæ¥å£

### 1. WPS åˆ—è¡¨
```http
GET /api/v1/wps?page=1&page_size=20&status=approved&search=WPS-2025
Authorization: Bearer <token>
```

**æŸ¥è¯¢å‚æ•°**:
- `page`: é¡µç ï¼Œé»˜è®¤1
- `page_size`: æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20
- `status`: çŠ¶æ€ç­›é€‰
- `search`: æœç´¢å…³é”®è¯
- `standard`: æ ‡å‡†ç­›é€‰
- `sort_by`: æ’åºå­—æ®µ
- `sort_order`: æ’åºæ–¹å‘ (asc/desc)

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "wps_number": "WPS-2025-001",
        "title": "ç¢³é’¢ç®¡é“ç„Šæ¥å·¥è‰º",
        "version": "1.0",
        "status": "approved",
        "created_at": "2025-10-16T10:00:00Z"
      }
    ],
    "total": 25,
    "page": 1,
    "page_size": 20,
    "total_pages": 2
  }
}
```

### 2. åˆ›å»º WPS
```http
POST /api/v1/wps
Authorization: Bearer <token>
Content-Type: application/json
```

**è¯·æ±‚ä½“**:
```json
{
  "wps_number": "WPS-2025-001",
  "title": "ç¢³é’¢ç®¡é“ç„Šæ¥å·¥è‰º",
  "standard": "AWS D1.1",
  "base_material": "Q235B",
  "filler_material": "E7018",
  "welding_process": "SMAW",
  "joint_type": "Butt Joint",
  "welding_position": "1G",
  "preheat_temp_min": 50,
  "preheat_temp_max": 100,
  "current_range": "80-120A",
  "voltage_range": "20-25V"
}
```

### 3. æ›´æ–° WPS
```http
PUT /api/v1/wps/{id}
Authorization: Bearer <token>
```

### 4. åˆ é™¤ WPS
```http
DELETE /api/v1/wps/{id}
Authorization: Bearer <token>
```

### 5. è·å– WPS è¯¦æƒ…
```http
GET /api/v1/wps/{id}
Authorization: Bearer <token>
```

### 6. æäº¤å®¡æ‰¹
```http
POST /api/v1/wps/{id}/submit-approval
Authorization: Bearer <token>
```

### 7. å®¡æ‰¹é€šè¿‡
```http
POST /api/v1/wps/{id}/approve
Authorization: Bearer <token>
Content-Type: application/json

{
  "comments": "å®¡æ‰¹é€šè¿‡"
}
```

### 8. å¯¼å‡º PDF
```http
GET /api/v1/wps/{id}/export/pdf
Authorization: Bearer <token>
```

### 9. æ‰¹é‡å¯¼å…¥
```http
POST /api/v1/wps/import
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <Excelæ–‡ä»¶>
```

---

## ğŸ’¼ ä¸šåŠ¡é€»è¾‘

### 1. åˆ›å»º WPS é€»è¾‘
```python
# app/services/wps_service.py

class WPSService:
    @require_quota("wps_records")
    async def create_wps(
        self,
        wps_data: WPSCreate,
        user_id: UUID,
        db: Session
    ) -> WPSRecord:
        """åˆ›å»º WPS"""
        
        # 1. æ£€æŸ¥é…é¢
        checker = QuotaChecker(db)
        if not checker.check_quota(user, "wps_records"):
            raise HTTPException(403, "WPS é…é¢å·²æ»¡")
        
        # 2. ç”Ÿæˆ WPS ç¼–å·ï¼ˆå¦‚æœæœªæä¾›ï¼‰
        if not wps_data.wps_number:
            wps_data.wps_number = self._generate_wps_number(user_id, db)
        
        # 3. åˆ›å»ºè®°å½•
        wps = WPSRecord(
            **wps_data.dict(),
            user_id=user_id,
            created_by=user_id,
            status="draft"
        )
        
        db.add(wps)
        db.commit()
        db.refresh(wps)
        
        return wps
```

### 2. å®¡æ‰¹æµç¨‹
```python
async def submit_for_approval(
    self,
    wps_id: UUID,
    user_id: UUID,
    db: Session
) -> WPSRecord:
    """æäº¤å®¡æ‰¹"""
    
    wps = db.query(WPSRecord).filter(
        WPSRecord.id == wps_id,
        WPSRecord.user_id == user_id
    ).first()
    
    if not wps:
        raise HTTPException(404, "WPS ä¸å­˜åœ¨")
    
    if wps.status != "draft":
        raise HTTPException(400, "åªèƒ½æäº¤è‰ç¨¿çŠ¶æ€çš„ WPS")
    
    wps.status = "review"
    wps.updated_at = datetime.now()
    
    db.commit()
    
    # å‘é€å®¡æ‰¹é€šçŸ¥
    await self._send_approval_notification(wps)
    
    return wps
```

### 3. ç‰ˆæœ¬æ§åˆ¶
```python
async def create_new_version(
    self,
    wps_id: UUID,
    user_id: UUID,
    db: Session
) -> WPSRecord:
    """åˆ›å»ºæ–°ç‰ˆæœ¬"""
    
    original = db.query(WPSRecord).filter(
        WPSRecord.id == wps_id,
        WPSRecord.user_id == user_id
    ).first()
    
    # å¤åˆ¶åŸè®°å½•
    new_wps = WPSRecord(**original.__dict__)
    new_wps.id = None
    new_wps.revision = original.revision + 1
    new_wps.version = f"{original.version}.{new_wps.revision}"
    new_wps.status = "draft"
    new_wps.created_at = datetime.now()
    
    db.add(new_wps)
    db.commit()
    
    return new_wps
```

---

## ğŸ” æƒé™æ§åˆ¶

### 1. æ•°æ®éš”ç¦»
```python
def get_wps_list(
    self,
    user_id: UUID,
    company_id: Optional[UUID],
    filters: Dict,
    db: Session
) -> List[WPSRecord]:
    """è·å– WPS åˆ—è¡¨ï¼ˆè‡ªåŠ¨æ•°æ®éš”ç¦»ï¼‰"""
    
    query = db.query(WPSRecord).filter(
        WPSRecord.user_id == user_id,
        WPSRecord.deleted_at.is_(None)
    )
    
    # ä¼ä¸šä¼šå‘˜å¯ä»¥æŸ¥çœ‹ä¼ä¸šæ•°æ®
    if company_id:
        query = query.filter(
            or_(
                WPSRecord.user_id == user_id,
                WPSRecord.company_id == company_id
            )
        )
    
    return query.all()
```

### 2. æ“ä½œæƒé™
```python
@router.post("/wps/{id}/approve")
@require_feature("approval_workflow")  # éœ€è¦é«˜çº§ç‰ˆåŠä»¥ä¸Š
async def approve_wps(
    wps_id: UUID,
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """å®¡æ‰¹ WPS"""
    service = WPSService(db)
    return await service.approve_wps(wps_id, current_user.id, db)
```

---

## ğŸ¨ å‰ç«¯ç•Œé¢

### WPS åˆ—è¡¨é¡µé¢
```typescript
// src/pages/WPS/List.tsx

const WPSList: React.FC = () => {
  const [wps, setWPS] = useState<WPS[]>([]);
  const [loading, setLoading] = useState(false);
  const [filters, setFilters] = useState({});
  
  const columns = [
    { title: 'WPSç¼–å·', dataIndex: 'wps_number', key: 'wps_number' },
    { title: 'æ ‡é¢˜', dataIndex: 'title', key: 'title' },
    { title: 'ç‰ˆæœ¬', dataIndex: 'version', key: 'version' },
    { title: 'çŠ¶æ€', dataIndex: 'status', key: 'status', render: renderStatus },
    { title: 'åˆ›å»ºæ—¶é—´', dataIndex: 'created_at', key: 'created_at' },
    { title: 'æ“ä½œ', key: 'actions', render: renderActions }
  ];
  
  return (
    <div>
      <WPSFilters onChange={setFilters} />
      <Table 
        columns={columns} 
        dataSource={wps} 
        loading={loading}
        pagination={{ pageSize: 20 }}
      />
    </div>
  );
};
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-16  
**å¼€å‘çŠ¶æ€**: å¾…å¼€å‘

