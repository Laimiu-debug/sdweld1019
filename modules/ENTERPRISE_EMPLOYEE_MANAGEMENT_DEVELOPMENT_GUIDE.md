# ä¼ä¸šå‘˜å·¥ç®¡ç†æ¨¡å— - å¼€å‘æŒ‡å—

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### åŠŸèƒ½å®šä½
ä¼ä¸šå‘˜å·¥ç®¡ç†æ¨¡å—ç”¨äºä¼ä¸šä¼šå‘˜ç®¡ç†å‘˜å·¥è´¦å·ã€åˆ†é…æƒé™ã€ç®¡ç†å·¥å‚å’Œéƒ¨é—¨ï¼Œå®ç°ä¼ä¸šå†…éƒ¨çš„åä½œç®¡ç†ã€‚

### é€‚ç”¨åœºæ™¯
- ä¼ä¸šå‘˜å·¥è´¦å·ç®¡ç†
- å‘˜å·¥æƒé™åˆ†é…
- å·¥å‚å’Œéƒ¨é—¨ç®¡ç†
- å‘˜å·¥å·¥ä½œé‡ç»Ÿè®¡
- è·¨å·¥å‚æ•°æ®ç®¡ç†

### å¼€å‘ä¼˜å…ˆçº§
**ç¬¬äºŒé˜¶æ®µ** - é‡è¦åŠŸèƒ½ï¼Œä¼˜å…ˆå¼€å‘

---

## ğŸ¯ ä¼šå‘˜æƒé™

### è®¿é—®æƒé™
| ä¼šå‘˜ç­‰çº§ | è®¿é—®æƒé™ | åŠŸèƒ½èŒƒå›´ |
|---------|---------|---------|
| æ¸¸å®¢æ¨¡å¼ | âŒ ä¸å¯è®¿é—® | - |
| ä¸ªäººå…è´¹ç‰ˆ | âŒ ä¸å¯è®¿é—® | - |
| ä¸ªäººä¸“ä¸šç‰ˆ | âŒ ä¸å¯è®¿é—® | - |
| ä¸ªäººé«˜çº§ç‰ˆ | âŒ ä¸å¯è®¿é—® | - |
| ä¸ªäººæ——èˆ°ç‰ˆ | âŒ ä¸å¯è®¿é—® | - |
| ä¼ä¸šç‰ˆ | âœ… å¯è®¿é—® | å®Œæ•´åŠŸèƒ½ï¼ˆ1å·¥å‚ï¼Œ10å‘˜å·¥ï¼‰ |
| ä¼ä¸šPRO | âœ… å¯è®¿é—® | å®Œæ•´åŠŸèƒ½ï¼ˆ3å·¥å‚ï¼Œ20å‘˜å·¥ï¼‰ |
| ä¼ä¸šPRO MAX | âœ… å¯è®¿é—® | å®Œæ•´åŠŸèƒ½ï¼ˆ5å·¥å‚ï¼Œ50å‘˜å·¥ï¼‰ |

**é‡è¦è¯´æ˜**:
- ä¼ä¸šå‘˜å·¥ç®¡ç†åŠŸèƒ½**ä»…å¯¹ä¼ä¸šä¼šå‘˜å¼€æ”¾**ï¼ˆä¼ä¸šç‰ˆã€ä¼ä¸šPROã€ä¼ä¸šPRO MAXï¼‰
- ä¸ªäººä¼šå‘˜ï¼ˆåŒ…æ‹¬æ——èˆ°ç‰ˆï¼‰æ— æ³•è®¿é—®æ­¤åŠŸèƒ½
- å‘˜å·¥é»˜è®¤ç»§æ‰¿**ä¸ªäººä¸“ä¸šç‰ˆ**æƒé™
- ä¼ä¸šç®¡ç†å‘˜å¯ä»¥é¢å¤–åˆ†é…æˆ–é™åˆ¶å‘˜å·¥æƒé™

---

## ğŸ“Š åŠŸèƒ½æ¸…å•

### 1. å‘˜å·¥ç®¡ç†
- **é‚€è¯·å‘˜å·¥**: é€šè¿‡é‚®ç®±é‚€è¯·å‘˜å·¥åŠ å…¥
- **å‘˜å·¥åˆ—è¡¨**: æŸ¥çœ‹æ‰€æœ‰å‘˜å·¥
- **å‘˜å·¥è¯¦æƒ…**: æŸ¥çœ‹å‘˜å·¥è¯¦ç»†ä¿¡æ¯
- **åœç”¨å‘˜å·¥**: åœç”¨å‘˜å·¥è´¦å·
- **åˆ é™¤å‘˜å·¥**: åˆ é™¤å‘˜å·¥è´¦å·
- **å‘˜å·¥æœç´¢**: æœç´¢å‘˜å·¥

### 2. æƒé™ç®¡ç†
- **è§’è‰²åˆ†é…**: åˆ†é…å‘˜å·¥è§’è‰²ï¼ˆç®¡ç†å‘˜ã€æ™®é€šå‘˜å·¥ï¼‰
- **æƒé™è®¾ç½®**: è®¾ç½®å‘˜å·¥æƒé™
- **æ¨¡å—è®¿é—®**: æ§åˆ¶å‘˜å·¥å¯è®¿é—®çš„æ¨¡å—
- **æ•°æ®æƒé™**: æ§åˆ¶å‘˜å·¥å¯è®¿é—®çš„æ•°æ®èŒƒå›´
- **æ“ä½œæƒé™**: æ§åˆ¶å‘˜å·¥å¯æ‰§è¡Œçš„æ“ä½œ

### 3. å·¥å‚ç®¡ç†
- **åˆ›å»ºå·¥å‚**: åˆ›å»ºæ–°å·¥å‚
- **ç¼–è¾‘å·¥å‚**: ä¿®æ”¹å·¥å‚ä¿¡æ¯
- **åˆ é™¤å·¥å‚**: åˆ é™¤å·¥å‚
- **å·¥å‚åˆ†é…**: åˆ†é…å‘˜å·¥åˆ°å·¥å‚
- **å·¥å‚åˆ‡æ¢**: å‘˜å·¥åˆ‡æ¢å·¥ä½œå·¥å‚

### 4. éƒ¨é—¨ç®¡ç†
- **åˆ›å»ºéƒ¨é—¨**: åˆ›å»ºéƒ¨é—¨
- **ç¼–è¾‘éƒ¨é—¨**: ä¿®æ”¹éƒ¨é—¨ä¿¡æ¯
- **åˆ é™¤éƒ¨é—¨**: åˆ é™¤éƒ¨é—¨
- **éƒ¨é—¨åˆ†é…**: åˆ†é…å‘˜å·¥åˆ°éƒ¨é—¨

### 5. å‘˜å·¥ç»Ÿè®¡
- **å‘˜å·¥æ•°é‡**: ç»Ÿè®¡å‘˜å·¥æ•°é‡
- **æ´»è·ƒåº¦ç»Ÿè®¡**: ç»Ÿè®¡å‘˜å·¥æ´»è·ƒåº¦
- **å·¥ä½œé‡ç»Ÿè®¡**: ç»Ÿè®¡å‘˜å·¥å·¥ä½œé‡
- **æƒé™åˆ†å¸ƒ**: ç»Ÿè®¡æƒé™åˆ†å¸ƒ

### 6. é‚€è¯·ç®¡ç†
- **å‘é€é‚€è¯·**: å‘é€é‚€è¯·é‚®ä»¶
- **é‚€è¯·åˆ—è¡¨**: æŸ¥çœ‹æ‰€æœ‰é‚€è¯·
- **å–æ¶ˆé‚€è¯·**: å–æ¶ˆæœªæ¥å—çš„é‚€è¯·
- **é‡æ–°å‘é€**: é‡æ–°å‘é€é‚€è¯·

---

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹

### å‘˜å·¥é‚€è¯·è¡¨
```sql
CREATE TABLE employee_invitations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    invited_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- é‚€è¯·ä¿¡æ¯
    email VARCHAR(255) NOT NULL,                   -- è¢«é‚€è¯·äººé‚®ç®±
    invitation_code VARCHAR(100) UNIQUE NOT NULL,  -- é‚€è¯·ç 
    status VARCHAR(50) DEFAULT 'pending',          -- çŠ¶æ€: pending, accepted, expired, cancelled
    
    -- æƒé™è®¾ç½®
    role VARCHAR(50) DEFAULT 'employee',           -- è§’è‰²: admin, employee
    factory_id UUID REFERENCES factories(id),      -- åˆ†é…çš„å·¥å‚
    department_id UUID REFERENCES departments(id), -- åˆ†é…çš„éƒ¨é—¨
    permissions JSONB,                             -- æƒé™è®¾ç½®
    
    -- æ—¶é—´ä¿¡æ¯
    expires_at TIMESTAMP,                          -- è¿‡æœŸæ—¶é—´
    accepted_at TIMESTAMP,                         -- æ¥å—æ—¶é—´
    accepted_by UUID REFERENCES users(id),         -- æ¥å—äºº
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_company (company_id),
    INDEX idx_email (email),
    INDEX idx_invitation_code (invitation_code),
    INDEX idx_status (status)
);
```

### å‘˜å·¥å…³ç³»è¡¨
```sql
CREATE TABLE company_employees (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- å‘˜å·¥ä¿¡æ¯
    employee_number VARCHAR(100),                  -- å‘˜å·¥ç¼–å·
    role VARCHAR(50) DEFAULT 'employee',           -- è§’è‰²: admin, employee
    status VARCHAR(50) DEFAULT 'active',           -- çŠ¶æ€: active, inactive
    
    -- åˆ†é…ä¿¡æ¯
    factory_id UUID REFERENCES factories(id),      -- æ‰€å±å·¥å‚
    department_id UUID REFERENCES departments(id), -- æ‰€å±éƒ¨é—¨
    position VARCHAR(100),                         -- èŒä½
    
    -- æƒé™
    permissions JSONB,                             -- é¢å¤–æƒé™
    data_access_scope VARCHAR(50) DEFAULT 'factory', -- æ•°æ®è®¿é—®èŒƒå›´: factory, company
    
    -- æ—¶é—´ä¿¡æ¯
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- åŠ å…¥æ—¶é—´
    left_at TIMESTAMP,                             -- ç¦»èŒæ—¶é—´
    
    -- ç»Ÿè®¡ä¿¡æ¯
    total_wps_created INTEGER DEFAULT 0,           -- åˆ›å»ºçš„ WPS æ•°é‡
    total_tasks_completed INTEGER DEFAULT 0,       -- å®Œæˆçš„ä»»åŠ¡æ•°é‡
    last_active_at TIMESTAMP,                      -- æœ€åæ´»è·ƒæ—¶é—´
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    
    -- ç´¢å¼•
    INDEX idx_company (company_id),
    INDEX idx_user (user_id),
    INDEX idx_factory (factory_id),
    INDEX idx_department (department_id),
    INDEX idx_status (status),
    
    UNIQUE (company_id, user_id)
);
```

### éƒ¨é—¨è¡¨
```sql
CREATE TABLE departments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    factory_id UUID REFERENCES factories(id) ON DELETE CASCADE,
    
    -- éƒ¨é—¨ä¿¡æ¯
    department_code VARCHAR(100) NOT NULL,         -- éƒ¨é—¨ç¼–ç 
    department_name VARCHAR(255) NOT NULL,         -- éƒ¨é—¨åç§°
    description TEXT,                              -- æè¿°
    
    -- è´Ÿè´£äºº
    manager_id UUID REFERENCES users(id),          -- éƒ¨é—¨ç»ç†
    
    -- ç»Ÿè®¡ä¿¡æ¯
    employee_count INTEGER DEFAULT 0,              -- å‘˜å·¥æ•°é‡
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    deleted_at TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_company (company_id),
    INDEX idx_factory (factory_id),
    INDEX idx_department_code (department_code),
    INDEX idx_deleted (deleted_at),
    
    UNIQUE (company_id, department_code)
);
```

---

## ğŸ”Œ APIæ¥å£

### 1. é‚€è¯·å‘˜å·¥
```http
POST /api/v1/enterprise/employees/invite
Authorization: Bearer <token>
Content-Type: application/json

{
  "email": "employee@example.com",
  "role": "employee",
  "factory_id": "uuid",
  "department_id": "uuid",
  "permissions": {
    "can_create_wps": true,
    "can_approve_wps": false
  }
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "invitation_id": "uuid",
    "invitation_code": "INV-2025-XXXXX",
    "email": "employee@example.com",
    "expires_at": "2025-10-23T10:00:00Z",
    "invitation_link": "https://app.example.com/accept-invitation?code=INV-2025-XXXXX"
  }
}
```

### 2. å‘˜å·¥åˆ—è¡¨
```http
GET /api/v1/enterprise/employees?page=1&page_size=20&status=active
Authorization: Bearer <token>
```

### 3. æ›´æ–°å‘˜å·¥æƒé™
```http
PUT /api/v1/enterprise/employees/{employee_id}/permissions
Authorization: Bearer <token>
Content-Type: application/json

{
  "role": "admin",
  "permissions": {
    "can_create_wps": true,
    "can_approve_wps": true,
    "can_manage_employees": true
  },
  "data_access_scope": "company"
}
```

### 4. åœç”¨å‘˜å·¥
```http
POST /api/v1/enterprise/employees/{employee_id}/deactivate
Authorization: Bearer <token>
```

### 5. åˆ›å»ºå·¥å‚
```http
POST /api/v1/enterprise/factories
Authorization: Bearer <token>
Content-Type: application/json

{
  "factory_code": "F001",
  "factory_name": "åŒ—äº¬å·¥å‚",
  "address": "åŒ—äº¬å¸‚æœé˜³åŒº",
  "contact_person": "å¼ ä¸‰",
  "phone": "13800138000"
}
```

### 6. åˆ›å»ºéƒ¨é—¨
```http
POST /api/v1/enterprise/departments
Authorization: Bearer <token>
Content-Type: application/json

{
  "department_code": "D001",
  "department_name": "ç„Šæ¥éƒ¨",
  "factory_id": "uuid",
  "manager_id": "uuid"
}
```

### 7. å‘˜å·¥ç»Ÿè®¡
```http
GET /api/v1/enterprise/employees/statistics
Authorization: Bearer <token>
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "total_employees": 15,
    "active_employees": 14,
    "inactive_employees": 1,
    "by_factory": {
      "å·¥å‚A": 8,
      "å·¥å‚B": 7
    },
    "by_role": {
      "admin": 2,
      "employee": 13
    },
    "quota_usage": {
      "current": 15,
      "max": 20,
      "percentage": 75
    }
  }
}
```

---

## ğŸ’¼ ä¸šåŠ¡é€»è¾‘

### 1. é‚€è¯·å‘˜å·¥
```python
class EnterpriseService:
    @require_feature("employee_management")  # éœ€è¦ä¼ä¸šç‰ˆ
    async def invite_employee(
        self,
        invitation_data: EmployeeInvitation,
        user_id: UUID,
        db: Session
    ) -> Dict[str, Any]:
        """é‚€è¯·å‘˜å·¥"""
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºä¼ä¸šç®¡ç†å‘˜
        user = db.query(User).filter(User.id == user_id).first()
        if user.membership_type != "enterprise":
            raise HTTPException(403, "ä»…ä¼ä¸šä¼šå‘˜å¯ä»¥é‚€è¯·å‘˜å·¥")
        
        # æ£€æŸ¥å‘˜å·¥é…é¢
        company = db.query(Company).filter(Company.id == user.company_id).first()
        current_employees = db.query(CompanyEmployee).filter(
            CompanyEmployee.company_id == user.company_id,
            CompanyEmployee.status == "active"
        ).count()
        
        max_employees = self._get_max_employees(user.membership_tier)
        if current_employees >= max_employees:
            raise HTTPException(403, f"å‘˜å·¥æ•°é‡å·²è¾¾ä¸Šé™ï¼ˆ{max_employees}äººï¼‰")
        
        # ç”Ÿæˆé‚€è¯·ç 
        invitation_code = self._generate_invitation_code()
        
        # åˆ›å»ºé‚€è¯·
        invitation = EmployeeInvitation(
            company_id=user.company_id,
            invited_by=user_id,
            email=invitation_data.email,
            invitation_code=invitation_code,
            role=invitation_data.role,
            factory_id=invitation_data.factory_id,
            department_id=invitation_data.department_id,
            permissions=invitation_data.permissions,
            expires_at=datetime.now() + timedelta(days=7)
        )
        
        db.add(invitation)
        db.commit()
        
        # å‘é€é‚€è¯·é‚®ä»¶
        await self._send_invitation_email(invitation)
        
        return {
            "invitation_id": str(invitation.id),
            "invitation_code": invitation_code,
            "email": invitation_data.email,
            "expires_at": invitation.expires_at,
            "invitation_link": f"https://app.example.com/accept-invitation?code={invitation_code}"
        }
    
    def _get_max_employees(self, tier: str) -> int:
        """è·å–æœ€å¤§å‘˜å·¥æ•°"""
        limits = {
            "enterprise": 10,
            "enterprise_pro": 20,
            "enterprise_pro_max": 50
        }
        return limits.get(tier, 0)
```

### 2. æ¥å—é‚€è¯·
```python
async def accept_invitation(
    self,
    invitation_code: str,
    user_id: UUID,
    db: Session
) -> CompanyEmployee:
    """æ¥å—é‚€è¯·"""
    
    invitation = db.query(EmployeeInvitation).filter(
        EmployeeInvitation.invitation_code == invitation_code,
        EmployeeInvitation.status == "pending"
    ).first()
    
    if not invitation:
        raise HTTPException(404, "é‚€è¯·ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆ")
    
    if invitation.expires_at < datetime.now():
        invitation.status = "expired"
        db.commit()
        raise HTTPException(400, "é‚€è¯·å·²è¿‡æœŸ")
    
    user = db.query(User).filter(User.id == user_id).first()
    if user.email != invitation.email:
        raise HTTPException(403, "é‚®ç®±ä¸åŒ¹é…")
    
    # åˆ›å»ºå‘˜å·¥å…³ç³»
    employee = CompanyEmployee(
        company_id=invitation.company_id,
        user_id=user_id,
        role=invitation.role,
        factory_id=invitation.factory_id,
        department_id=invitation.department_id,
        permissions=invitation.permissions,
        status="active"
    )
    
    db.add(employee)
    
    # æ›´æ–°é‚€è¯·çŠ¶æ€
    invitation.status = "accepted"
    invitation.accepted_at = datetime.now()
    invitation.accepted_by = user_id
    
    # æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    user.company_id = invitation.company_id
    user.factory_id = invitation.factory_id
    
    db.commit()
    
    return employee
```

### 3. å‘˜å·¥æƒé™æ£€æŸ¥
```python
def check_employee_permission(
    self,
    user_id: UUID,
    permission: str,
    db: Session
) -> bool:
    """æ£€æŸ¥å‘˜å·¥æƒé™"""
    
    employee = db.query(CompanyEmployee).filter(
        CompanyEmployee.user_id == user_id,
        CompanyEmployee.status == "active"
    ).first()
    
    if not employee:
        return False
    
    # ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
    if employee.role == "admin":
        return True
    
    # æ£€æŸ¥é¢å¤–æƒé™
    if employee.permissions and permission in employee.permissions:
        return employee.permissions[permission]
    
    # é»˜è®¤æƒé™ï¼ˆç»§æ‰¿ä¸“ä¸šç‰ˆï¼‰
    default_permissions = {
        "can_create_wps": True,
        "can_create_pqr": True,
        "can_create_ppqr": True,
        "can_manage_welders": True,
        "can_manage_materials": True,
        "can_approve_wps": False,
        "can_manage_employees": False
    }
    
    return default_permissions.get(permission, False)
```

---

## ğŸ” æƒé™æ§åˆ¶

### ä¼ä¸šç®¡ç†å‘˜æ£€æŸ¥
```python
def require_enterprise_admin(
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """è¦æ±‚ä¼ä¸šç®¡ç†å‘˜æƒé™"""
    
    if current_user.membership_type != "enterprise":
        raise HTTPException(403, "éœ€è¦ä¼ä¸šä¼šå‘˜")
    
    employee = db.query(CompanyEmployee).filter(
        CompanyEmployee.user_id == current_user.id,
        CompanyEmployee.company_id == current_user.company_id,
        CompanyEmployee.status == "active"
    ).first()
    
    if not employee or employee.role != "admin":
        raise HTTPException(403, "éœ€è¦ä¼ä¸šç®¡ç†å‘˜æƒé™")
    
    return current_user

@router.post("/enterprise/employees/invite")
async def invite_employee(
    invitation_data: EmployeeInvitation,
    current_user: User = Depends(require_enterprise_admin),
    db: Session = Depends(get_db)
):
    """é‚€è¯·å‘˜å·¥ï¼ˆä»…ä¼ä¸šç®¡ç†å‘˜ï¼‰"""
    service = EnterpriseService(db)
    return await service.invite_employee(invitation_data, current_user.id, db)
```

---

## ğŸ¨ å‰ç«¯ç•Œé¢

### å‘˜å·¥ç®¡ç†é¡µé¢
```typescript
// src/pages/Enterprise/EmployeeManagement.tsx

const EmployeeManagement: React.FC = () => {
  const { employees, loading } = useEmployees();
  const { quota } = useEmployeeQuota();
  
  const columns = [
    { title: 'å‘˜å·¥ç¼–å·', dataIndex: 'employee_number' },
    { title: 'å§“å', dataIndex: 'name' },
    { title: 'é‚®ç®±', dataIndex: 'email' },
    { title: 'è§’è‰²', dataIndex: 'role', render: renderRole },
    { title: 'å·¥å‚', dataIndex: 'factory_name' },
    { title: 'éƒ¨é—¨', dataIndex: 'department_name' },
    { title: 'çŠ¶æ€', dataIndex: 'status', render: renderStatus },
    { title: 'æ“ä½œ', render: renderActions }
  ];
  
  return (
    <div>
      <Card>
        <Statistic 
          title="å‘˜å·¥é…é¢" 
          value={quota.current} 
          suffix={`/ ${quota.max}`}
        />
        <Progress percent={quota.percentage} />
        <Button 
          type="primary" 
          onClick={handleInvite}
          disabled={quota.current >= quota.max}
        >
          é‚€è¯·å‘˜å·¥
        </Button>
      </Card>
      
      <Table columns={columns} dataSource={employees} loading={loading} />
    </div>
  );
};
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-16  
**å¼€å‘çŠ¶æ€**: å¾…å¼€å‘

