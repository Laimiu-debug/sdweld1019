# ä¸ªäººä¸­å¿ƒæ¨¡å— - å¼€å‘æŒ‡å—

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### åŠŸèƒ½å®šä½
ä¸ªäººä¸­å¿ƒæ¨¡å—ç”¨äºç®¡ç†ç”¨æˆ·ä¸ªäººä¿¡æ¯ã€è´¦å·è®¾ç½®ã€ä¼šå‘˜è®¢é˜…ã€å®‰å…¨è®¾ç½®ç­‰ä¸ªäººç›¸å…³åŠŸèƒ½ã€‚

### é€‚ç”¨åœºæ™¯
- ä¸ªäººä¿¡æ¯ç®¡ç†
- è´¦å·å®‰å…¨è®¾ç½®
- ä¼šå‘˜è®¢é˜…ç®¡ç†
- ä½¿ç”¨ç»Ÿè®¡æŸ¥çœ‹
- åå¥½è®¾ç½®

### å¼€å‘ä¼˜å…ˆçº§
**ç¬¬ä¸€é˜¶æ®µ** - æ ¸å¿ƒåŠŸèƒ½ï¼Œç«‹å³å¼€å‘

---

## ğŸ¯ ä¼šå‘˜æƒé™

### è®¿é—®æƒé™
| ä¼šå‘˜ç­‰çº§ | è®¿é—®æƒé™ | åŠŸèƒ½èŒƒå›´ |
|---------|---------|---------|
| æ¸¸å®¢æ¨¡å¼ | âœ… å¯è®¿é—® | åŸºç¡€ä¿¡æ¯æŸ¥çœ‹ |
| ä¸ªäººå…è´¹ç‰ˆ | âœ… å¯è®¿é—® | å®Œæ•´åŠŸèƒ½ |
| ä¸ªäººä¸“ä¸šç‰ˆ | âœ… å¯è®¿é—® | å®Œæ•´åŠŸèƒ½ |
| ä¸ªäººé«˜çº§ç‰ˆ | âœ… å¯è®¿é—® | å®Œæ•´åŠŸèƒ½ |
| ä¸ªäººæ——èˆ°ç‰ˆ | âœ… å¯è®¿é—® | å®Œæ•´åŠŸèƒ½ |
| ä¼ä¸šç‰ˆ | âœ… å¯è®¿é—® | å®Œæ•´åŠŸèƒ½ + ä¼ä¸šä¿¡æ¯ |
| ä¼ä¸šPRO | âœ… å¯è®¿é—® | å®Œæ•´åŠŸèƒ½ + ä¼ä¸šä¿¡æ¯ |
| ä¼ä¸šPRO MAX | âœ… å¯è®¿é—® | å®Œæ•´åŠŸèƒ½ + ä¼ä¸šä¿¡æ¯ |

**è¯´æ˜**: ä¸ªäººä¸­å¿ƒæ˜¯æ‰€æœ‰ç”¨æˆ·å‡å¯è®¿é—®çš„é€šç”¨åŠŸèƒ½ã€‚

---

## ğŸ“Š åŠŸèƒ½æ¸…å•

### 1. ä¸ªäººä¿¡æ¯ç®¡ç†
- **åŸºæœ¬ä¿¡æ¯**: å§“åã€é‚®ç®±ã€æ‰‹æœºå·
- **å¤´åƒä¸Šä¼ **: ä¸Šä¼ å’Œæ›´æ¢å¤´åƒ
- **ä¸ªäººç®€ä»‹**: ç¼–è¾‘ä¸ªäººç®€ä»‹
- **è”ç³»æ–¹å¼**: ç®¡ç†è”ç³»æ–¹å¼
- **æ—¶åŒºè®¾ç½®**: è®¾ç½®æ—¶åŒº
- **è¯­è¨€è®¾ç½®**: é€‰æ‹©ç•Œé¢è¯­è¨€

### 2. è´¦å·å®‰å…¨
- **ä¿®æ”¹å¯†ç **: ä¿®æ”¹ç™»å½•å¯†ç 
- **åŒå› ç´ è®¤è¯**: å¯ç”¨/ç¦ç”¨ 2FA
- **ç™»å½•å†å²**: æŸ¥çœ‹ç™»å½•è®°å½•
- **æ´»è·ƒä¼šè¯**: ç®¡ç†æ´»è·ƒä¼šè¯
- **å®‰å…¨é—®é¢˜**: è®¾ç½®å®‰å…¨é—®é¢˜
- **è´¦å·æ³¨é”€**: æ³¨é”€è´¦å·

### 3. ä¼šå‘˜è®¢é˜…
- **å½“å‰å¥—é¤**: æŸ¥çœ‹å½“å‰ä¼šå‘˜ç­‰çº§
- **é…é¢ä½¿ç”¨**: æŸ¥çœ‹é…é¢ä½¿ç”¨æƒ…å†µ
- **å‡çº§ä¼šå‘˜**: å‡çº§åˆ°æ›´é«˜ç­‰çº§
- **ç»­è´¹è®¢é˜…**: ç»­è´¹ä¼šå‘˜è®¢é˜…
- **è®¢é˜…å†å²**: æŸ¥çœ‹è®¢é˜…å†å²
- **å‘ç¥¨ç®¡ç†**: ä¸‹è½½å‘ç¥¨

### 4. ä½¿ç”¨ç»Ÿè®¡
- **æ•°æ®ç»Ÿè®¡**: æŸ¥çœ‹ä½¿ç”¨æ•°æ®ç»Ÿè®¡
- **æ´»è·ƒåº¦**: æŸ¥çœ‹æ´»è·ƒåº¦ç»Ÿè®¡
- **å­˜å‚¨ä½¿ç”¨**: æŸ¥çœ‹å­˜å‚¨ç©ºé—´ä½¿ç”¨
- **æ“ä½œæ—¥å¿—**: æŸ¥çœ‹æ“ä½œæ—¥å¿—

### 5. é€šçŸ¥è®¾ç½®
- **é‚®ä»¶é€šçŸ¥**: è®¾ç½®é‚®ä»¶é€šçŸ¥åå¥½
- **ç³»ç»Ÿé€šçŸ¥**: è®¾ç½®ç³»ç»Ÿé€šçŸ¥åå¥½
- **æé†’è®¾ç½®**: è®¾ç½®å„ç±»æé†’
- **é€šçŸ¥å†å²**: æŸ¥çœ‹é€šçŸ¥å†å²

### 6. åå¥½è®¾ç½®
- **ç•Œé¢ä¸»é¢˜**: é€‰æ‹©ç•Œé¢ä¸»é¢˜ï¼ˆäº®è‰²/æš—è‰²ï¼‰
- **é»˜è®¤è§†å›¾**: è®¾ç½®é»˜è®¤è§†å›¾
- **å¿«æ·é”®**: è‡ªå®šä¹‰å¿«æ·é”®
- **æ•°æ®å±•ç¤º**: è®¾ç½®æ•°æ®å±•ç¤ºåå¥½

### 7. ä¼ä¸šä¿¡æ¯ï¼ˆä¼ä¸šä¼šå‘˜ï¼‰
- **ä¼ä¸šä¿¡æ¯**: æŸ¥çœ‹ä¼ä¸šä¿¡æ¯
- **å·¥å‚ä¿¡æ¯**: æŸ¥çœ‹æ‰€å±å·¥å‚
- **éƒ¨é—¨ä¿¡æ¯**: æŸ¥çœ‹æ‰€å±éƒ¨é—¨
- **å‘˜å·¥ä¿¡æ¯**: æŸ¥çœ‹åŒäº‹ä¿¡æ¯

---

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹

### ç”¨æˆ·åå¥½è®¾ç½®è¡¨
```sql
CREATE TABLE user_preferences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- ç•Œé¢è®¾ç½®
    theme VARCHAR(20) DEFAULT 'light',             -- ä¸»é¢˜: light, dark
    language VARCHAR(10) DEFAULT 'zh-CN',          -- è¯­è¨€
    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',  -- æ—¶åŒº
    
    -- é€šçŸ¥è®¾ç½®
    email_notifications JSONB DEFAULT '{}',        -- é‚®ä»¶é€šçŸ¥è®¾ç½®
    system_notifications JSONB DEFAULT '{}',       -- ç³»ç»Ÿé€šçŸ¥è®¾ç½®
    
    -- æ˜¾ç¤ºè®¾ç½®
    default_view VARCHAR(50),                      -- é»˜è®¤è§†å›¾
    items_per_page INTEGER DEFAULT 20,             -- æ¯é¡µæ˜¾ç¤ºæ•°é‡
    date_format VARCHAR(20) DEFAULT 'YYYY-MM-DD',  -- æ—¥æœŸæ ¼å¼
    
    -- å¿«æ·é”®
    keyboard_shortcuts JSONB,                      -- å¿«æ·é”®è®¾ç½®
    
    -- å…¶ä»–åå¥½
    preferences JSONB,                             -- å…¶ä»–åå¥½è®¾ç½®
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_user (user_id),
    
    UNIQUE (user_id)
);
```

### ç™»å½•å†å²è¡¨
```sql
CREATE TABLE login_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- ç™»å½•ä¿¡æ¯
    login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    logout_time TIMESTAMP,
    ip_address VARCHAR(50),                        -- IP åœ°å€
    user_agent TEXT,                               -- æµè§ˆå™¨ä¿¡æ¯
    device_type VARCHAR(50),                       -- è®¾å¤‡ç±»å‹
    location VARCHAR(255),                         -- ç™»å½•ä½ç½®
    
    -- ç™»å½•ç»“æœ
    login_status VARCHAR(20),                      -- çŠ¶æ€: success, failed
    failure_reason TEXT,                           -- å¤±è´¥åŸå› 
    
    -- ä¼šè¯ä¿¡æ¯
    session_id VARCHAR(255),                       -- ä¼šè¯ID
    is_active BOOLEAN DEFAULT TRUE,                -- æ˜¯å¦æ´»è·ƒ
    
    -- ç´¢å¼•
    INDEX idx_user (user_id),
    INDEX idx_login_time (login_time),
    INDEX idx_session (session_id)
);
```

### é€šçŸ¥è®°å½•è¡¨
```sql
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- é€šçŸ¥ä¿¡æ¯
    notification_type VARCHAR(50),                 -- ç±»å‹: system, quota, certificate, etc.
    title VARCHAR(255),                            -- æ ‡é¢˜
    content TEXT,                                  -- å†…å®¹
    priority VARCHAR(20) DEFAULT 'normal',         -- ä¼˜å…ˆçº§: low, normal, high
    
    -- çŠ¶æ€
    is_read BOOLEAN DEFAULT FALSE,                 -- æ˜¯å¦å·²è¯»
    read_at TIMESTAMP,                             -- é˜…è¯»æ—¶é—´
    
    -- å…³è”ä¿¡æ¯
    related_type VARCHAR(50),                      -- å…³è”ç±»å‹
    related_id UUID,                               -- å…³è”ID
    
    -- æ“ä½œ
    action_url VARCHAR(500),                       -- æ“ä½œé“¾æ¥
    action_text VARCHAR(100),                      -- æ“ä½œæ–‡æœ¬
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_user (user_id),
    INDEX idx_is_read (is_read),
    INDEX idx_created_at (created_at)
);
```

---

## ğŸ”Œ APIæ¥å£

### 1. è·å–ä¸ªäººä¿¡æ¯
```http
GET /api/v1/profile
Authorization: Bearer <token>
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "username": "user123",
    "email": "user@example.com",
    "full_name": "å¼ ä¸‰",
    "phone": "13800138000",
    "avatar_url": "https://...",
    "membership_tier": "pro",
    "membership_type": "personal",
    "created_at": "2025-01-01T00:00:00Z"
  }
}
```

### 2. æ›´æ–°ä¸ªäººä¿¡æ¯
```http
PUT /api/v1/profile
Authorization: Bearer <token>
Content-Type: application/json

{
  "full_name": "å¼ ä¸‰",
  "phone": "13800138000",
  "bio": "ç„Šæ¥å·¥ç¨‹å¸ˆ"
}
```

### 3. ä¸Šä¼ å¤´åƒ
```http
POST /api/v1/profile/avatar
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <å›¾ç‰‡æ–‡ä»¶>
```

### 4. ä¿®æ”¹å¯†ç 
```http
POST /api/v1/profile/change-password
Authorization: Bearer <token>
Content-Type: application/json

{
  "current_password": "old_password",
  "new_password": "new_password",
  "confirm_password": "new_password"
}
```

### 5. è·å–ä½¿ç”¨ç»Ÿè®¡
```http
GET /api/v1/profile/statistics
Authorization: Bearer <token>
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "wps_count": 25,
    "pqr_count": 20,
    "ppqr_count": 10,
    "storage_used_mb": 350,
    "last_login": "2025-10-16T10:00:00Z",
    "total_logins": 150,
    "account_age_days": 289
  }
}
```

### 6. è·å–é…é¢ä½¿ç”¨
```http
GET /api/v1/profile/quotas
Authorization: Bearer <token>
```

### 7. è·å–ç™»å½•å†å²
```http
GET /api/v1/profile/login-history?page=1&page_size=20
Authorization: Bearer <token>
```

### 8. è·å–é€šçŸ¥åˆ—è¡¨
```http
GET /api/v1/profile/notifications?page=1&page_size=20&is_read=false
Authorization: Bearer <token>
```

### 9. æ ‡è®°é€šçŸ¥å·²è¯»
```http
POST /api/v1/profile/notifications/{id}/mark-read
Authorization: Bearer <token>
```

### 10. è·å–åå¥½è®¾ç½®
```http
GET /api/v1/profile/preferences
Authorization: Bearer <token>
```

### 11. æ›´æ–°åå¥½è®¾ç½®
```http
PUT /api/v1/profile/preferences
Authorization: Bearer <token>
Content-Type: application/json

{
  "theme": "dark",
  "language": "zh-CN",
  "email_notifications": {
    "quota_warning": true,
    "certificate_expiry": true
  }
}
```

### 12. æ³¨é”€è´¦å·
```http
POST /api/v1/profile/deactivate
Authorization: Bearer <token>
Content-Type: application/json

{
  "password": "user_password",
  "reason": "ä¸å†ä½¿ç”¨"
}
```

---

## ğŸ’¼ ä¸šåŠ¡é€»è¾‘

### 1. æ›´æ–°ä¸ªäººä¿¡æ¯
```python
class ProfileService:
    async def update_profile(
        self,
        user_id: UUID,
        profile_data: ProfileUpdate,
        db: Session
    ) -> User:
        """æ›´æ–°ä¸ªäººä¿¡æ¯"""
        
        user = db.query(User).filter(User.id == user_id).first()
        
        if not user:
            raise HTTPException(404, "ç”¨æˆ·ä¸å­˜åœ¨")
        
        # æ›´æ–°å­—æ®µ
        if profile_data.full_name:
            user.full_name = profile_data.full_name
        if profile_data.phone:
            user.phone = profile_data.phone
        if profile_data.bio:
            user.bio = profile_data.bio
        
        user.updated_at = datetime.now()
        db.commit()
        db.refresh(user)
        
        return user
```

### 2. ä¿®æ”¹å¯†ç 
```python
async def change_password(
    self,
    user_id: UUID,
    password_data: PasswordChange,
    db: Session
) -> bool:
    """ä¿®æ”¹å¯†ç """
    
    user = db.query(User).filter(User.id == user_id).first()
    
    # éªŒè¯å½“å‰å¯†ç 
    if not verify_password(password_data.current_password, user.hashed_password):
        raise HTTPException(400, "å½“å‰å¯†ç é”™è¯¯")
    
    # éªŒè¯æ–°å¯†ç 
    if password_data.new_password != password_data.confirm_password:
        raise HTTPException(400, "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´")
    
    # æ›´æ–°å¯†ç 
    user.hashed_password = hash_password(password_data.new_password)
    user.updated_at = datetime.now()
    
    db.commit()
    
    # å‘é€å¯†ç ä¿®æ”¹é€šçŸ¥
    await self._send_password_change_notification(user)
    
    return True
```

### 3. åˆ›å»ºé€šçŸ¥
```python
async def create_notification(
    self,
    user_id: UUID,
    notification_data: NotificationCreate,
    db: Session
) -> Notification:
    """åˆ›å»ºé€šçŸ¥"""
    
    notification = Notification(
        user_id=user_id,
        notification_type=notification_data.notification_type,
        title=notification_data.title,
        content=notification_data.content,
        priority=notification_data.priority,
        related_type=notification_data.related_type,
        related_id=notification_data.related_id,
        action_url=notification_data.action_url,
        action_text=notification_data.action_text
    )
    
    db.add(notification)
    db.commit()
    
    # å¦‚æœç”¨æˆ·å¯ç”¨äº†é‚®ä»¶é€šçŸ¥ï¼Œå‘é€é‚®ä»¶
    user = db.query(User).filter(User.id == user_id).first()
    preferences = db.query(UserPreferences).filter(
        UserPreferences.user_id == user_id
    ).first()
    
    if preferences and preferences.email_notifications.get(notification_data.notification_type):
        await self._send_email_notification(user, notification)
    
    return notification
```

---

## ğŸ” æƒé™æ§åˆ¶

```python
@router.get("/profile")
async def get_profile(
    current_user: User = Depends(get_current_active_user)
):
    """è·å–ä¸ªäººä¿¡æ¯ï¼ˆæ‰€æœ‰ç”¨æˆ·ï¼‰"""
    return current_user

@router.put("/profile")
async def update_profile(
    profile_data: ProfileUpdate,
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """æ›´æ–°ä¸ªäººä¿¡æ¯"""
    service = ProfileService(db)
    return await service.update_profile(current_user.id, profile_data, db)
```

---

## ğŸ¨ å‰ç«¯ç•Œé¢

### ä¸ªäººä¸­å¿ƒé¡µé¢
```typescript
// src/pages/Profile/index.tsx

const ProfileCenter: React.FC = () => {
  const { user, loading } = useCurrentUser();
  const [activeTab, setActiveTab] = useState('info');
  
  return (
    <div className="profile-center">
      <Card>
        <Avatar size={100} src={user.avatar_url} />
        <h2>{user.full_name}</h2>
        <Tag color="blue">{getMembershipTierName(user.membership_tier)}</Tag>
      </Card>
      
      <Tabs activeKey={activeTab} onChange={setActiveTab}>
        <TabPane tab="ä¸ªäººä¿¡æ¯" key="info">
          <ProfileInfo user={user} />
        </TabPane>
        
        <TabPane tab="è´¦å·å®‰å…¨" key="security">
          <SecuritySettings user={user} />
        </TabPane>
        
        <TabPane tab="ä¼šå‘˜è®¢é˜…" key="subscription">
          <SubscriptionManagement user={user} />
        </TabPane>
        
        <TabPane tab="ä½¿ç”¨ç»Ÿè®¡" key="statistics">
          <UsageStatistics user={user} />
        </TabPane>
        
        <TabPane tab="é€šçŸ¥è®¾ç½®" key="notifications">
          <NotificationSettings user={user} />
        </TabPane>
        
        <TabPane tab="åå¥½è®¾ç½®" key="preferences">
          <PreferencesSettings user={user} />
        </TabPane>
      </Tabs>
    </div>
  );
};
```

### ä¼šå‘˜è®¢é˜…ç®¡ç†
```typescript
// src/pages/Profile/SubscriptionManagement.tsx

const SubscriptionManagement: React.FC = () => {
  const { subscription, quotas } = useSubscription();
  
  return (
    <div>
      <Card title="å½“å‰å¥—é¤">
        <Descriptions>
          <Descriptions.Item label="ä¼šå‘˜ç­‰çº§">
            {getMembershipTierName(subscription.tier)}
          </Descriptions.Item>
          <Descriptions.Item label="ä»·æ ¼">
            Â¥{subscription.price}/æœˆ
          </Descriptions.Item>
          <Descriptions.Item label="åˆ°æœŸæ—¶é—´">
            {subscription.expires_at}
          </Descriptions.Item>
        </Descriptions>
        
        <Button type="primary" onClick={handleUpgrade}>
          å‡çº§ä¼šå‘˜
        </Button>
        <Button onClick={handleRenew}>
          ç»­è´¹
        </Button>
      </Card>
      
      <Card title="é…é¢ä½¿ç”¨">
        <QuotaProgress quotas={quotas} />
      </Card>
    </div>
  );
};
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-16  
**å¼€å‘çŠ¶æ€**: å¾…å¼€å‘

