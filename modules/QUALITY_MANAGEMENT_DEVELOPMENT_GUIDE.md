# è´¨é‡ç®¡ç†æ¨¡å— - å¼€å‘æŒ‡å—

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### åŠŸèƒ½å®šä½
è´¨é‡ç®¡ç†æ¨¡å—ç”¨äºç®¡ç†ç„Šæ¥è´¨é‡æ£€éªŒã€ä¸åˆæ ¼å“å¤„ç†ã€è´¨é‡ç»Ÿè®¡åˆ†æï¼Œç¡®ä¿ç„Šæ¥è´¨é‡ç¬¦åˆæ ‡å‡†è¦æ±‚ã€‚

### é€‚ç”¨åœºæ™¯
- è´¨é‡æ£€éªŒè®¡åˆ’å’Œæ‰§è¡Œ
- æ£€éªŒç»“æœè®°å½•
- ä¸åˆæ ¼å“ç®¡ç†
- è´¨é‡é—®é¢˜è¿½æº¯
- è´¨é‡ç»Ÿè®¡åˆ†æ
- è´¨é‡æ”¹è¿›æªæ–½

### å¼€å‘ä¼˜å…ˆçº§
**ç¬¬äºŒé˜¶æ®µ** - é‡è¦åŠŸèƒ½ï¼Œä¼˜å…ˆå¼€å‘

---

## ğŸ¯ ä¼šå‘˜æƒé™

### è®¿é—®æƒé™
| ä¼šå‘˜ç­‰çº§ | è®¿é—®æƒé™ | æ•°é‡é™åˆ¶ | åŠŸèƒ½èŒƒå›´ |
|---------|---------|---------|---------|
| æ¸¸å®¢æ¨¡å¼ | âŒ ä¸å¯è®¿é—® | 0 | - |
| ä¸ªäººå…è´¹ç‰ˆ | âŒ ä¸å¯è®¿é—® | 0 | - |
| ä¸ªäººä¸“ä¸šç‰ˆ | âŒ ä¸å¯è®¿é—® | 0 | - |
| ä¸ªäººé«˜çº§ç‰ˆ | âœ… å¯è®¿é—® | æ— é™åˆ¶ | å®Œæ•´åŠŸèƒ½ |
| ä¸ªäººæ——èˆ°ç‰ˆ | âœ… å¯è®¿é—® | æ— é™åˆ¶ | å®Œæ•´åŠŸèƒ½ + é«˜çº§ç‰¹æ€§ |
| ä¼ä¸šç‰ˆ | âœ… å¯è®¿é—® | æ— é™åˆ¶ | å®Œæ•´åŠŸèƒ½ + ä¼ä¸šåä½œ |
| ä¼ä¸šPRO | âœ… å¯è®¿é—® | æ— é™åˆ¶ | å®Œæ•´åŠŸèƒ½ + ä¼ä¸šåä½œ |
| ä¼ä¸šPRO MAX | âœ… å¯è®¿é—® | æ— é™åˆ¶ | å®Œæ•´åŠŸèƒ½ + ä¼ä¸šåä½œ |

**é‡è¦è¯´æ˜**: è´¨é‡ç®¡ç†åŠŸèƒ½ä»…å¯¹**ä¸ªäººé«˜çº§ç‰ˆåŠä»¥ä¸Š**ä¼šå‘˜å¼€æ”¾ã€‚

---

## ğŸ“Š åŠŸèƒ½æ¸…å•

### 1. è´¨é‡æ£€éªŒç®¡ç†
- **åˆ›å»ºæ£€éªŒ**: åˆ›å»ºè´¨é‡æ£€éªŒè®¡åˆ’
- **æ‰§è¡Œæ£€éªŒ**: è®°å½•æ£€éªŒç»“æœ
- **æ£€éªŒæŠ¥å‘Š**: ç”Ÿæˆæ£€éªŒæŠ¥å‘Š
- **æ£€éªŒå†å²**: æŸ¥çœ‹æ£€éªŒå†å²
- **æ£€éªŒç»Ÿè®¡**: ç»Ÿè®¡æ£€éªŒæ•°æ®

### 2. æ£€éªŒç±»å‹
- **å¤–è§‚æ£€éªŒ**: ç„Šç¼å¤–è§‚è´¨é‡æ£€éªŒ
- **å°ºå¯¸æ£€éªŒ**: ç„Šç¼å°ºå¯¸æµ‹é‡
- **æ— æŸæ£€æµ‹**: RTã€UTã€MTã€PT ç­‰
- **åŠ›å­¦æ€§èƒ½**: æ‹‰ä¼¸ã€å¼¯æ›²ã€å†²å‡»ç­‰
- **å…¶ä»–æ£€éªŒ**: è‡ªå®šä¹‰æ£€éªŒé¡¹ç›®

### 3. ä¸åˆæ ¼å“ç®¡ç†
- **ä¸åˆæ ¼ç™»è®°**: è®°å½•ä¸åˆæ ¼å“
- **åŸå› åˆ†æ**: åˆ†æä¸åˆæ ¼åŸå› 
- **å¤„ç†æªæ–½**: è®°å½•å¤„ç†æªæ–½
- **è¿”å·¥è®°å½•**: è®°å½•è¿”å·¥æƒ…å†µ
- **æŠ¥åºŸè®°å½•**: è®°å½•æŠ¥åºŸæƒ…å†µ

### 4. è´¨é‡è¿½æº¯
- **å…³è”ç”Ÿäº§ä»»åŠ¡**: è¿½æº¯åˆ°ç”Ÿäº§ä»»åŠ¡
- **å…³è”ç„Šå·¥**: è¿½æº¯åˆ°ç„Šå·¥
- **å…³è” WPS**: è¿½æº¯åˆ°ä½¿ç”¨çš„ WPS
- **å…³è”ç„Šæ**: è¿½æº¯åˆ°ä½¿ç”¨çš„ç„Šæ
- **å…³è”è®¾å¤‡**: è¿½æº¯åˆ°ä½¿ç”¨çš„è®¾å¤‡

### 5. è´¨é‡ç»Ÿè®¡
- **åˆæ ¼ç‡ç»Ÿè®¡**: ç»Ÿè®¡åˆæ ¼ç‡
- **ç¼ºé™·ç»Ÿè®¡**: ç»Ÿè®¡ç¼ºé™·ç±»å‹å’Œæ•°é‡
- **è¶‹åŠ¿åˆ†æ**: åˆ†æè´¨é‡è¶‹åŠ¿
- **å¯¹æ¯”åˆ†æ**: å¯¹æ¯”ä¸åŒæ—¶æœŸè´¨é‡

### 6. è´¨é‡æ”¹è¿›
- **æ”¹è¿›æªæ–½**: è®°å½•æ”¹è¿›æªæ–½
- **æ•ˆæœè·Ÿè¸ª**: è·Ÿè¸ªæ”¹è¿›æ•ˆæœ
- **ç»éªŒæ€»ç»“**: æ€»ç»“è´¨é‡ç»éªŒ
- **çŸ¥è¯†åº“**: å»ºç«‹è´¨é‡çŸ¥è¯†åº“

---

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹

### è´¨é‡æ£€éªŒè¡¨
```sql
CREATE TABLE quality_inspections (
    -- ä¸»é”®å’ŒåŸºç¡€å­—æ®µ
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    factory_id UUID REFERENCES factories(id) ON DELETE SET NULL,
    
    -- æ£€éªŒåŸºæœ¬ä¿¡æ¯
    inspection_number VARCHAR(100) NOT NULL,       -- æ£€éªŒç¼–å·
    inspection_type VARCHAR(50),                   -- æ£€éªŒç±»å‹: visual, dimensional, ndt, mechanical
    inspection_date DATE NOT NULL,                 -- æ£€éªŒæ—¥æœŸ
    inspection_standard VARCHAR(100),              -- æ£€éªŒæ ‡å‡†
    
    -- å…³è”ä¿¡æ¯
    production_task_id UUID REFERENCES production_tasks(id),
    wps_id UUID REFERENCES wps_records(id),
    welder_id UUID REFERENCES welders(id),
    
    -- æ£€éªŒé¡¹ç›®
    inspection_items JSONB,                        -- æ£€éªŒé¡¹ç›®åˆ—è¡¨
    
    -- æ£€éªŒç»“æœ
    result VARCHAR(50) DEFAULT 'pending',          -- ç»“æœ: pass, fail, conditional_pass, pending
    overall_rating VARCHAR(20),                    -- æ€»ä½“è¯„çº§: excellent, good, acceptable, poor
    
    -- åˆæ ¼åˆ¤å®š
    acceptance_criteria TEXT,                      -- éªŒæ”¶æ ‡å‡†
    is_qualified BOOLEAN,                          -- æ˜¯å¦åˆæ ¼
    
    -- ç¼ºé™·è®°å½•
    defects_found JSONB,                          -- å‘ç°çš„ç¼ºé™·
    defect_count INTEGER DEFAULT 0,                -- ç¼ºé™·æ•°é‡
    defect_severity VARCHAR(20),                   -- ç¼ºé™·ä¸¥é‡ç¨‹åº¦: minor, major, critical
    
    -- æµ‹é‡æ•°æ®
    measurements JSONB,                            -- æµ‹é‡æ•°æ®
    
    -- æ— æŸæ£€æµ‹ç»“æœ
    ndt_results JSONB,                            -- æ— æŸæ£€æµ‹ç»“æœ
    rt_result VARCHAR(50),                        -- å°„çº¿æ£€æµ‹ç»“æœ
    ut_result VARCHAR(50),                        -- è¶…å£°æ£€æµ‹ç»“æœ
    mt_result VARCHAR(50),                        -- ç£ç²‰æ£€æµ‹ç»“æœ
    pt_result VARCHAR(50),                        -- æ¸—é€æ£€æµ‹ç»“æœ
    
    -- æ£€éªŒäººå‘˜
    inspector_id UUID REFERENCES users(id),        -- æ£€éªŒå‘˜
    inspector_name VARCHAR(100),                   -- æ£€éªŒå‘˜å§“å
    witness_id UUID REFERENCES users(id),          -- è§è¯äºº
    
    -- å¤„ç†ä¿¡æ¯
    disposition VARCHAR(50),                       -- å¤„ç½®: accept, rework, repair, scrap
    corrective_action TEXT,                        -- çº æ­£æªæ–½
    rework_required BOOLEAN DEFAULT FALSE,         -- æ˜¯å¦éœ€è¦è¿”å·¥
    
    -- é™„ä»¶
    inspection_photos JSONB,                       -- æ£€éªŒç…§ç‰‡
    inspection_reports JSONB,                      -- æ£€éªŒæŠ¥å‘Š
    ndt_films JSONB,                              -- å°„çº¿åº•ç‰‡
    
    -- å¤‡æ³¨
    notes TEXT,
    tags JSONB,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    deleted_at TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_user (user_id),
    INDEX idx_company (company_id),
    INDEX idx_factory (factory_id),
    INDEX idx_inspection_number (inspection_number),
    INDEX idx_inspection_type (inspection_type),
    INDEX idx_inspection_date (inspection_date),
    INDEX idx_result (result),
    INDEX idx_production_task (production_task_id),
    INDEX idx_welder (welder_id),
    INDEX idx_inspector (inspector_id),
    INDEX idx_deleted (deleted_at),
    
    UNIQUE (user_id, inspection_number)
);
```

### ä¸åˆæ ¼å“è®°å½•è¡¨
```sql
CREATE TABLE nonconformance_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    inspection_id UUID REFERENCES quality_inspections(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- ä¸åˆæ ¼ä¿¡æ¯
    ncr_number VARCHAR(100) NOT NULL,              -- ä¸åˆæ ¼å“ç¼–å·
    ncr_date DATE NOT NULL,                        -- è®°å½•æ—¥æœŸ
    severity VARCHAR(20),                          -- ä¸¥é‡ç¨‹åº¦: minor, major, critical
    
    -- ä¸åˆæ ¼æè¿°
    defect_description TEXT,                       -- ç¼ºé™·æè¿°
    defect_type VARCHAR(100),                      -- ç¼ºé™·ç±»å‹
    defect_location TEXT,                          -- ç¼ºé™·ä½ç½®
    quantity_affected INTEGER,                     -- å½±å“æ•°é‡
    
    -- åŸå› åˆ†æ
    root_cause TEXT,                               -- æ ¹æœ¬åŸå› 
    contributing_factors TEXT,                     -- å½±å“å› ç´ 
    
    -- è´£ä»»æ–¹
    responsible_party VARCHAR(100),                -- è´£ä»»æ–¹
    responsible_person_id UUID REFERENCES users(id),
    
    -- å¤„ç†æªæ–½
    disposition VARCHAR(50),                       -- å¤„ç½®æ–¹å¼: rework, repair, use_as_is, scrap
    corrective_action TEXT,                        -- çº æ­£æªæ–½
    preventive_action TEXT,                        -- é¢„é˜²æªæ–½
    
    -- è¿”å·¥ä¿¡æ¯
    rework_date DATE,                              -- è¿”å·¥æ—¥æœŸ
    rework_by UUID REFERENCES users(id),           -- è¿”å·¥äºº
    rework_result VARCHAR(50),                     -- è¿”å·¥ç»“æœ
    
    -- éªŒè¯
    verification_date DATE,                        -- éªŒè¯æ—¥æœŸ
    verified_by UUID REFERENCES users(id),         -- éªŒè¯äºº
    is_closed BOOLEAN DEFAULT FALSE,               -- æ˜¯å¦å…³é—­
    
    -- æˆæœ¬
    cost_impact DECIMAL(12,2),                    -- æˆæœ¬å½±å“
    
    -- é™„ä»¶
    photos JSONB,
    documents JSONB,
    
    -- å¤‡æ³¨
    notes TEXT,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    
    -- ç´¢å¼•
    INDEX idx_inspection (inspection_id),
    INDEX idx_user (user_id),
    INDEX idx_ncr_number (ncr_number),
    INDEX idx_ncr_date (ncr_date),
    INDEX idx_severity (severity),
    INDEX idx_disposition (disposition),
    INDEX idx_is_closed (is_closed)
);
```

---

## ğŸ”Œ APIæ¥å£

### 1. æ£€éªŒåˆ—è¡¨
```http
GET /api/v1/quality/inspections?page=1&page_size=20&result=pass
Authorization: Bearer <token>
```

### 2. åˆ›å»ºæ£€éªŒ
```http
POST /api/v1/quality/inspections
Authorization: Bearer <token>
Content-Type: application/json

{
  "inspection_number": "QI-2025-001",
  "inspection_type": "visual",
  "inspection_date": "2025-10-16",
  "production_task_id": "uuid",
  "inspector_id": "uuid",
  "inspection_items": [
    {
      "item": "ç„Šç¼å¤–è§‚",
      "requirement": "æ— è£‚çº¹ã€æ°”å­”",
      "result": "åˆæ ¼"
    }
  ]
}
```

### 3. è®°å½•æ£€éªŒç»“æœ
```http
PUT /api/v1/quality/inspections/{id}/result
Authorization: Bearer <token>
Content-Type: application/json

{
  "result": "pass",
  "is_qualified": true,
  "defects_found": [],
  "notes": "æ£€éªŒåˆæ ¼"
}
```

### 4. åˆ›å»ºä¸åˆæ ¼å“è®°å½•
```http
POST /api/v1/quality/nonconformance
Authorization: Bearer <token>
Content-Type: application/json

{
  "inspection_id": "uuid",
  "ncr_number": "NCR-2025-001",
  "ncr_date": "2025-10-16",
  "severity": "major",
  "defect_description": "ç„Šç¼å­˜åœ¨æ°”å­”",
  "disposition": "rework",
  "corrective_action": "é‡æ–°ç„Šæ¥"
}
```

### 5. è´¨é‡ç»Ÿè®¡
```http
GET /api/v1/quality/statistics?start_date=2025-09-01&end_date=2025-10-16
Authorization: Bearer <token>
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "total_inspections": 100,
    "passed": 95,
    "failed": 5,
    "pass_rate": 95.0,
    "defect_types": {
      "æ°”å­”": 3,
      "è£‚çº¹": 1,
      "æœªç„Šé€": 1
    },
    "trend": [
      {"date": "2025-09-01", "pass_rate": 94.5},
      {"date": "2025-09-08", "pass_rate": 95.2}
    ]
  }
}
```

---

## ğŸ’¼ ä¸šåŠ¡é€»è¾‘

### 1. æ£€éªŒç»“æœåˆ¤å®š
```python
class QualityService:
    def record_inspection_result(
        self,
        inspection_id: UUID,
        result_data: InspectionResult,
        user_id: UUID,
        db: Session
    ) -> QualityInspection:
        """è®°å½•æ£€éªŒç»“æœ"""
        
        inspection = db.query(QualityInspection).filter(
            QualityInspection.id == inspection_id,
            QualityInspection.user_id == user_id
        ).first()
        
        if not inspection:
            raise HTTPException(404, "æ£€éªŒè®°å½•ä¸å­˜åœ¨")
        
        # æ›´æ–°æ£€éªŒç»“æœ
        inspection.result = result_data.result
        inspection.is_qualified = result_data.is_qualified
        inspection.defects_found = result_data.defects_found
        inspection.defect_count = len(result_data.defects_found) if result_data.defects_found else 0
        
        # å¦‚æœä¸åˆæ ¼ï¼Œè‡ªåŠ¨åˆ›å»ºä¸åˆæ ¼å“è®°å½•
        if not result_data.is_qualified:
            self._create_nonconformance_record(inspection, db)
        
        inspection.updated_at = datetime.now()
        db.commit()
        
        return inspection
```

### 2. è´¨é‡ç»Ÿè®¡
```python
def get_quality_statistics(
    self,
    user_id: UUID,
    start_date: date,
    end_date: date,
    db: Session
) -> Dict[str, Any]:
    """è·å–è´¨é‡ç»Ÿè®¡æ•°æ®"""
    
    inspections = db.query(QualityInspection).filter(
        QualityInspection.user_id == user_id,
        QualityInspection.inspection_date >= start_date,
        QualityInspection.inspection_date <= end_date,
        QualityInspection.deleted_at.is_(None)
    ).all()
    
    total = len(inspections)
    passed = len([i for i in inspections if i.result == "pass"])
    failed = len([i for i in inspections if i.result == "fail"])
    
    # ç»Ÿè®¡ç¼ºé™·ç±»å‹
    defect_types = {}
    for inspection in inspections:
        if inspection.defects_found:
            for defect in inspection.defects_found:
                defect_type = defect.get("type", "æœªçŸ¥")
                defect_types[defect_type] = defect_types.get(defect_type, 0) + 1
    
    return {
        "total_inspections": total,
        "passed": passed,
        "failed": failed,
        "pass_rate": round(passed / total * 100, 2) if total > 0 else 0,
        "defect_types": defect_types
    }
```

---

## ğŸ” æƒé™æ§åˆ¶

```python
@router.get("/quality/inspections")
@require_feature("quality_management")  # éœ€è¦é«˜çº§ç‰ˆåŠä»¥ä¸Š
async def get_inspection_list(
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """è·å–è´¨é‡æ£€éªŒåˆ—è¡¨"""
    service = QualityService(db)
    return service.get_inspection_list(current_user.id, db)
```

---

## ğŸ¨ å‰ç«¯ç•Œé¢

### è´¨é‡æ£€éªŒåˆ—è¡¨
```typescript
// src/pages/Quality/InspectionList.tsx

const InspectionList: React.FC = () => {
  const { data, loading } = useInspections();
  
  const columns = [
    { title: 'æ£€éªŒç¼–å·', dataIndex: 'inspection_number' },
    { title: 'æ£€éªŒç±»å‹', dataIndex: 'inspection_type' },
    { title: 'æ£€éªŒæ—¥æœŸ', dataIndex: 'inspection_date' },
    { title: 'ç»“æœ', dataIndex: 'result', render: renderResult },
    { title: 'ç¼ºé™·æ•°', dataIndex: 'defect_count' },
    { title: 'æ“ä½œ', render: renderActions }
  ];
  
  return (
    <div>
      <Statistic title="åˆæ ¼ç‡" value={passRate} suffix="%" />
      <Table columns={columns} dataSource={data} loading={loading} />
    </div>
  );
};
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-16  
**å¼€å‘çŠ¶æ€**: å·²å®ç°ï¼ˆéœ€æµ‹è¯•ï¼‰

