# æŠ¥è¡¨ç»Ÿè®¡æ¨¡å— - å¼€å‘æŒ‡å—

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### åŠŸèƒ½å®šä½
æŠ¥è¡¨ç»Ÿè®¡æ¨¡å—ç”¨äºç”Ÿæˆå„ç±»æ•°æ®æŠ¥è¡¨å’Œç»Ÿè®¡åˆ†æï¼Œä¸ºç®¡ç†å†³ç­–æä¾›æ•°æ®æ”¯æŒã€‚

### é€‚ç”¨åœºæ™¯
- ç”Ÿæˆå„ç±»ä¸šåŠ¡æŠ¥è¡¨
- æ•°æ®ç»Ÿè®¡åˆ†æ
- è¶‹åŠ¿åˆ†æå’Œé¢„æµ‹
- æ•°æ®å¯è§†åŒ–å±•ç¤º
- æŠ¥è¡¨å¯¼å‡ºå’Œæ‰“å°

### å¼€å‘ä¼˜å…ˆçº§
**ç¬¬ä¸‰é˜¶æ®µ** - å¢å¼ºåŠŸèƒ½ï¼Œåç»­å¼€å‘

---

## ğŸ¯ ä¼šå‘˜æƒé™

### è®¿é—®æƒé™
| ä¼šå‘˜ç­‰çº§ | è®¿é—®æƒé™ | åŠŸèƒ½èŒƒå›´ |
|---------|---------|---------|
| æ¸¸å®¢æ¨¡å¼ | âŒ ä¸å¯è®¿é—® | - |
| ä¸ªäººå…è´¹ç‰ˆ | âŒ ä¸å¯è®¿é—® | - |
| ä¸ªäººä¸“ä¸šç‰ˆ | âŒ ä¸å¯è®¿é—® | - |
| ä¸ªäººé«˜çº§ç‰ˆ | âœ… å¯è®¿é—® | åŸºç¡€æŠ¥è¡¨ |
| ä¸ªäººæ——èˆ°ç‰ˆ | âœ… å¯è®¿é—® | å®Œæ•´æŠ¥è¡¨ + è‡ªå®šä¹‰æŠ¥è¡¨ |
| ä¼ä¸šç‰ˆ | âœ… å¯è®¿é—® | å®Œæ•´æŠ¥è¡¨ + ä¼ä¸šæŠ¥è¡¨ |
| ä¼ä¸šPRO | âœ… å¯è®¿é—® | å®Œæ•´æŠ¥è¡¨ + ä¼ä¸šæŠ¥è¡¨ |
| ä¼ä¸šPRO MAX | âœ… å¯è®¿é—® | å®Œæ•´æŠ¥è¡¨ + ä¼ä¸šæŠ¥è¡¨ |

**é‡è¦è¯´æ˜**: æŠ¥è¡¨ç»Ÿè®¡åŠŸèƒ½ä»…å¯¹**ä¸ªäººé«˜çº§ç‰ˆåŠä»¥ä¸Š**ä¼šå‘˜å¼€æ”¾ã€‚

---

## ğŸ“Š åŠŸèƒ½æ¸…å•

### 1. åŸºç¡€æŠ¥è¡¨ï¼ˆé«˜çº§ç‰ˆåŠä»¥ä¸Šï¼‰
- **WPS ç»Ÿè®¡æŠ¥è¡¨**: WPS æ•°é‡ã€çŠ¶æ€ç»Ÿè®¡
- **PQR ç»Ÿè®¡æŠ¥è¡¨**: PQR æ•°é‡ã€åˆæ ¼ç‡ç»Ÿè®¡
- **ç„Šå·¥ç»Ÿè®¡æŠ¥è¡¨**: ç„Šå·¥æ•°é‡ã€è¯ä¹¦ç»Ÿè®¡
- **ç„Šæç»Ÿè®¡æŠ¥è¡¨**: åº“å­˜ã€æ¶ˆè€—ç»Ÿè®¡
- **è®¾å¤‡ç»Ÿè®¡æŠ¥è¡¨**: è®¾å¤‡æ•°é‡ã€ä½¿ç”¨ç‡ç»Ÿè®¡

### 2. ç”Ÿäº§æŠ¥è¡¨ï¼ˆé«˜çº§ç‰ˆåŠä»¥ä¸Šï¼‰
- **ç”Ÿäº§ä»»åŠ¡æŠ¥è¡¨**: ä»»åŠ¡å®Œæˆæƒ…å†µ
- **ç”Ÿäº§è¿›åº¦æŠ¥è¡¨**: è¿›åº¦ç»Ÿè®¡åˆ†æ
- **å·¥æ—¶ç»Ÿè®¡æŠ¥è¡¨**: å·¥æ—¶æ¶ˆè€—ç»Ÿè®¡
- **æ•ˆç‡åˆ†ææŠ¥è¡¨**: ç”Ÿäº§æ•ˆç‡åˆ†æ

### 3. è´¨é‡æŠ¥è¡¨ï¼ˆé«˜çº§ç‰ˆåŠä»¥ä¸Šï¼‰
- **è´¨é‡æ£€éªŒæŠ¥è¡¨**: æ£€éªŒæ•°é‡ã€åˆæ ¼ç‡
- **ç¼ºé™·ç»Ÿè®¡æŠ¥è¡¨**: ç¼ºé™·ç±»å‹ã€æ•°é‡ç»Ÿè®¡
- **ä¸åˆæ ¼å“æŠ¥è¡¨**: ä¸åˆæ ¼å“å¤„ç†æƒ…å†µ
- **è´¨é‡è¶‹åŠ¿æŠ¥è¡¨**: è´¨é‡è¶‹åŠ¿åˆ†æ

### 4. æˆæœ¬æŠ¥è¡¨ï¼ˆæ——èˆ°ç‰ˆåŠä»¥ä¸Šï¼‰
- **ç„Šææˆæœ¬æŠ¥è¡¨**: ç„Šæé‡‡è´­ã€æ¶ˆè€—æˆæœ¬
- **äººå·¥æˆæœ¬æŠ¥è¡¨**: äººå·¥æˆæœ¬ç»Ÿè®¡
- **è®¾å¤‡æˆæœ¬æŠ¥è¡¨**: è®¾å¤‡ç»´æŠ¤æˆæœ¬
- **é¡¹ç›®æˆæœ¬æŠ¥è¡¨**: é¡¹ç›®æ€»æˆæœ¬åˆ†æ

### 5. è‡ªå®šä¹‰æŠ¥è¡¨ï¼ˆæ——èˆ°ç‰ˆåŠä»¥ä¸Šï¼‰
- **æŠ¥è¡¨æ¨¡æ¿**: åˆ›å»ºè‡ªå®šä¹‰æŠ¥è¡¨æ¨¡æ¿
- **æ•°æ®ç­›é€‰**: è‡ªå®šä¹‰æ•°æ®ç­›é€‰æ¡ä»¶
- **å›¾è¡¨ç±»å‹**: é€‰æ‹©ä¸åŒå›¾è¡¨ç±»å‹
- **æŠ¥è¡¨ä¿å­˜**: ä¿å­˜å¸¸ç”¨æŠ¥è¡¨é…ç½®

### 6. ä¼ä¸šæŠ¥è¡¨ï¼ˆä¼ä¸šç‰ˆï¼‰
- **è·¨å·¥å‚æŠ¥è¡¨**: å¤šå·¥å‚æ•°æ®å¯¹æ¯”
- **éƒ¨é—¨æŠ¥è¡¨**: å„éƒ¨é—¨æ•°æ®ç»Ÿè®¡
- **å‘˜å·¥æŠ¥è¡¨**: å‘˜å·¥å·¥ä½œé‡ç»Ÿè®¡
- **ç»¼åˆåˆ†ææŠ¥è¡¨**: ä¼ä¸šç»¼åˆæ•°æ®åˆ†æ

### 7. æŠ¥è¡¨å¯¼å‡º
- **å¯¼å‡º PDF**: å¯¼å‡ºä¸º PDF æ ¼å¼
- **å¯¼å‡º Excel**: å¯¼å‡ºä¸º Excel æ ¼å¼
- **å¯¼å‡ºå›¾ç‰‡**: å¯¼å‡ºå›¾è¡¨ä¸ºå›¾ç‰‡
- **æ‰“å°æŠ¥è¡¨**: ç›´æ¥æ‰“å°æŠ¥è¡¨

---

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹

### æŠ¥è¡¨é…ç½®è¡¨
```sql
CREATE TABLE report_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    
    -- æŠ¥è¡¨ä¿¡æ¯
    template_name VARCHAR(255) NOT NULL,           -- æŠ¥è¡¨åç§°
    template_type VARCHAR(50),                     -- æŠ¥è¡¨ç±»å‹
    description TEXT,                              -- æè¿°
    
    -- æŠ¥è¡¨é…ç½®
    data_source VARCHAR(100),                      -- æ•°æ®æº
    filters JSONB,                                 -- ç­›é€‰æ¡ä»¶
    columns JSONB,                                 -- æ˜¾ç¤ºåˆ—
    chart_type VARCHAR(50),                        -- å›¾è¡¨ç±»å‹
    chart_config JSONB,                            -- å›¾è¡¨é…ç½®
    
    -- æƒé™
    is_public BOOLEAN DEFAULT FALSE,               -- æ˜¯å¦å…¬å¼€ï¼ˆä¼ä¸šå†…ï¼‰
    shared_with JSONB,                            -- å…±äº«ç»™çš„ç”¨æˆ·
    
    -- ç»Ÿè®¡
    usage_count INTEGER DEFAULT 0,                 -- ä½¿ç”¨æ¬¡æ•°
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    deleted_at TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_user (user_id),
    INDEX idx_company (company_id),
    INDEX idx_template_type (template_type),
    INDEX idx_deleted (deleted_at)
);
```

---

## ğŸ”Œ APIæ¥å£

### 1. WPS ç»Ÿè®¡æŠ¥è¡¨
```http
GET /api/v1/reports/wps-statistics?start_date=2025-09-01&end_date=2025-10-16
Authorization: Bearer <token>
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "total": 30,
    "by_status": {
      "draft": 5,
      "review": 3,
      "approved": 22
    },
    "by_standard": {
      "AWS D1.1": 15,
      "ISO 15614": 10,
      "GB 50661": 5
    },
    "trend": [
      {"month": "2025-09", "count": 12},
      {"month": "2025-10", "count": 18}
    ]
  }
}
```

### 2. ç”Ÿäº§ç»Ÿè®¡æŠ¥è¡¨
```http
GET /api/v1/reports/production-statistics?start_date=2025-09-01&end_date=2025-10-16
Authorization: Bearer <token>
```

### 3. è´¨é‡ç»Ÿè®¡æŠ¥è¡¨
```http
GET /api/v1/reports/quality-statistics?start_date=2025-09-01&end_date=2025-10-16
Authorization: Bearer <token>
```

### 4. è‡ªå®šä¹‰æŠ¥è¡¨
```http
POST /api/v1/reports/custom
Authorization: Bearer <token>
Content-Type: application/json

{
  "data_source": "wps_records",
  "filters": {
    "status": "approved",
    "created_at_gte": "2025-09-01"
  },
  "columns": ["wps_number", "title", "status", "created_at"],
  "chart_type": "bar",
  "group_by": "standard"
}
```

### 5. å¯¼å‡ºæŠ¥è¡¨
```http
GET /api/v1/reports/{report_id}/export?format=pdf
Authorization: Bearer <token>
```

### 6. ä¿å­˜æŠ¥è¡¨æ¨¡æ¿
```http
POST /api/v1/reports/templates
Authorization: Bearer <token>
Content-Type: application/json

{
  "template_name": "æœˆåº¦ WPS ç»Ÿè®¡",
  "template_type": "wps_statistics",
  "filters": {
    "date_range": "last_month"
  },
  "chart_type": "line"
}
```

---

## ğŸ’¼ ä¸šåŠ¡é€»è¾‘

### 1. WPS ç»Ÿè®¡
```python
class ReportService:
    def get_wps_statistics(
        self,
        user_id: UUID,
        start_date: date,
        end_date: date,
        db: Session
    ) -> Dict[str, Any]:
        """è·å– WPS ç»Ÿè®¡æ•°æ®"""
        
        # æ€»æ•°ç»Ÿè®¡
        total = db.query(WPSRecord).filter(
            WPSRecord.user_id == user_id,
            WPSRecord.created_at >= start_date,
            WPSRecord.created_at <= end_date,
            WPSRecord.deleted_at.is_(None)
        ).count()
        
        # æŒ‰çŠ¶æ€ç»Ÿè®¡
        by_status = db.query(
            WPSRecord.status,
            func.count(WPSRecord.id)
        ).filter(
            WPSRecord.user_id == user_id,
            WPSRecord.created_at >= start_date,
            WPSRecord.created_at <= end_date,
            WPSRecord.deleted_at.is_(None)
        ).group_by(WPSRecord.status).all()
        
        # æŒ‰æ ‡å‡†ç»Ÿè®¡
        by_standard = db.query(
            WPSRecord.standard,
            func.count(WPSRecord.id)
        ).filter(
            WPSRecord.user_id == user_id,
            WPSRecord.created_at >= start_date,
            WPSRecord.created_at <= end_date,
            WPSRecord.deleted_at.is_(None)
        ).group_by(WPSRecord.standard).all()
        
        # è¶‹åŠ¿åˆ†æ
        trend = self._calculate_trend(user_id, start_date, end_date, db)
        
        return {
            "total": total,
            "by_status": dict(by_status),
            "by_standard": dict(by_standard),
            "trend": trend
        }
```

### 2. è´¨é‡ç»Ÿè®¡
```python
def get_quality_statistics(
    self,
    user_id: UUID,
    start_date: date,
    end_date: date,
    db: Session
) -> Dict[str, Any]:
    """è·å–è´¨é‡ç»Ÿè®¡æ•°æ®"""
    
    inspections = db.query(QualityInspection).filter(
        QualityInspection.user_id == user_id,
        QualityInspection.inspection_date >= start_date,
        QualityInspection.inspection_date <= end_date,
        QualityInspection.deleted_at.is_(None)
    ).all()
    
    total = len(inspections)
    passed = len([i for i in inspections if i.result == "pass"])
    
    # ç¼ºé™·ç»Ÿè®¡
    defect_stats = {}
    for inspection in inspections:
        if inspection.defects_found:
            for defect in inspection.defects_found:
                defect_type = defect.get("type", "æœªçŸ¥")
                defect_stats[defect_type] = defect_stats.get(defect_type, 0) + 1
    
    # è¶‹åŠ¿åˆ†æ
    trend = self._calculate_quality_trend(inspections)
    
    return {
        "total_inspections": total,
        "passed": passed,
        "failed": total - passed,
        "pass_rate": round(passed / total * 100, 2) if total > 0 else 0,
        "defect_statistics": defect_stats,
        "trend": trend
    }
```

### 3. è‡ªå®šä¹‰æŠ¥è¡¨ç”Ÿæˆ
```python
def generate_custom_report(
    self,
    user_id: UUID,
    report_config: CustomReportConfig,
    db: Session
) -> Dict[str, Any]:
    """ç”Ÿæˆè‡ªå®šä¹‰æŠ¥è¡¨"""
    
    # æ ¹æ®é…ç½®æ„å»ºæŸ¥è¯¢
    query = self._build_query(
        report_config.data_source,
        report_config.filters,
        user_id,
        db
    )
    
    # æ‰§è¡ŒæŸ¥è¯¢
    data = query.all()
    
    # æ•°æ®å¤„ç†
    processed_data = self._process_data(
        data,
        report_config.columns,
        report_config.group_by
    )
    
    # ç”Ÿæˆå›¾è¡¨æ•°æ®
    chart_data = self._generate_chart_data(
        processed_data,
        report_config.chart_type,
        report_config.chart_config
    )
    
    return {
        "data": processed_data,
        "chart": chart_data
    }
```

---

## ğŸ” æƒé™æ§åˆ¶

```python
@router.get("/reports/wps-statistics")
@require_feature("advanced_reports")  # éœ€è¦é«˜çº§ç‰ˆåŠä»¥ä¸Š
async def get_wps_statistics(
    start_date: date,
    end_date: date,
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """è·å– WPS ç»Ÿè®¡æŠ¥è¡¨"""
    service = ReportService(db)
    return service.get_wps_statistics(
        current_user.id,
        start_date,
        end_date,
        db
    )

@router.post("/reports/custom")
@require_feature("custom_reports")  # éœ€è¦æ——èˆ°ç‰ˆåŠä»¥ä¸Š
async def generate_custom_report(
    report_config: CustomReportConfig,
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """ç”Ÿæˆè‡ªå®šä¹‰æŠ¥è¡¨"""
    service = ReportService(db)
    return service.generate_custom_report(
        current_user.id,
        report_config,
        db
    )
```

---

## ğŸ¨ å‰ç«¯ç•Œé¢

### æŠ¥è¡¨ä¸­å¿ƒé¡µé¢
```typescript
// src/pages/Reports/ReportCenter.tsx

const ReportCenter: React.FC = () => {
  const [reportType, setReportType] = useState('wps');
  const [dateRange, setDateRange] = useState([]);
  const { data, loading, refetch } = useReport(reportType, dateRange);
  
  return (
    <div className="report-center">
      <Row gutter={16}>
        <Col span={6}>
          <Menu
            selectedKeys={[reportType]}
            onClick={({ key }) => setReportType(key)}
          >
            <Menu.Item key="wps">WPS ç»Ÿè®¡</Menu.Item>
            <Menu.Item key="pqr">PQR ç»Ÿè®¡</Menu.Item>
            <Menu.Item key="production">ç”Ÿäº§ç»Ÿè®¡</Menu.Item>
            <Menu.Item key="quality">è´¨é‡ç»Ÿè®¡</Menu.Item>
            <Menu.Item key="custom">è‡ªå®šä¹‰æŠ¥è¡¨</Menu.Item>
          </Menu>
        </Col>
        
        <Col span={18}>
          <Card>
            <RangePicker onChange={setDateRange} />
            <Button onClick={refetch}>ç”ŸæˆæŠ¥è¡¨</Button>
            <Button onClick={handleExport}>å¯¼å‡º</Button>
          </Card>
          
          <Card title="ç»Ÿè®¡æ•°æ®">
            <Statistic title="æ€»æ•°" value={data.total} />
            <Chart data={data.chart} type={data.chartType} />
          </Card>
          
          <Card title="è¯¦ç»†æ•°æ®">
            <Table dataSource={data.details} />
          </Card>
        </Col>
      </Row>
    </div>
  );
};
```

### è‡ªå®šä¹‰æŠ¥è¡¨æ„å»ºå™¨
```typescript
// src/pages/Reports/CustomReportBuilder.tsx

const CustomReportBuilder: React.FC = () => {
  const [config, setConfig] = useState<ReportConfig>({});
  
  return (
    <div className="custom-report-builder">
      <Steps current={currentStep}>
        <Step title="é€‰æ‹©æ•°æ®æº" />
        <Step title="è®¾ç½®ç­›é€‰æ¡ä»¶" />
        <Step title="é€‰æ‹©æ˜¾ç¤ºåˆ—" />
        <Step title="é€‰æ‹©å›¾è¡¨ç±»å‹" />
        <Step title="é¢„è§ˆå’Œä¿å­˜" />
      </Steps>
      
      {currentStep === 0 && <DataSourceSelector onChange={handleDataSourceChange} />}
      {currentStep === 1 && <FilterBuilder onChange={handleFilterChange} />}
      {currentStep === 2 && <ColumnSelector onChange={handleColumnChange} />}
      {currentStep === 3 && <ChartTypeSelector onChange={handleChartChange} />}
      {currentStep === 4 && <ReportPreview config={config} />}
    </div>
  );
};
```

---

## ğŸ“ é¢„å®šä¹‰æŠ¥è¡¨åˆ—è¡¨

### 1. WPS ç›¸å…³æŠ¥è¡¨
- WPS æ•°é‡ç»Ÿè®¡æŠ¥è¡¨
- WPS çŠ¶æ€åˆ†å¸ƒæŠ¥è¡¨
- WPS æ ‡å‡†åˆ†å¸ƒæŠ¥è¡¨
- WPS åˆ›å»ºè¶‹åŠ¿æŠ¥è¡¨

### 2. PQR ç›¸å…³æŠ¥è¡¨
- PQR æ•°é‡ç»Ÿè®¡æŠ¥è¡¨
- PQR åˆæ ¼ç‡æŠ¥è¡¨
- PQR æµ‹è¯•ç±»å‹åˆ†å¸ƒæŠ¥è¡¨
- PQR è¶‹åŠ¿åˆ†ææŠ¥è¡¨

### 3. ç”Ÿäº§ç›¸å…³æŠ¥è¡¨
- ç”Ÿäº§ä»»åŠ¡ç»Ÿè®¡æŠ¥è¡¨
- ç”Ÿäº§è¿›åº¦æŠ¥è¡¨
- å·¥æ—¶ç»Ÿè®¡æŠ¥è¡¨
- ç”Ÿäº§æ•ˆç‡æŠ¥è¡¨

### 4. è´¨é‡ç›¸å…³æŠ¥è¡¨
- è´¨é‡æ£€éªŒç»Ÿè®¡æŠ¥è¡¨
- åˆæ ¼ç‡è¶‹åŠ¿æŠ¥è¡¨
- ç¼ºé™·ç±»å‹åˆ†å¸ƒæŠ¥è¡¨
- ä¸åˆæ ¼å“å¤„ç†æŠ¥è¡¨

### 5. èµ„æºç›¸å…³æŠ¥è¡¨
- ç„Šå·¥ç»Ÿè®¡æŠ¥è¡¨
- ç„Šæåº“å­˜æŠ¥è¡¨
- è®¾å¤‡ä½¿ç”¨ç‡æŠ¥è¡¨
- èµ„æºåˆ©ç”¨ç‡æŠ¥è¡¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-16  
**å¼€å‘çŠ¶æ€**: å·²å®ç°ï¼ˆéœ€æµ‹è¯•ï¼‰

